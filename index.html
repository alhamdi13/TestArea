<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PayBoss Cafe - Sistem Absensi</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel (untuk JSX di browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Framer Motion UMD -->
    <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>
  </head>

  <body class="bg-stone-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useRef, useEffect, useCallback } = React;

      // Inisialisasi Framer Motion dari UMD (fallback kalau gagal load)
      const fm = window.FramerMotion || null;
      const motion = fm
        ? fm.motion
        : {
            div: (props) => <div {...props} />, 
            form: (props) => <form {...props} />,
          };
      const AnimatePresence = fm ? fm.AnimatePresence : ({ children }) => <>{children}</>;

      // --- SIMPLE ICON WRAPPER ---
      const IconWrapper = ({ children, className = "", size = 24 }) => (
        <span
          className={className}
          style={{ fontSize: size, display: "inline-flex", alignItems: "center", justifyContent: "center" }}
        >
          {children}
        </span>
      );

      const Home = (props) => <IconWrapper {...props}>ğŸ </IconWrapper>;
      const LogIn = (props) => <IconWrapper {...props}>ğŸ”‘</IconWrapper>;
      const LogOut = (props) => <IconWrapper {...props}>ğŸšª</IconWrapper>;
      const User = (props) => <IconWrapper {...props}>ğŸ‘¤</IconWrapper>;
      const BarChart2 = (props) => <IconWrapper {...props}>ğŸ“Š</IconWrapper>;
      const Users = (props) => <IconWrapper {...props}>ğŸ‘¥</IconWrapper>;
      const Calendar = (props) => <IconWrapper {...props}>ğŸ“…</IconWrapper>;
      const FileText = (props) => <IconWrapper {...props}>ğŸ“„</IconWrapper>;
      const CheckCircle = (props) => <IconWrapper {...props}>âœ…</IconWrapper>;
      const XCircle = (props) => <IconWrapper {...props}>âŒ</IconWrapper>;
      const MapPin = (props) => <IconWrapper {...props}>ğŸ“</IconWrapper>;
      const Camera = (props) => <IconWrapper {...props}>ğŸ“·</IconWrapper>;
      const ListChecks = (props) => <IconWrapper {...props}>âœ…</IconWrapper>;
      const ChevronLeft = (props) => <IconWrapper {...props}>â—€ï¸</IconWrapper>;
      const ChevronRight = (props) => <IconWrapper {...props}>â–¶ï¸</IconWrapper>;
      const Plus = (props) => <IconWrapper {...props}>â•</IconWrapper>;
      const Trash2 = (props) => <IconWrapper {...props}>ğŸ—‘ï¸</IconWrapper>;
      const Edit = (props) => <IconWrapper {...props}>âœï¸</IconWrapper>;
      const Clock = (props) => <IconWrapper {...props}>â°</IconWrapper>;
      const AlertTriangle = (props) => <IconWrapper {...props}>âš ï¸</IconWrapper>;
      const Coffee = (props) => <IconWrapper {...props}>â˜•</IconWrapper>;
      const ShieldCheck = (props) => <IconWrapper {...props}>ğŸ›¡ï¸</IconWrapper>;
      const Moon = (props) => <IconWrapper {...props}>ğŸŒ™</IconWrapper>;
      const Sun = (props) => <IconWrapper {...props}>â˜€ï¸</IconWrapper>;
      const Sunset = (props) => <IconWrapper {...props}>ğŸŒ†</IconWrapper>;

      // --- THEME PAYBOSS ---
      const theme = {
        colors: {
          primary: "bg-stone-700",
          primaryHover: "hover:bg-stone-800",
          secondary: "bg-amber-800",
          secondaryHover: "hover:bg-amber-900",
          accent: "bg-green-700",
          accentHover: "hover:bg-green-800",
          background: "bg-stone-100",
          card: "bg-white",
          textPrimary: "text-stone-800",
          textSecondary: "text-stone-600",
          textLight: "text-white",
          border: "border-stone-200",
          danger: "bg-red-600",
          success: "bg-green-600",
        },
        rounding: {
          card: "rounded-2xl",
          button: "rounded-lg",
          input: "rounded-lg",
        },
      };

      // Lokasi PayBoss Cafe (Target GPS)
      const TARGET_LOCATION = {
        latitude: -2.1717657457047723,
        longitude: 115.4029877085838,
      };
      const GPS_RADIUS_METERS = 100;

      // URL Google Apps Script (ganti kalau URL deploy berubah)
      const GOOGLE_SHEET_WEBAPP_URL =
        "https://script.google.com/macros/s/AKfycbxOHwN1-GyfwWrQLucTf-X0Db_9HefScgxd5g2h35-ntTNyGQZ4NePhZ39OfeZqRvdM/exec";

      // --- DATA KARYAWAN (bisa diedit manual di sini, atau nanti dihubungkan ke Sheet lain) ---
      const initialDbKaryawan = [
        {
          id: "PB251101",
          nama: "Dayat",
          posisi: "Koordinator",
          password: "dayat123",
          fotoInisial: "D",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
        {
          id: "PB251102",
          nama: "Ilham Ali Naufal",
          posisi: "Pramusaji",
          password: "ilham123",
          fotoInisial: "IAN",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
        {
          id: "PB251104",
          nama: "Renita Aulia Jasmin",
          posisi: "Bartender",
          password: "renita123",
          fotoInisial: "RAJ",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
        {
          id: "PB251106",
          nama: "Bella",
          posisi: "Barista",
          password: "bella123",
          fotoInisial: "B",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
        {
          id: "PB251107",
          nama: "Rina",
          posisi: "Waitress",
          password: "rina123",
          fotoInisial: "R",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
        {
          id: "PB251108",
          nama: "Andi",
          posisi: "Pramusaji",
          password: "andi123",
          fotoInisial: "A",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
        {
          id: "PB251109",
          nama: "Yoga",
          posisi: "Chef",
          password: "yoga123",
          fotoInisial: "Y",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
      ];

      // Jadwal roster contoh (boleh kamu sesuaikan lagi)
      const initialDbRoster = {
        PB251101: {
          "2025-11-16": "OFF",
          "2025-11-17": 1,
          "2025-11-18": 1,
          "2025-11-19": 1,
          "2025-11-20": 1,
          "2025-11-21": 1,
          "2025-11-22": 1,
        },
        PB251102: {
          "2025-11-16": 2,
          "2025-11-17": "OFF",
          "2025-11-18": 3,
          "2025-11-19": 3,
          "2025-11-20": 3,
          "2025-11-21": 3,
          "2025-11-22": 3,
        },
        PB251104: {
          "2025-11-16": 2,
          "2025-11-17": 2,
          "2025-11-18": "OFF",
          "2025-11-19": 2,
          "2025-11-20": 2,
          "2025-11-21": 2,
          "2025-11-22": 2,
        },
        PB251108: {
          "2025-11-16": 1,
          "2025-11-17": 1,
          "2025-11-18": 1,
          "2025-11-19": "OFF",
          "2025-11-20": 2,
          "2025-11-21": 2,
          "2025-11-22": 2,
        },
        PB251109: {
          "2025-11-16": 1,
          "2025-11-17": 1,
          "2025-11-18": 1,
          "2025-11-19": 1,
          "2025-11-20": "OFF",
          "2025-11-21": 1,
          "2025-11-22": "OFF",
        },
        PB251106: {
          "2025-11-16": 2,
          "2025-11-17": 2,
          "2025-11-18": "OFF",
          "2025-11-19": 2,
          "2025-11-20": 2,
          "2025-11-21": 2,
          "2025-11-22": 2,
        },
        PB251107: {
          "2025-11-16": 2,
          "2025-11-17": "OFF",
          "2025-11-18": 3,
          "2025-11-19": 3,
          "2025-11-20": 3,
          "2025-11-21": 3,
          "2025-11-22": 3,
        },
      };

      // Shift
      const shiftDetails = {
        1: { nama: "Pagi", ikon: Sun, waktu: "08:00 - 16:00", color: "text-blue-500" },
        2: { nama: "Siang", ikon: Sunset, waktu: "16:00 - 23:00", color: "text-orange-500" },
        3: { nama: "Malam", ikon: Moon, waktu: "23:00 - 08:00", color: "text-indigo-500" },
        OFF: { nama: "OFF", ikon: Home, waktu: "Libur", color: "text-gray-500" },
      };

      // Jobdesk per posisi
      const jobDeskByPosition = {
        "Koordinator": [
          "Memimpin briefing pagi tim FOH & BOH",
          "Memastikan ketersediaan stok (Bar & Kitchen)",
          "Menangani keluhan atau masukan tamu (service recovery)",
          "Membuat laporan closing harian",
          "Memastikan semua tim menjalankan SOP dengan baik",
        ],
        "Pramusaji": [
          "Menyambut tamu dan mengantarkan ke meja",
          "Mencatat pesanan dengan jelas di sistem/nota",
          "Menyajikan makanan & minuman ke tamu dengan sopan",
          "Membersihkan meja setelah tamu selesai",
          "Membantu menjaga kebersihan area dining",
        ],
        "Waitress": [
          "Menyambut tamu dengan ramah",
          "Menyajikan makanan & minuman ke tamu",
          "Melakukan pengecekan kepuasan tamu di meja",
          "Membersihkan meja dan area dining",
          "Membantu pramusaji lain jika sedang ramai",
        ],
        "Bartender": [
          "Menyiapkan minuman kopi & non-kopi sesuai resep",
          "Menjaga kebersihan area bar & peralatan",
          "Melakukan kalibrasi mesin espresso di awal shift",
          "Mencatat kebutuhan restock bahan minuman",
          "Menyajikan minuman dengan presentasi yang menarik",
        ],
        "Barista": [
          "Menyiapkan minuman kopi & signature drink",
          "Menjaga stok biji kopi & bahan minuman",
          "Membersihkan mesin kopi setelah digunakan",
          "Mencatat bahan yang perlu restock",
          "Membantu FOH saat kondisi ramai",
        ],
        "Chef": [
          "Persiapan 'mise en place' bahan baku kitchen",
          "Memasak pesanan sesuai SOP dan urutan (FIFO)",
          "Menjaga kualitas rasa dan presentasi hidangan",
          "Memastikan kebersihan area kitchen",
          "Melakukan stok opname harian bahan baku kitchen",
        ],
      };

      // --- UTILITAS WAKTU & JARAK ---
      function getHaversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // meter
        const Ï†1 = (lat1 * Math.PI) / 180;
        const Ï†2 = (lat2 * Math.PI) / 180;
        const Î”Ï† = ((lat2 - lat1) * Math.PI) / 180;
        const Î”Î» = ((lon2 - lon1) * Math.PI) / 180;

        const a =
          Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
          Math.cos(Ï†1) * Math.cos(Ï†2) *
            Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c; // dalam meter
      }

      function formatDateYYYYMMDD(date) {
        return date.toISOString().split("T")[0];
      }

      function formatShortDate(date) {
        return date.toLocaleDateString("id-ID", {
          weekday: "long",
          day: "numeric",
          month: "short",
        });
      }

      function formatTime(date) {
        if (!date) return "-";
        return date.toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      function buildJobdeskForPosition(posisi) {
        const tasks = jobDeskByPosition[posisi] || [];
        return tasks.map((label, idx) => ({
          id: idx + 1,
          label,
          completed: false,
        }));
      }

      // --- FUNGSI KONEKSI GOOGLE SHEET ---

      // Kirim data absensi ke Google Sheet
      async function kirimAbsensiKeSheet({ user, jenis, data, shiftName }) {
        try {
          const now = new Date();
          const todayYMD = formatDateYYYYMMDD(now);

          const payload = {
            action: "appendAbsensi",
            timestamp: now.toISOString(),
            tanggal: todayYMD,
            jenis, // "checkIn" / "checkOut"
            idKaryawan: user.id,
            namaKaryawan: user.nama,
            posisi: user.posisi,
            shift: shiftName,
            waktu: data.waktu ? data.waktu.toISOString() : now.toISOString(),
            lat: data.lat || "",
            lng: data.lng || "",
            jarak: data.jarak || "",
            alasanLuarArea: data.alasanLuarArea || "",
          };

          await fetch(GOOGLE_SHEET_WEBAPP_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
            mode: "no-cors", // biar nggak error CORS di browser
          });
        } catch (err) {
          console.error("Gagal mengirim data ke Google Sheet", err);
        }
      }

      // Helper untuk mengelompokkan baris absensi dari Sheet
      function groupAbsensiRows(rows) {
        const map = new Map();

        rows.forEach((row) => {
          const key = `${row.idKaryawan}|${row.tanggal}`;
          let record = map.get(key);
          if (!record) {
            record = {
              idKaryawan: row.idKaryawan,
              namaKaryawan: row.namaKaryawan,
              posisi: row.posisi,
              tanggal: row.tanggal,
              shift: row.shift || "",
              checkIn: null,
              checkOut: null,
              jobDeskProgress: buildJobdeskForPosition(row.posisi),
              status: "",
            };
            map.set(key, record);
          }

          const waktuDate = row.waktu
            ? new Date(row.waktu)
            : row.timestamp
            ? new Date(row.timestamp)
            : null;

          const baseObj = {
            waktu: waktuDate,
            alasanLuarArea: row.alasanLuarArea || null,
            lat: row.lat !== "" && row.lat != null ? Number(row.lat) : null,
            lng: row.lng !== "" && row.lng != null ? Number(row.lng) : null,
            jarak: row.jarak !== "" && row.jarak != null ? Number(row.jarak) : null,
          };

          if (row.jenis === "checkIn") {
            record.checkIn = baseObj;
          } else if (row.jenis === "checkOut") {
            record.checkOut = baseObj;
          }
        });

        // opsional set status
        map.forEach((rec) => {
          if (rec.checkIn && rec.checkOut) rec.status = "Hadir (Lengkap)";
          else if (rec.checkIn && !rec.checkOut) rec.status = "Hadir (Belum Check-out)";
          else if (!rec.checkIn && rec.checkOut) rec.status = "Check-out Tanpa Check-in";
          else rec.status = "";
        });

        return Array.from(map.values());
      }

      // Baca data absensi dari Google Sheet
      async function loadAbsensiDariSheet() {
        try {
          const res = await fetch(
            GOOGLE_SHEET_WEBAPP_URL + "?action=getAbsensi"
          );
          if (!res.ok) throw new Error("Response tidak OK");
          const json = await res.json();
          if (!json || !Array.isArray(json.data)) return [];

          return groupAbsensiRows(json.data);
        } catch (err) {
          console.error("Gagal load absensi dari Google Sheet", err);
          return [];
        }
      }

      // --- KOMPONEN SHARED ---

      const Modal = ({ children, onClose, title }) => (
        <AnimatePresence>
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 p-4"
            onClick={onClose}
          >
            <motion.div
              initial={{ scale: 0.9, y: 20 }}
              animate={{ scale: 1, y: 0 }}
              exit={{ scale: 0.9, y: 20 }}
              className={`relative w-full max-w-lg overflow-hidden ${theme.colors.card} ${theme.rounding.card} shadow-2xl`}
              onClick={(e) => e.stopPropagation()}
            >
              <div
                className={`flex items-center justify-between p-5 ${theme.colors.border} border-b`}
              >
                <h3 className={`text-xl font-bold ${theme.colors.textPrimary}`}>
                  {title}
                </h3>
                <button
                  onClick={onClose}
                  className={`${theme.colors.textSecondary || "text-stone-600"} hover:text-red-500`}
                >
                  <XCircle size={24} />
                </button>
              </div>
              <div className="p-6">{children}</div>
            </motion.div>
          </motion.div>
        </AnimatePresence>
      );

      const Button = ({
        onClick,
        children,
        variant = "primary",
        disabled = false,
        className = "",
        type = "button",
      }) => {
        const variants = {
          primary: `${theme.colors.primary} ${theme.colors.textLight} ${theme.colors.primaryHover}`,
          secondary: `${theme.colors.secondary} ${theme.colors.textLight} ${theme.colors.secondaryHover}`,
          accent: `${theme.colors.accent} ${theme.colors.textLight} ${theme.colors.accentHover}`,
          danger: `${theme.colors.danger} ${theme.colors.textLight} hover:bg-red-700`,
          light: `${theme.colors.background} ${theme.colors.textPrimary} hover:bg-stone-200`,
        };

        return (
          <button
            type={type}
            onClick={onClick}
            disabled={disabled}
            className={`flex w-full items-center justify-center gap-2 p-3 font-semibold ${theme.rounding.button} transition-all duration-200 ${variants[variant]} ${
              disabled ? "opacity-50 cursor-not-allowed" : ""
            } ${className}`}
          >
            {children}
          </button>
        );
      };

      const Input = ({
        type = "text",
        placeholder,
        value,
        onChange,
        icon,
        className = "",
        ...rest
      }) => (
        <div className="relative w-full">
          {icon && (
            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400">
              {icon}
            </div>
          )}
          <input
            type={type}
            placeholder={placeholder}
            value={value}
            onChange={onChange}
            {...rest}
            className={`w-full ${theme.colors.background} ${theme.rounding.input} ${
              theme.colors.textPrimary
            } border ${theme.colors.border} p-3 ${
              icon ? "pl-10" : ""
            } focus:outline-none focus:ring-2 focus:ring-amber-800 ${className}`}
          />
        </div>
      );

      const Spinner = ({ size = 24 }) => (
        <motion.div
          animate={{ rotate: 360 }}
          transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
          className="border-t-transparent border-solid rounded-full border-stone-700 border-2"
          style={{ width: size, height: size }}
        />
      );

      const ProgressBar = ({ value, max }) => {
        const percent = max > 0 ? (value / max) * 100 : 0;
        return (
          <div
            className={`w-full ${theme.colors.background} ${theme.rounding.button} overflow-hidden`}
          >
            <motion.div
              className={`${theme.colors.accent} h-2`}
              initial={{ width: 0 }}
              animate={{ width: `${percent}%` }}
              transition={{ duration: 0.5, ease: "easeInOut" }}
            />
          </div>
        );
      };

      // --- MODAL ABSENSI (Selfie + GPS) ---

      const AttendanceFlow = ({ user, type, onClose, onComplete, todayShift }) => {
        const [step, setStep] = useState("camera");
        const [selfie, setSelfie] = useState(null);
        const [locationData, setLocationData] = useState(null);
        const [inArea, setInArea] = useState(false);
        const [distance, setDistance] = useState(0);
        const [error, setError] = useState(null);
        const [cameraSupported, setCameraSupported] = useState(true);

        const [reason, setReason] = useState("");
        const reasons = ["Sakit", "Izin", "Dinas Luar", "Lainnya"];

        const webcamRef = useRef(null);
        const streamRef = useRef(null);

        useEffect(() => {
          if (step === "camera") {
            const startCamera = async () => {
              try {
                if (
                  typeof navigator === "undefined" ||
                  !navigator.mediaDevices ||
                  !navigator.mediaDevices.getUserMedia
                ) {
                  setCameraSupported(false);
                  setError(
                    "Kamera tidak didukung di browser/lingkungan ini. Anda bisa melanjutkan tanpa selfie."
                  );
                  return;
                }

                setCameraSupported(true);
                const stream = await navigator.mediaDevices.getUserMedia({
                  video: { facingMode: "user" },
                  audio: false,
                });
                if (webcamRef.current) {
                  webcamRef.current.srcObject = stream;
                  webcamRef.current.play();
                  streamRef.current = stream;
                }
              } catch (err) {
                console.error("Error accessing webcam:", err);
                setCameraSupported(false);
                setError(
                  "Gagal mengakses kamera. Periksa izin kamera Anda, atau lanjutkan tanpa selfie."
                );
              }
            };
            startCamera();
          }

          return () => {
            if (streamRef.current) {
              streamRef.current.getTracks().forEach((track) => track.stop());
              streamRef.current = null;
            }
          };
        }, [step]);

        const captureSelfie = useCallback(() => {
          if (!webcamRef.current || !cameraSupported) {
            setError(
              "Kamera belum siap atau tidak didukung. Anda bisa menekan tombol 'Lewati Selfie'."
            );
            return;
          }

          const video = webcamRef.current;
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;

          const ctx = canvas.getContext("2d");
          if (!ctx) {
            setError("Gagal memproses gambar.");
            return;
          }

          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageSrc = canvas.toDataURL("image/jpeg");

          if (!imageSrc) {
            setError("Gagal mengambil foto. Coba lagi.");
            return;
          }
          setSelfie(imageSrc);
          setStep("location");

          if (streamRef.current) {
            streamRef.current.getTracks().forEach((track) => track.stop());
            streamRef.current = null;
          }
        }, [cameraSupported]);

        const continueWithoutSelfie = () => {
          setSelfie(null);
          setError(null);
          setStep("location");

          if (streamRef.current) {
            streamRef.current.getTracks().forEach((track) => track.stop());
            streamRef.current = null;
          }
        };

        useEffect(() => {
          if (step === "location") {
            setError(null);
            if (!navigator.geolocation) {
              setError("Browser Anda tidak mendukung Geolocation.");
              setStep("confirm");
              return;
            }

            navigator.geolocation.getCurrentPosition(
              (position) => {
                const { latitude, longitude } = position.coords;
                const dist = getHaversineDistance(
                  latitude,
                  longitude,
                  TARGET_LOCATION.latitude,
                  TARGET_LOCATION.longitude
                );

                setLocationData({ latitude, longitude });
                setDistance(dist);

                if (dist <= GPS_RADIUS_METERS) {
                  setInArea(true);
                  setStep("confirm");
                } else {
                  setInArea(false);
                  setStep("reason");
                }
              },
              (err) => {
                let errMsg = "Gagal mendapatkan lokasi. ";
                if (err.code === 1)
                  errMsg += "Pastikan Anda mengizinkan akses lokasi.";
                if (err.code === 2) errMsg += "Sinyal lokasi tidak tersedia.";
                if (err.code === 3) errMsg += "Waktu tunggu habis.";
                setError(errMsg);
                setStep("confirm");
              },
              { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
          }
        }, [step]);

        const handleSubmit = async () => {
          setStep("loading");

          const attendanceData = {
            waktu: new Date(),
            fotoBase64: selfie,
            lat: locationData?.latitude,
            lng: locationData?.longitude,
            alasanLuarArea: inArea ? null : reason,
            jarak: distance,
          };

          try {
            await kirimAbsensiKeSheet({
              user,
              jenis: type,
              data: attendanceData,
              shiftName: todayShift?.nama || "",
            });
          } catch (e) {
            console.error(e);
          }

          onComplete(attendanceData);
          setStep("success");
        };

        const title = type === "checkIn" ? "Absen Check-in" : "Absen Check-out";

        const renderStep = () => {
          switch (step) {
            case "camera":
              return (
                <div className="text-center">
                  <p className={`${theme.colors.textSecondary} mb-4`}>
                    Posisikan wajah Anda di dalam frame dan ambil selfie untuk
                    verifikasi. Jika kamera tidak berfungsi, Anda tetap bisa
                    lanjut tanpa selfie.
                  </p>
                  {cameraSupported && (
                    <div
                      className={`w-full overflow-hidden ${theme.rounding.card} border-2 ${theme.colors.border} shadow-inner bg-black`}
                    >
                      <video
                        ref={webcamRef}
                        autoPlay
                        playsInline
                        muted
                        className="w-full h-auto"
                        style={{ transform: "scaleX(-1)" }}
                      />
                    </div>
                  )}
                  {error && (
                    <p className="text-red-500 text-sm mt-2">{error}</p>
                  )}
                  <div className="flex flex-col sm:flex-row gap-3 mt-4">
                    <Button
                      onClick={captureSelfie}
                      variant="secondary"
                      className="sm:flex-1"
                      disabled={!cameraSupported}
                    >
                      <Camera size={20} /> Ambil Foto
                    </Button>
                    <Button
                      onClick={continueWithoutSelfie}
                      variant="light"
                      className="sm:flex-1"
                    >
                      Lewati Selfie
                    </Button>
                  </div>
                </div>
              );

            case "location":
              return (
                <div className="flex flex-col items-center justify-center h-48">
                  <Spinner size={40} />
                  <p
                    className={`${theme.colors.textPrimary} mt-4 font-semibold`}
                  >
                    Mendeteksi lokasi Anda...
                  </p>
                  <p className={`${theme.colors.textSecondary} text-sm`}>
                    Pastikan GPS dan izin lokasi aktif.
                  </p>
                </div>
              );

            case "reason":
              return (
                <div>
                  <div
                    className={`flex items-center gap-3 p-4 ${theme.rounding.button} bg-yellow-100 border border-yellow-300 text-yellow-800`}
                  >
                    <AlertTriangle size={24} />
                    <div>
                      <h4 className="font-bold">Anda Berada di Luar Area!</h4>
                      <p className="text-sm">
                        Jarak Anda: {distance.toFixed(0)} meter dari PayBoss
                        Cafe.
                      </p>
                    </div>
                  </div>
                  <p
                    className={`${theme.colors.textSecondary} mt-4 mb-3`}
                  >
                    Harap pilih alasan Anda absen di luar area kerja:
                  </p>
                  <div className="space-y-2">
                    {reasons.map((r) => (
                      <label
                        key={r}
                        className={`flex items-center w-full p-3 ${
                          theme.rounding.input
                        } ${theme.colors.background} border ${
                          reason === r
                            ? "border-amber-800 ring-2 ring-amber-800"
                            : theme.colors.border
