<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PayBoss - Sistem Absensi Karyawan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #1e293b, #020617);
      color: #e5e7eb;
      min-height: 100vh;
    }
    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
 </head>
 <body class="antialiased">
  <div id="app" class="min-h-screen flex items-center justify-center p-4">
    <div class="max-w-5xl w-full space-y-4">
      <!-- Header -->
      <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h1 class="text-xl sm:text-2xl font-bold tracking-tight">
            PayBoss Cafe ‚Äì Sistem Absensi
          </h1>
          <p class="text-xs sm:text-sm text-slate-400">
            Absensi dengan selfie + GPS on the spot
          </p>
        </div>
        <div class="text-right">
          <p id="clockText" class="text-xs sm:text-sm text-slate-400 font-mono">
            -
          </p>
          <p id="currentUserLabel" class="text-xs text-emerald-400 hidden">
            Login sebagai: <span id="currentUserName" class="font-semibold"></span> (<span id="currentUserRoleText"></span>)
          </p>
        </div>
      </header>

      <!-- Card container -->
      <div class="bg-slate-900/70 border border-slate-800 rounded-2xl shadow-xl shadow-slate-900/40 p-4 sm:p-6 fade-in">
        <!-- Login Page -->
        <section id="loginPage" class="space-y-4">
          <div class="flex items-center gap-2 text-sm text-slate-300">
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-emerald-500/10 text-emerald-400 text-lg">‚è±</span>
            <div>
              <p class="font-semibold">Login Absensi</p>
              <p class="text-xs text-slate-400">
                Pilih role & masukkan nama sebelum mulai absen.
              </p>
            </div>
          </div>

          <form id="loginForm" class="space-y-4">
            <div class="grid sm:grid-cols-2 gap-4">
              <div class="space-y-1.5">
                <label for="nameInput" class="text-xs font-medium text-slate-300">Nama karyawan</label>
                <input id="nameInput" type="text" required placeholder="Contoh: Budi, Siti, dll."
                  class="w-full rounded-xl border border-slate-700 bg-slate-900/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
              </div>
              <div class="space-y-1.5">
                <label for="roleSelect" class="text-xs font-medium text-slate-300">Role</label>
                <select id="roleSelect" required
                  class="w-full rounded-xl border border-slate-700 bg-slate-900/60 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                  <option value="" disabled selected>Pilih role</option>
                  <option value="employee">Karyawan</option>
                  <option value="manager">Manager</option>
                </select>
              </div>
            </div>

            <div class="grid sm:grid-cols-2 gap-4">
              <div class="space-y-1.5">
                <label for="passwordInput" class="text-xs font-medium text-slate-300">Password</label>
                <input id="passwordInput" type="password" required placeholder="Masukkan password"
                  class="w-full rounded-xl border border-slate-700 bg-slate-900/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                <p class="text-[11px] text-slate-500 mt-1">
                  Demo: Karyawan = <code class="font-mono">1234</code>, Manager = <code class="font-mono">admin123</code> (bisa diganti di kode).
                </p>
              </div>
              <div class="flex items-end justify-end">
                <button type="submit"
                  class="inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-500 px-4 py-2.5 text-sm font-semibold text-slate-950 shadow-lg shadow-emerald-500/30 hover:bg-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                  <span>Masuk</span>
                  <span>‚û°Ô∏è</span>
                </button>
              </div>
            </div>
          </form>
        </section>

        <!-- Main Page -->
        <section id="mainPage" class="space-y-5 hidden">
          <!-- Top bar -->
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 border-b border-slate-800 pb-3">
            <div>
              <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Dashboard Absensi</p>
              <p class="text-sm font-semibold text-slate-100">
                Mode: <span id="mainRoleTitle" class="text-emerald-400">Karyawan</span>
              </p>
            </div>
            <div class="flex items-center gap-2 justify-end">
              <button id="btnLogout" type="button"
                class="text-xs px-3 py-1.5 rounded-lg border border-slate-700 text-slate-300 hover:bg-slate-800">
                Keluar
              </button>
            </div>
          </div>

          <!-- Panel Karyawan -->
          <div id="employeePanel" class="space-y-4">
            <!-- GPS status card -->
            <div class="bg-slate-800/60 border border-slate-700 rounded-2xl p-4 space-y-3">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <p class="text-xs uppercase tracking-wide text-slate-400">Status Lokasi</p>
                  <p id="locationStatusText" class="text-sm font-semibold">
                    Belum aktif
                  </p>
                </div>
                <button id="btnActivateGPS" type="button"
                  class="px-3 py-2 text-xs rounded-lg bg-emerald-500 hover:bg-emerald-600 font-semibold text-slate-950 shadow shadow-emerald-500/40">
                  üìç Aktifkan GPS
                </button>
              </div>
              <div class="grid grid-cols-3 gap-2 text-xs text-slate-300">
                <div>
                  <p class="text-[11px] text-slate-400">Jarak ke Cafe</p>
                  <p id="locationDistanceLabel" class="font-mono">-</p>
                </div>
                <div>
                  <p class="text-[11px] text-slate-400">Akurasi GPS</p>
                  <p id="locationAccuracyLabel" class="font-mono">-</p>
                </div>
                <div>
                  <p class="text-[11px] text-slate-400">Status</p>
                  <p id="locationStatusLabel" class="font-mono">unknown</p>
                </div>
              </div>
              <p class="text-[11px] text-slate-400">
                Tombol absensi hanya aktif jika status lokasi
                <span class="font-semibold text-emerald-400">valid</span> dan Anda berada dalam radius
                <span class="font-mono">200 m</span> dari cafe.
              </p>
            </div>

            <!-- Selfie card -->
            <div class="bg-slate-800/60 border border-slate-700 rounded-2xl p-4 space-y-3">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <p class="text-xs uppercase tracking-wide text-slate-400">Selfie Kehadiran</p>
                  <p class="text-sm text-slate-100">Ambil foto sebagai bukti hadir.</p>
                </div>
              </div>
              <div class="flex flex-col sm:flex-row gap-4 items-center">
                <div
                  class="relative w-40 h-40 bg-slate-900 rounded-2xl overflow-hidden flex items-center justify-center border border-slate-700">
                  <video id="videoSelfie" autoplay playsinline class="w-full h-full object-cover hidden"></video>
                  <canvas id="canvasSelfie" class="w-full h-full hidden"></canvas>
                  <div id="selfiePlaceholder" class="text-[11px] text-slate-400 text-center p-2">
                    Belum ada foto.<br>Tekan <span class="font-semibold">"Buka Kamera"</span> untuk mulai.
                  </div>
                </div>
                <div class="flex flex-col gap-2 w-full sm:w-auto">
                  <button id="btnOpenCamera" type="button"
                    class="inline-flex items-center justify-center gap-2 rounded-xl bg-sky-500 px-4 py-2 text-xs font-semibold text-slate-950 hover:bg-sky-400">
                    üì∑ Buka Kamera
                  </button>
                  <button id="btnCaptureSelfie" type="button" disabled
                    class="inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-500 px-4 py-2 text-xs font-semibold text-slate-950 hover:bg-emerald-400 disabled:opacity-40 disabled:cursor-not-allowed">
                    üì∏ Ambil Selfie
                  </button>
                  <p id="selfieStatus" class="text-[11px] text-slate-400">
                    Kamera belum aktif.
                  </p>
                </div>
              </div>
            </div>

            <!-- Absensi buttons -->
            <div class="bg-slate-800/60 border border-slate-700 rounded-2xl p-4 space-y-3">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <p class="text-xs uppercase tracking-wide text-slate-400">Tombol Absensi</p>
                  <p class="text-sm text-slate-100">
                    Pastikan GPS <span class="text-emerald-400 font-semibold">valid</span> & selfie sudah diambil.
                  </p>
                </div>
              </div>
              <div class="flex flex-wrap gap-3">
                <button id="btnCheckIn" type="button" disabled
                  class="flex-1 sm:flex-none sm:w-40 inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-500 px-4 py-2.5 text-sm font-semibold text-slate-950 hover:bg-emerald-400 disabled:opacity-40 disabled:cursor-not-allowed">
                  ‚è∞ Check-in
                </button>
                <button id="btnCheckOut" type="button" disabled
                  class="flex-1 sm:flex-none sm:w-40 inline-flex items-center justify-center gap-2 rounded-xl bg-rose-500 px-4 py-2.5 text-sm font-semibold text-slate-950 hover:bg-rose-400 disabled:opacity-40 disabled:cursor-not-allowed">
                  üö™ Check-out
                </button>
              </div>
              <p class="text-[11px] text-slate-500">
                Data absensi akan dikirim ke Google Sheets melalui Apps Script (URL bisa disetting di bagian atas
                JavaScript).
              </p>
            </div>
          </div>

          <!-- Panel Manager -->
          <div id="managerPanel" class="space-y-4 hidden">
            <div class="bg-slate-800/60 border border-slate-700 rounded-2xl p-4 space-y-3">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <p class="text-xs uppercase tracking-wide text-slate-400">Data Absensi</p>
                  <p class="text-sm text-slate-100">Rekap terakhir dari Google Sheets.</p>
                </div>
                <button id="btnRefreshAttendance" type="button"
                  class="px-3 py-1.5 text-xs rounded-lg border border-slate-600 text-slate-200 hover:bg-slate-700">
                  üîÑ Refresh data
                </button>
              </div>
              <div class="overflow-auto max-h-[420px] border border-slate-700/80 rounded-xl">
                <table class="min-w-full text-xs">
                  <thead class="bg-slate-900 text-slate-300 sticky top-0">
                    <tr>
                      <th class="px-3 py-2 text-left font-semibold">Tanggal</th>
                      <th class="px-3 py-2 text-left font-semibold">Nama</th>
                      <th class="px-3 py-2 text-left font-semibold">Status</th>
                      <th class="px-3 py-2 text-left font-semibold">Waktu</th>
                      <th class="px-3 py-2 text-left font-semibold">Lokasi</th>
                    </tr>
                  </thead>
                  <tbody id="attendanceTableBody" class="divide-y divide-slate-800 bg-slate-900/40">
                  </tbody>
                </table>
              </div>
              <p id="attendanceInfoText" class="text-[11px] text-slate-500">
                Tekan "Refresh data" untuk mengambil data terbaru dari Apps Script.
              </p>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- GPS Guide Overlay -->
  <div id="gpsGuideOverlay"
       class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-40">
    <div class="bg-slate-900 border border-slate-700 rounded-2xl max-w-md w-full mx-4 p-6 space-y-4">
      <h2 class="text-lg font-semibold flex items-center gap-2">
        üìç Panduan Mengaktifkan GPS
      </h2>
      <ol class="list-decimal list-inside text-sm text-slate-200 space-y-1">
        <li>Aktifkan fitur lokasi / GPS di HP Anda.</li>
        <li>Saat browser meminta izin lokasi, pilih <span class="font-semibold">Izinkan / Allow</span>.</li>
        <li>Gunakan browser Chrome untuk hasil paling stabil.</li>
      </ol>
      <p class="text-xs text-slate-400">
        Catatan: Absensi hanya valid jika Anda berada dalam radius sekitar <span class="font-mono">200 m</span> dari titik
        cafe PayBoss.
      </p>
      <div class="flex flex-wrap gap-2 justify-end pt-2">
        <button type="button" onclick="closeGPSGuide()"
                class="px-3 py-1.5 text-xs rounded-lg border border-slate-600 text-slate-200 hover:bg-slate-800">
          Nanti saja
        </button>
        <button type="button" id="btnRequestGPS"
                class="px-3 py-1.5 text-xs rounded-lg bg-emerald-500 hover:bg-emerald-600 font-semibold text-slate-950">
          üéØ Minta izin GPS sekarang
        </button>
      </div>
    </div>
  </div>

  <!-- Location Toast -->
  <div id="locationAlert"
       class="fixed bottom-4 right-4 max-w-sm w-full mx-4 sm:mx-0 transform translate-y-6 opacity-0 pointer-events-none z-50 transition-all duration-300">
    <div class="bg-slate-900/95 border border-slate-700 rounded-xl px-4 py-3 text-sm text-slate-100 shadow-lg flex gap-3">
      <div class="text-lg">üì°</div>
      <div id="locationAlertMessage" class="flex-1"></div>
    </div>
  </div>

  <script>
    // =============================
    // Konfigurasi dasar
    // =============================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxOHwN1-GyfwWrQLucTf-X0Db_9HefScgxd5g2h35-ntTNyGQZ4NePhZ39OfeZqRvdM/exec";

    const ROLE_CONFIG = {
      employee: {
        label: "Karyawan",
        password: "1234",
      },
      manager: {
        label: "Manager",
        password: "admin123",
      },
    };

    // Koordinat Cafe PayBoss (radius 200m)
    const CAFE_LOCATION = {
      lat: -2.1717546572371975,
      lng: 115.40299759147925,
      name: "Cafe Payboss",
      address: "Jl. Tanjung Permai No 2 RT 07 Pembataan. Murung Pudak. Tabalong",
      radius: 200, // meter
    };

    // =============================
    // State global
    // =============================
    let currentUserName = "";
    let currentRole = "";
    let currentView = "login";

    let userLocation = null;
    let locationStatus = "unknown";
    let locationMonitoringInterval = null;
    let locationAlertTimeout = null;

    let selfieStream = null;
    let lastCapturedPhoto = "";

    let isSubmittingAttendance = false;

    // =============================
    // Util: Jam
    // =============================
    function updateClock() {
      const el = document.getElementById("clockText");
      if (!el) return;
      const now = new Date();
      const datePart = now.toLocaleDateString("id-ID", {
        weekday: "short",
        year: "numeric",
        month: "short",
        day: "numeric",
      });
      const timePart = now.toLocaleTimeString("id-ID", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
      el.textContent = datePart + " ‚Ä¢ " + timePart;
    }

    // =============================
    // UI dasar
    // =============================
    function showLoginPage() {
      currentView = "login";
      const login = document.getElementById("loginPage");
      const main = document.getElementById("mainPage");
      if (login) login.classList.remove("hidden");
      if (main) main.classList.add("hidden");

      const label = document.getElementById("currentUserLabel");
      if (label) label.classList.add("hidden");
    }

    function showMainPage() {
      const login = document.getElementById("loginPage");
      const main = document.getElementById("mainPage");
      if (login) login.classList.add("hidden");
      if (main) main.classList.remove("hidden");

      const roleTitle = document.getElementById("mainRoleTitle");
      const userLabelWrap = document.getElementById("currentUserLabel");
      const userNameEl = document.getElementById("currentUserName");
      const userRoleText = document.getElementById("currentUserRoleText");

      if (roleTitle) {
        roleTitle.textContent =
          currentRole === "manager" ? "Manager" : "Karyawan";
      }
      if (userLabelWrap) userLabelWrap.classList.remove("hidden");
      if (userNameEl) userNameEl.textContent = currentUserName;
      if (userRoleText) {
        userRoleText.textContent =
          currentRole === "manager" ? "Manager" : "Karyawan";
      }

      const employeePanel = document.getElementById("employeePanel");
      const managerPanel = document.getElementById("managerPanel");

      if (currentRole === "manager") {
        currentView = "manager";
        if (employeePanel) employeePanel.classList.add("hidden");
        if (managerPanel) managerPanel.classList.remove("hidden");
        stopLocationMonitoring();
        loadAttendance();
      } else {
        currentView = "employee";
        if (employeePanel) employeePanel.classList.remove("hidden");
        if (managerPanel) managerPanel.classList.add("hidden");
        checkLocationPermission();
      }
    }

    // =============================
    // Toast / alert lokasi
    // =============================
    function showLocationAlert(message) {
      const wrapper = document.getElementById("locationAlert");
      const msgEl = document.getElementById("locationAlertMessage");
      if (!wrapper || !msgEl) return;

      msgEl.textContent = message;
      wrapper.classList.remove(
        "translate-y-6",
        "opacity-0",
        "pointer-events-none"
      );
      wrapper.classList.add("translate-y-0", "opacity-100");

      if (locationAlertTimeout) clearTimeout(locationAlertTimeout);
      locationAlertTimeout = setTimeout(() => {
        wrapper.classList.add("translate-y-6", "opacity-0", "pointer-events-none");
      }, 5000);
    }

    // =============================
    // GPS helper
    // =============================
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // meter
      const toRad = (deg) => (deg * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) *
          Math.cos(toRad(lat2)) *
          Math.sin(dLon / 2) *
          Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Helper: proses posisi GPS + toleransi akurasi
    function processGPSPosition(position, options = {}) {
      const { showToast = true, startMonitoring = false } = options;

      userLocation = {
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        accuracy: position.coords.accuracy,
        timestamp: new Date().toISOString(),
      };

      const distance = calculateDistance(
        userLocation.lat,
        userLocation.lng,
        CAFE_LOCATION.lat,
        CAFE_LOCATION.lng
      );
      userLocation.distance = distance;

      // Tambah sedikit toleransi berdasarkan akurasi, max 50 m
      const extraTolerance = userLocation.accuracy
        ? Math.min(userLocation.accuracy, 50)
        : 0;
      const threshold = CAFE_LOCATION.radius + extraTolerance;

      if (distance <= threshold) {
        locationStatus = "valid";
        if (showToast) {
          showLocationAlert(
            `‚úÖ GPS berhasil! Anda berada di area cafe yang valid (‚âà ${distance.toFixed(
              0
            )} m dari titik).`
          );
        }
        if (startMonitoring) {
          startLocationMonitoring();
        }
      } else {
        locationStatus = "invalid";
        if (showToast) {
          showLocationAlert(
            `‚ö†Ô∏è Anda berada sekitar ${distance.toFixed(
              0
            )} m dari cafe. Absensi hanya bisa dilakukan dalam radius ${
              CAFE_LOCATION.radius
            } m.`
          );
        }
      }

      render();
      updateLocationUI();
    }

    // Helper: handler error GPS
    function handleGPSError(error, options = {}) {
      const { showToast = true } = options;

      console.error("GPS Error:", error);
      let errorMessage = "";

      const code = error && typeof error.code !== "undefined" ? error.code : 0;

      switch (code) {
        case 1: // PERMISSION_DENIED
          locationStatus = "denied";
          errorMessage =
            "üö´ Akses GPS ditolak. Silakan izinkan akses lokasi di browser lalu coba lagi.";
          break;
        case 2: // POSITION_UNAVAILABLE
          locationStatus = "unavailable";
          errorMessage =
            "üì° Sinyal GPS tidak tersedia. Pastikan Anda berada di area terbuka dan GPS aktif.";
          break;
        case 3: // TIMEOUT
          locationStatus = "timeout";
          errorMessage =
            "‚è±Ô∏è GPS timeout. Coba ulangi atau pindah ke area dengan sinyal lebih baik.";
          break;
        default:
          locationStatus = "error";
          errorMessage =
            "‚ùå Terjadi kesalahan saat mengakses GPS. Refresh halaman dan coba lagi.";
          break;
      }

      if (showToast) {
        showLocationAlert(errorMessage);
      }

      render();
      updateLocationUI();
    }

    // =============================
    // GPS permission & monitoring
    // =============================
    function showGPSGuide() {
      const overlay = document.getElementById("gpsGuideOverlay");
      if (!overlay) return;
      overlay.classList.remove("hidden");
      overlay.classList.add("flex");
    }

    function closeGPSGuide() {
      const overlay = document.getElementById("gpsGuideOverlay");
      if (!overlay) return;
      overlay.classList.add("hidden");
      overlay.classList.remove("flex");
    }

    function showGPSRequestNotification() {
      showLocationAlert("Meminta izin GPS dari perangkat...");
    }
    function hideGPSRequestNotification() {
      // bisa dikembangkan jika ingin ada indikator loading khusus
    }
    function showGPSSuccessNotification() {
      showLocationAlert("Izin GPS diterima. Mengambil lokasi Anda...");
    }
    function showGPSErrorNotification(error) {
      const message =
        (error && error.message) || "Gagal mengaktifkan GPS. Coba ulangi lagi.";
      showLocationAlert("‚ùå " + message);
    }

    function checkLocationPermission() {
      if (!navigator.geolocation) {
        locationStatus = "not_supported";
        render();
        return;
      }

      locationStatus = "checking";
      render();
      updateLocationUI();

      showGPSGuide();

      navigator.geolocation.getCurrentPosition(
        (position) => {
          processGPSPosition(position, {
            showToast: true,
            startMonitoring: true,
          });
        },
        (error) => {
          handleGPSError(error, { showToast: true });
        },
        {
          enableHighAccuracy: true,
          timeout: 20000,
          maximumAge: 60000,
        }
      );
    }

    function requestGPSPermission() {
      closeGPSGuide();
      showGPSRequestNotification();

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            hideGPSRequestNotification();
            showGPSSuccessNotification();

            processGPSPosition(position, {
              showToast: true,
              startMonitoring: true,
            });
          },
          (error) => {
            hideGPSRequestNotification();
            showGPSErrorNotification(error);
            handleGPSError(error, { showToast: false });
          },
          {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0,
          }
        );
      } else {
        hideGPSRequestNotification();
        const err = { code: 0, message: "Geolocation tidak didukung perangkat." };
        showGPSErrorNotification(err);
        handleGPSError(err, { showToast: true });
      }
    }

    function startLocationMonitoring() {
      if (locationMonitoringInterval) {
        clearInterval(locationMonitoringInterval);
      }

      locationMonitoringInterval = setInterval(() => {
        if (currentView === "employee" && navigator.geolocation) {
          const previousStatus = locationStatus;

          navigator.geolocation.getCurrentPosition(
            (position) => {
              processGPSPosition(position, {
                showToast: false,
                startMonitoring: false,
              });

              if (previousStatus === "valid" && locationStatus === "invalid") {
                showLocationAlert(
                  "‚ö†Ô∏è Anda telah keluar dari area cafe! Tombol absensi dinonaktifkan."
                );
              }
            },
            (error) => {
              console.error("Location monitoring error:", error);
              handleGPSError(error, { showToast: false });
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 60000,
            }
          );
        }
      }, 30000); // cek setiap 30 detik
    }

    function stopLocationMonitoring() {
      if (locationMonitoringInterval) {
        clearInterval(locationMonitoringInterval);
        locationMonitoringInterval = null;
      }
    }

    // =============================
    // UI Lokasi
    // =============================
    function getLocationStatusText() {
      switch (locationStatus) {
        case "checking":
          return "Sedang mengecek lokasi...";
        case "valid":
          return "‚úÖ Di dalam area cafe";
        case "invalid":
          return "Di luar radius cafe";
        case "denied":
          return "Izin GPS ditolak";
        case "timeout":
          return "GPS timeout";
        case "unavailable":
          return "Sinyal GPS tidak tersedia";
        case "not_supported":
          return "Perangkat tidak mendukung GPS";
        case "error":
          return "Terjadi kesalahan GPS";
        default:
          return "Belum aktif";
      }
    }

    function updateLocationUI() {
      const statusLabel = document.getElementById("locationStatusLabel");
      const statusText = document.getElementById("locationStatusText");
      const distanceEl = document.getElementById("locationDistanceLabel");
      const accuracyEl = document.getElementById("locationAccuracyLabel");
      const btnCheckIn = document.getElementById("btnCheckIn");
      const btnCheckOut = document.getElementById("btnCheckOut");

      if (statusLabel) {
        statusLabel.textContent = locationStatus || "unknown";
      }
      if (statusText) {
        statusText.textContent = getLocationStatusText();
      }

      if (distanceEl) {
        if (userLocation && typeof userLocation.distance === "number") {
          distanceEl.textContent = userLocation.distance.toFixed(0) + " m";
        } else {
          distanceEl.textContent = "-";
        }
      }

      if (accuracyEl) {
        if (userLocation && typeof userLocation.accuracy === "number") {
          accuracyEl.textContent = userLocation.accuracy.toFixed(0) + " m";
        } else {
          accuracyEl.textContent = "-";
        }
      }

      const canAbsen = locationStatus === "valid";
      if (btnCheckIn) btnCheckIn.disabled = !canAbsen;
      if (btnCheckOut) btnCheckOut.disabled = !canAbsen;
    }

    function render() {
      updateLocationUI();
    }

    // =============================
    // Selfie
    // =============================
    async function openCamera() {
      const video = document.getElementById("videoSelfie");
      const canvas = document.getElementById("canvasSelfie");
      const placeholder = document.getElementById("selfiePlaceholder");
      const status = document.getElementById("selfieStatus");
      const captureBtn = document.getElementById("btnCaptureSelfie");

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        if (status) {
          status.textContent =
            "Perangkat atau browser tidak mendukung kamera (getUserMedia).";
        }
        return;
      }

      try {
        if (selfieStream) {
          selfieStream.getTracks().forEach((t) => t.stop());
          selfieStream = null;
        }

        selfieStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false,
        });

        if (video) {
          video.srcObject = selfieStream;
          video.classList.remove("hidden");
        }
        if (canvas) canvas.classList.add("hidden");
        if (placeholder) placeholder.classList.add("hidden");
        if (status) {
          status.textContent =
            "Kamera aktif. Atur posisi wajah, lalu tekan 'Ambil Selfie'.";
        }
        if (captureBtn) captureBtn.disabled = false;
      } catch (err) {
        console.error("Kamera error:", err);
        if (status) {
          status.textContent =
            "Tidak bisa mengakses kamera. Pastikan izin kamera diberikan.";
        }
      }
    }

    function captureSelfie() {
      const video = document.getElementById("videoSelfie");
      const canvas = document.getElementById("canvasSelfie");
      const placeholder = document.getElementById("selfiePlaceholder");
      const status = document.getElementById("selfieStatus");
      const captureBtn = document.getElementById("btnCaptureSelfie");

      if (!video || !canvas) return;
      if (video.readyState < 2) {
        if (status) status.textContent = "Tunggu sebentar, kamera belum siap.";
        return;
      }

      const width = video.videoWidth;
      const height = video.videoHeight;
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, width, height);

      lastCapturedPhoto = canvas.toDataURL("image/jpeg", 0.8);

      canvas.classList.remove("hidden");
      video.classList.add("hidden");
      if (placeholder) placeholder.classList.add("hidden");

      if (status) {
        status.textContent =
          "Selfie tersimpan. Foto ini akan dikirim bersama data absensi.";
      }

      if (selfieStream) {
        selfieStream.getTracks().forEach((t) => t.stop());
        selfieStream = null;
      }

      if (captureBtn) captureBtn.disabled = true;
    }

    // =============================
    // Absensi (kirim ke Apps Script)
    // =============================
    function submitAttendance(type) {
      if (isSubmittingAttendance) return;

      if (!currentUserName) {
        showLocationAlert("Silakan login terlebih dahulu.");
        return;
      }

      if (locationStatus !== "valid") {
        showLocationAlert(
          "Lokasi belum valid. Aktifkan GPS dan pastikan Anda berada di area cafe."
        );
        return;
      }

      const now = new Date();

      const params = {
        action: "submitAttendance",
        name: currentUserName,
        role: currentRole,
        type: type,
        timestamp: now.toISOString(),
        lat: userLocation && userLocation.lat ? userLocation.lat : "",
        lng: userLocation && userLocation.lng ? userLocation.lng : "",
        accuracy:
          userLocation && typeof userLocation.accuracy !== "undefined"
            ? userLocation.accuracy
            : "",
        distance:
          userLocation && typeof userLocation.distance !== "undefined"
            ? userLocation.distance
            : "",
        locationStatus: locationStatus,
        photo: lastCapturedPhoto || "",
      };

      isSubmittingAttendance = true;
      const btnIn = document.getElementById("btnCheckIn");
      const btnOut = document.getElementById("btnCheckOut");
      if (btnIn) btnIn.disabled = true;
      if (btnOut) btnOut.disabled = true;

      showLocationAlert("Mengirim data absensi ke server...");

      const query = new URLSearchParams(params).toString();

      fetch(SCRIPT_URL + "?" + query, {
        method: "GET",
      })
        .then(() => {
          showLocationAlert("‚úÖ Absensi berhasil dikirim.");
        })
        .catch((err) => {
          console.error(err);
          showLocationAlert(
            "‚ùå Gagal mengirim absensi. Periksa koneksi internet atau Apps Script."
          );
        })
        .finally(() => {
          isSubmittingAttendance = false;
          updateLocationUI();
        });
    }

    // =============================
    // Manager - Load data absensi
    // =============================
    function loadAttendance() {
      const infoEl = document.getElementById("attendanceInfoText");
      const tbody = document.getElementById("attendanceTableBody");
      if (!tbody) return;

      tbody.innerHTML = "";
      if (infoEl) {
        infoEl.textContent = "Memuat data absensi dari server...";
      }

      fetch(SCRIPT_URL + "?action=getAttendance", {
        method: "GET",
      })
        .then((res) => res.json())
        .then((json) => {
          const rows = json.data || json || [];
          tbody.innerHTML = "";

          if (!rows.length) {
            if (infoEl) infoEl.textContent = "Belum ada data absensi.";
            return;
          }

          rows.forEach((row) => {
            const tr = document.createElement("tr");
            tr.className = "hover:bg-slate-800/80";

            const ts =
              row.timestamp || row.time || row.datetime || new Date().toISOString();
            const d = new Date(ts);
            const tanggal = d.toLocaleDateString("id-ID", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
            });
            const waktu = d.toLocaleTimeString("id-ID", {
              hour: "2-digit",
              minute: "2-digit",
            });

            tr.innerHTML = `
              <td class="px-3 py-2 align-top">${tanggal}</td>
              <td class="px-3 py-2 align-top">${row.name || "-"}</td>
              <td class="px-3 py-2 align-top">${row.type || row.status || "-"}</td>
              <td class="px-3 py-2 align-top">${waktu}</td>
              <td class="px-3 py-2 align-top text-[11px] text-slate-400">
                ${(row.locationStatus || "").toString()}<br>
                <span class="font-mono">${row.lat || ""}, ${row.lng || ""}</span>
              </td>
            `;
            tbody.appendChild(tr);
          });

          if (infoEl) {
            infoEl.textContent =
              "Terakhir update: " +
              new Date().toLocaleTimeString("id-ID", {
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
              });
          }
        })
        .catch((err) => {
          console.error(err);
          if (infoEl) {
            infoEl.textContent =
              "Gagal memuat data absensi. Cek kembali konfigurasi Apps Script.";
          }
        });
    }

    // =============================
    // Auth / logout
    // =============================
    function handleLogin(e) {
      e.preventDefault();
      const nameInput = document.getElementById("nameInput");
      const roleSelect = document.getElementById("roleSelect");
      const passInput = document.getElementById("passwordInput");

      const name = nameInput ? nameInput.value.trim() : "";
      const role = roleSelect ? roleSelect.value : "";
      const pass = passInput ? passInput.value : "";

      if (!name || !role || !pass) {
        showLocationAlert("Lengkapi nama, role, dan password terlebih dahulu.");
        return;
      }

      const cfg = ROLE_CONFIG[role];
      if (!cfg) {
        showLocationAlert("Role tidak dikenal.");
        return;
      }

      if (pass !== cfg.password) {
        showLocationAlert("Password salah untuk role " + cfg.label + ".");
        return;
      }

      currentUserName = name;
      currentRole = role;
      showMainPage();
      updateLocationUI();
    }

    function logout() {
      currentUserName = "";
      currentRole = "";
      userLocation = null;
      locationStatus = "unknown";
      stopLocationMonitoring();

      if (lastCapturedPhoto) lastCapturedPhoto = "";
      if (selfieStream) {
        selfieStream.getTracks().forEach((t) => t.stop());
        selfieStream = null;
      }

      showLoginPage();
      updateLocationUI();

      const nameInput = document.getElementById("nameInput");
      const passInput = document.getElementById("passwordInput");
      if (nameInput) nameInput.value = "";
      if (passInput) passInput.value = "";
    }

    // =============================
    // Init
    // =============================
    document.addEventListener("DOMContentLoaded", () => {
      // clock
      updateClock();
      setInterval(updateClock, 1000);

      showLoginPage();
      updateLocationUI();

      const loginForm = document.getElementById("loginForm");
      if (loginForm) {
        loginForm.addEventListener("submit", handleLogin);
      }

      const btnLogout = document.getElementById("btnLogout");
      if (btnLogout) {
        btnLogout.addEventListener("click", logout);
      }

      const btnActivateGPS = document.getElementById("btnActivateGPS");
      if (btnActivateGPS) {
        btnActivateGPS.addEventListener("click", checkLocationPermission);
      }

      const btnRequestGPS = document.getElementById("btnRequestGPS");
      if (btnRequestGPS) {
        btnRequestGPS.addEventListener("click", requestGPSPermission);
      }

      const btnCheckIn = document.getElementById("btnCheckIn");
      if (btnCheckIn) {
        btnCheckIn.addEventListener("click", () => submitAttendance("IN"));
      }

      const btnCheckOut = document.getElementById("btnCheckOut");
      if (btnCheckOut) {
        btnCheckOut.addEventListener("click", () => submitAttendance("OUT"));
      }

      const btnRefreshAttendance = document.getElementById("btnRefreshAttendance");
      if (btnRefreshAttendance) {
        btnRefreshAttendance.addEventListener("click", loadAttendance);
      }

      const btnOpenCamera = document.getElementById("btnOpenCamera");
      if (btnOpenCamera) {
        btnOpenCamera.addEventListener("click", openCamera);
      }

      const btnCaptureSelfie = document.getElementById("btnCaptureSelfie");
      if (btnCaptureSelfie) {
        btnCaptureSelfie.addEventListener("click", captureSelfie);
      }
    });
  </script>
 </body>
</html>
