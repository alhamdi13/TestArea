<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PayBoss Cafe - Sistem Absensi</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel (untuk JSX di browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Framer Motion UMD -->
    <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>
  </head>

  <body class="bg-stone-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useRef, useEffect, useCallback } = React;

      // Inisialisasi Framer Motion dari UMD (fallback kalau gagal load)
      const fm = window.FramerMotion || null;
      const motion = fm
        ? fm.motion
        : {
            div: (props) => <div {...props} />, 
            form: (props) => <form {...props} />,
          };
      const AnimatePresence = fm ? fm.AnimatePresence : ({ children }) => <>{children}</>;

      // --- SIMPLE ICON WRAPPER ---
      const IconWrapper = ({ children, className = "", size = 24 }) => (
        <span
          className={className}
          style={{ fontSize: size, display: "inline-flex", alignItems: "center", justifyContent: "center" }}
        >
          {children}
        </span>
      );

      const Home = (props) => <IconWrapper {...props}>üè†</IconWrapper>;
      const LogIn = (props) => <IconWrapper {...props}>üîë</IconWrapper>;
      const LogOut = (props) => <IconWrapper {...props}>üö™</IconWrapper>;
      const User = (props) => <IconWrapper {...props}>üë§</IconWrapper>;
      const BarChart2 = (props) => <IconWrapper {...props}>üìä</IconWrapper>;
      const Users = (props) => <IconWrapper {...props}>üë•</IconWrapper>;
      const Calendar = (props) => <IconWrapper {...props}>üìÖ</IconWrapper>;
      const FileText = (props) => <IconWrapper {...props}>üìÑ</IconWrapper>;
      const CheckCircle = (props) => <IconWrapper {...props}>‚úÖ</IconWrapper>;
      const XCircle = (props) => <IconWrapper {...props}>‚ùå</IconWrapper>;
      const MapPin = (props) => <IconWrapper {...props}>üìç</IconWrapper>;
      const Camera = (props) => <IconWrapper {...props}>üì∑</IconWrapper>;
      const ListChecks = (props) => <IconWrapper {...props}>‚úÖ</IconWrapper>;
      const ChevronLeft = (props) => <IconWrapper {...props}>‚óÄÔ∏è</IconWrapper>;
      const ChevronRight = (props) => <IconWrapper {...props}>‚ñ∂Ô∏è</IconWrapper>;
      const Plus = (props) => <IconWrapper {...props}>‚ûï</IconWrapper>;
      const Trash2 = (props) => <IconWrapper {...props}>üóëÔ∏è</IconWrapper>;
      const Edit = (props) => <IconWrapper {...props}>‚úèÔ∏è</IconWrapper>;
      const Clock = (props) => <IconWrapper {...props}>‚è∞</IconWrapper>;
      const AlertTriangle = (props) => <IconWrapper {...props}>‚ö†Ô∏è</IconWrapper>;
      const Coffee = (props) => <IconWrapper {...props}>‚òï</IconWrapper>;
      const ShieldCheck = (props) => <IconWrapper {...props}>üõ°Ô∏è</IconWrapper>;
      const Moon = (props) => <IconWrapper {...props}>üåô</IconWrapper>;
      const Sun = (props) => <IconWrapper {...props}>‚òÄÔ∏è</IconWrapper>;
      const Sunset = (props) => <IconWrapper {...props}>üåÜ</IconWrapper>;

      // --- THEME PAYBOSS ---
      const theme = {
        colors: {
          primary: "bg-stone-700",
          primaryHover: "hover:bg-stone-800",
          secondary: "bg-amber-800",
          secondaryHover: "hover:bg-amber-900",
          accent: "bg-green-700",
          accentHover: "hover:bg-green-800",
          background: "bg-stone-100",
          card: "bg-white",
          textPrimary: "text-stone-800",
          textSecondary: "text-stone-600",
          textLight: "text-white",
          border: "border-stone-200",
          danger: "bg-red-600",
          success: "bg-green-600",
        },
        rounding: {
          card: "rounded-2xl",
          button: "rounded-lg",
          input: "rounded-lg",
        },
      };

      // Lokasi PayBoss Cafe (Target GPS)
      const TARGET_LOCATION = {
        latitude: -2.1717657457047723,
        longitude: 115.4029877085838,
      };
      const GPS_RADIUS_METERS = 100;

      // URL Google Apps Script (ganti kalau URL deploy berubah)
      const GOOGLE_SHEET_WEBAPP_URL =
        "https://script.google.com/macros/s/AKfycbxOHwN1-GyfwWrQLucTf-X0Db_9HefScgxd5g2h35-ntTNyGQZ4NePhZ39OfeZqRvdM/exec";

      // --- DATA KARYAWAN (bisa diedit manual di sini, atau nanti dihubungkan ke Sheet lain) ---
      const initialDbKaryawan = [
        {
          id: "PB251101",
          nama: "Dayat",
          posisi: "Koordinator",
          password: "dayat123",
          fotoInisial: "D",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
        {
          id: "PB251102",
          nama: "Ilham Ali Naufal",
          posisi: "Pramusaji",
          password: "ilham123",
          fotoInisial: "IAN",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
        {
          id: "PB251104",
          nama: "Renita Aulia Jasmin",
          posisi: "Bartender",
          password: "renita123",
          fotoInisial: "RAJ",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
        {
          id: "PB251106",
          nama: "Bella",
          posisi: "Barista",
          password: "bella123",
          fotoInisial: "B",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
        {
          id: "PB251107",
          nama: "Rina",
          posisi: "Waitress",
          password: "rina123",
          fotoInisial: "R",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
        {
          id: "PB251108",
          nama: "Andi",
          posisi: "Pramusaji",
          password: "andi123",
          fotoInisial: "A",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
        {
          id: "PB251109",
          nama: "Yoga",
          posisi: "Chef",
          password: "yoga123",
          fotoInisial: "Y",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
        },
      ];

      // Jadwal roster contoh (boleh kamu sesuaikan lagi)
      const initialDbRoster = {
        PB251101: {
          "2025-11-16": "OFF",
          "2025-11-17": 1,
          "2025-11-18": 1,
          "2025-11-19": 1,
          "2025-11-20": 1,
          "2025-11-21": 1,
          "2025-11-22": 1,
        },
        PB251102: {
          "2025-11-16": 2,
          "2025-11-17": "OFF",
          "2025-11-18": 3,
          "2025-11-19": 3,
          "2025-11-20": 3,
          "2025-11-21": 3,
          "2025-11-22": 3,
        },
        PB251104: {
          "2025-11-16": 2,
          "2025-11-17": 2,
          "2025-11-18": "OFF",
          "2025-11-19": 2,
          "2025-11-20": 2,
          "2025-11-21": 2,
          "2025-11-22": 2,
        },
        PB251108: {
          "2025-11-16": 1,
          "2025-11-17": 1,
          "2025-11-18": 1,
          "2025-11-19": "OFF",
          "2025-11-20": 2,
          "2025-11-21": 2,
          "2025-11-22": 2,
        },
        PB251109: {
          "2025-11-16": 1,
          "2025-11-17": 1,
          "2025-11-18": 1,
          "2025-11-19": 1,
          "2025-11-20": "OFF",
          "2025-11-21": 1,
          "2025-11-22": "OFF",
        },
        PB251106: {
          "2025-11-16": 2,
          "2025-11-17": 2,
          "2025-11-18": "OFF",
          "2025-11-19": 2,
          "2025-11-20": 2,
          "2025-11-21": 2,
          "2025-11-22": 2,
        },
        PB251107: {
          "2025-11-16": 2,
          "2025-11-17": "OFF",
          "2025-11-18": 3,
          "2025-11-19": 3,
          "2025-11-20": 3,
          "2025-11-21": 3,
          "2025-11-22": 3,
        },
      };

      // Shift
      const shiftDetails = {
        1: { nama: "Pagi", ikon: Sun, waktu: "08:00 - 16:00", color: "text-blue-500" },
        2: { nama: "Siang", ikon: Sunset, waktu: "16:00 - 23:00", color: "text-orange-500" },
        3: { nama: "Malam", ikon: Moon, waktu: "23:00 - 08:00", color: "text-indigo-500" },
        OFF: { nama: "OFF", ikon: Home, waktu: "Libur", color: "text-gray-500" },
      };

      // Jobdesk per posisi
      const jobDeskByPosition = {
        "Koordinator": [
          "Memimpin briefing pagi tim FOH & BOH",
          "Memastikan ketersediaan stok (Bar & Kitchen)",
          "Menangani keluhan atau masukan tamu (service recovery)",
          "Membuat laporan closing harian",
          "Memastikan semua tim menjalankan SOP dengan baik",
        ],
        "Pramusaji": [
          "Menyambut tamu dan mengantarkan ke meja",
          "Mencatat pesanan dengan jelas di sistem/nota",
          "Menyajikan makanan & minuman ke tamu dengan sopan",
          "Membersihkan meja setelah tamu selesai",
          "Membantu menjaga kebersihan area dining",
        ],
        "Waitress": [
          "Menyambut tamu dengan ramah",
          "Menyajikan makanan & minuman ke tamu",
          "Melakukan pengecekan kepuasan tamu di meja",
          "Membersihkan meja dan area dining",
          "Membantu pramusaji lain jika sedang ramai",
        ],
        "Bartender": [
          "Menyiapkan minuman kopi & non-kopi sesuai resep",
          "Menjaga kebersihan area bar & peralatan",
          "Melakukan kalibrasi mesin espresso di awal shift",
          "Mencatat kebutuhan restock bahan minuman",
          "Menyajikan minuman dengan presentasi yang menarik",
        ],
        "Barista": [
          "Menyiapkan minuman kopi & signature drink",
          "Menjaga stok biji kopi & bahan minuman",
          "Membersihkan mesin kopi setelah digunakan",
          "Mencatat bahan yang perlu restock",
          "Membantu FOH saat kondisi ramai",
        ],
        "Chef": [
          "Persiapan 'mise en place' bahan baku kitchen",
          "Memasak pesanan sesuai SOP dan urutan (FIFO)",
          "Menjaga kualitas rasa dan presentasi hidangan",
          "Memastikan kebersihan area kitchen",
          "Melakukan stok opname harian bahan baku kitchen",
        ],
      };

      // --- UTILITAS WAKTU & JARAK ---
      function getHaversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // meter
        const œÜ1 = (lat1 * Math.PI) / 180;
        const œÜ2 = (lat2 * Math.PI) / 180;
        const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180;
        const ŒîŒª = ((lon2 - lon1) * Math.PI) / 180;

        const a =
          Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
          Math.cos(œÜ1) * Math.cos(œÜ2) *
            Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c; // dalam meter
      }

      function formatDateYYYYMMDD(date) {
        return date.toISOString().split("T")[0];
      }

      function formatShortDate(date) {
        return date.toLocaleDateString("id-ID", {
          weekday: "long",
          day: "numeric",
          month: "short",
        });
      }

      function formatTime(date) {
        if (!date) return "-";
        return date.toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      function buildJobdeskForPosition(posisi) {
        const tasks = jobDeskByPosition[posisi] || [];
        return tasks.map((label, idx) => ({
          id: idx + 1,
          label,
          completed: false,
        }));
      }

      // --- FUNGSI KONEKSI GOOGLE SHEET ---

      // Kirim data absensi ke Google Sheet
      async function kirimAbsensiKeSheet({ user, jenis, data, shiftName }) {
        try {
          const now = new Date();
          const todayYMD = formatDateYYYYMMDD(now);

          const payload = {
            action: "appendAbsensi",
            timestamp: now.toISOString(),
            tanggal: todayYMD,
            jenis, // "checkIn" / "checkOut"
            idKaryawan: user.id,
            namaKaryawan: user.nama,
            posisi: user.posisi,
            shift: shiftName,
            waktu: data.waktu ? data.waktu.toISOString() : now.toISOString(),
            lat: data.lat || "",
            lng: data.lng || "",
            jarak: data.jarak || "",
            alasanLuarArea: data.alasanLuarArea || "",
          };

          await fetch(GOOGLE_SHEET_WEBAPP_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
            mode: "no-cors", // biar nggak error CORS di browser
          });
        } catch (err) {
          console.error("Gagal mengirim data ke Google Sheet", err);
        }
      }

      // Helper untuk mengelompokkan baris absensi dari Sheet
      function groupAbsensiRows(rows) {
        const map = new Map();

        rows.forEach((row) => {
          const key = `${row.idKaryawan}|${row.tanggal}`;
          let record = map.get(key);
          if (!record) {
            record = {
              idKaryawan: row.idKaryawan,
              namaKaryawan: row.namaKaryawan,
              posisi: row.posisi,
              tanggal: row.tanggal,
              shift: row.shift || "",
              checkIn: null,
              checkOut: null,
              jobDeskProgress: buildJobdeskForPosition(row.posisi),
              status: "",
            };
            map.set(key, record);
          }

          const waktuDate = row.waktu
            ? new Date(row.waktu)
            : row.timestamp
            ? new Date(row.timestamp)
            : null;

          const baseObj = {
            waktu: waktuDate,
            alasanLuarArea: row.alasanLuarArea || null,
            lat: row.lat !== "" && row.lat != null ? Number(row.lat) : null,
            lng: row.lng !== "" && row.lng != null ? Number(row.lng) : null,
            jarak: row.jarak !== "" && row.jarak != null ? Number(row.jarak) : null,
          };

          if (row.jenis === "checkIn") {
            record.checkIn = baseObj;
          } else if (row.jenis === "checkOut") {
            record.checkOut = baseObj;
          }
        });

        // opsional set status
        map.forEach((rec) => {
          if (rec.checkIn && rec.checkOut) rec.status = "Hadir (Lengkap)";
          else if (rec.checkIn && !rec.checkOut) rec.status = "Hadir (Belum Check-out)";
          else if (!rec.checkIn && rec.checkOut) rec.status = "Check-out Tanpa Check-in";
          else rec.status = "";
        });

        return Array.from(map.values());
      }

      // Baca data absensi dari Google Sheet
      async function loadAbsensiDariSheet() {
        try {
          const res = await fetch(
            GOOGLE_SHEET_WEBAPP_URL + "?action=getAbsensi"
          );
          if (!res.ok) throw new Error("Response tidak OK");
          const json = await res.json();
          if (!json || !Array.isArray(json.data)) return [];

          return groupAbsensiRows(json.data);
        } catch (err) {
          console.error("Gagal load absensi dari Google Sheet", err);
          return [];
        }
      }

      // --- KOMPONEN SHARED ---

      const Modal = ({ children, onClose, title }) => (
        <AnimatePresence>
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 p-4"
            onClick={onClose}
          >
            <motion.div
              initial={{ scale: 0.9, y: 20 }}
              animate={{ scale: 1, y: 0 }}
              exit={{ scale: 0.9, y: 20 }}
              className={`relative w-full max-w-lg overflow-hidden ${theme.colors.card} ${theme.rounding.card} shadow-2xl`}
              onClick={(e) => e.stopPropagation()}
            >
              <div
                className={`flex items-center justify-between p-5 ${theme.colors.border} border-b`}
              >
                <h3 className={`text-xl font-bold ${theme.colors.textPrimary}`}>
                  {title}
                </h3>
                <button
                  onClick={onClose}
                  className={`${theme.colors.textSecondary || "text-stone-600"} hover:text-red-500`}
                >
                  <XCircle size={24} />
                </button>
              </div>
              <div className="p-6">{children}</div>
            </motion.div>
          </motion.div>
        </AnimatePresence>
      );

      const Button = ({
        onClick,
        children,
        variant = "primary",
        disabled = false,
        className = "",
        type = "button",
      }) => {
        const variants = {
          primary: `${theme.colors.primary} ${theme.colors.textLight} ${theme.colors.primaryHover}`,
          secondary: `${theme.colors.secondary} ${theme.colors.textLight} ${theme.colors.secondaryHover}`,
          accent: `${theme.colors.accent} ${theme.colors.textLight} ${theme.colors.accentHover}`,
          danger: `${theme.colors.danger} ${theme.colors.textLight} hover:bg-red-700`,
          light: `${theme.colors.background} ${theme.colors.textPrimary} hover:bg-stone-200`,
        };

        return (
          <button
            type={type}
            onClick={onClick}
            disabled={disabled}
            className={`flex w-full items-center justify-center gap-2 p-3 font-semibold ${theme.rounding.button} transition-all duration-200 ${variants[variant]} ${
              disabled ? "opacity-50 cursor-not-allowed" : ""
            } ${className}`}
          >
            {children}
          </button>
        );
      };

      const Input = ({
        type = "text",
        placeholder,
        value,
        onChange,
        icon,
        className = "",
        ...rest
      }) => (
        <div className="relative w-full">
          {icon && (
            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400">
              {icon}
            </div>
          )}
          <input
            type={type}
            placeholder={placeholder}
            value={value}
            onChange={onChange}
            {...rest}
            className={`w-full ${theme.colors.background} ${theme.rounding.input} ${
              theme.colors.textPrimary
            } border ${theme.colors.border} p-3 ${
              icon ? "pl-10" : ""
            } focus:outline-none focus:ring-2 focus:ring-amber-800 ${className}`}
          />
        </div>
      );

      const Spinner = ({ size = 24 }) => (
        <motion.div
          animate={{ rotate: 360 }}
          transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
          className="border-t-transparent border-solid rounded-full border-stone-700 border-2"
          style={{ width: size, height: size }}
        />
      );

      const ProgressBar = ({ value, max }) => {
        const percent = max > 0 ? (value / max) * 100 : 0;
        return (
          <div
            className={`w-full ${theme.colors.background} ${theme.rounding.button} overflow-hidden`}
          >
            <motion.div
              className={`${theme.colors.accent} h-2`}
              initial={{ width: 0 }}
              animate={{ width: `${percent}%` }}
              transition={{ duration: 0.5, ease: "easeInOut" }}
            />
          </div>
        );
      };

      // --- MODAL ABSENSI (Selfie + GPS) ---

      const AttendanceFlow = ({ user, type, onClose, onComplete, todayShift }) => {
        const [step, setStep] = useState("camera");
        const [selfie, setSelfie] = useState(null);
        const [locationData, setLocationData] = useState(null);
        const [inArea, setInArea] = useState(false);
        const [distance, setDistance] = useState(0);
        const [error, setError] = useState(null);
        const [cameraSupported, setCameraSupported] = useState(true);

        const [reason, setReason] = useState("");
        const reasons = ["Sakit", "Izin", "Dinas Luar", "Lainnya"];

        const webcamRef = useRef(null);
        const streamRef = useRef(null);

        useEffect(() => {
          if (step === "camera") {
            const startCamera = async () => {
              try {
                if (
                  typeof navigator === "undefined" ||
                  !navigator.mediaDevices ||
                  !navigator.mediaDevices.getUserMedia
                ) {
                  setCameraSupported(false);
                  setError(
                    "Kamera tidak didukung di browser/lingkungan ini. Anda bisa melanjutkan tanpa selfie."
                  );
                  return;
                }

                setCameraSupported(true);
                const stream = await navigator.mediaDevices.getUserMedia({
                  video: { facingMode: "user" },
                  audio: false,
                });
                if (webcamRef.current) {
                  webcamRef.current.srcObject = stream;
                  webcamRef.current.play();
                  streamRef.current = stream;
                }
              } catch (err) {
                console.error("Error accessing webcam:", err);
                setCameraSupported(false);
                setError(
                  "Gagal mengakses kamera. Periksa izin kamera Anda, atau lanjutkan tanpa selfie."
                );
              }
            };
            startCamera();
          }

          return () => {
            if (streamRef.current) {
              streamRef.current.getTracks().forEach((track) => track.stop());
              streamRef.current = null;
            }
          };
        }, [step]);

        const captureSelfie = useCallback(() => {
          if (!webcamRef.current || !cameraSupported) {
            setError(
              "Kamera belum siap atau tidak didukung. Anda bisa menekan tombol 'Lewati Selfie'."
            );
            return;
          }

          const video = webcamRef.current;
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;

          const ctx = canvas.getContext("2d");
          if (!ctx) {
            setError("Gagal memproses gambar.");
            return;
          }

          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageSrc = canvas.toDataURL("image/jpeg");

          if (!imageSrc) {
            setError("Gagal mengambil foto. Coba lagi.");
            return;
          }
          setSelfie(imageSrc);
          setStep("location");

          if (streamRef.current) {
            streamRef.current.getTracks().forEach((track) => track.stop());
            streamRef.current = null;
          }
        }, [cameraSupported]);

        const continueWithoutSelfie = () => {
          setSelfie(null);
          setError(null);
          setStep("location");

          if (streamRef.current) {
            streamRef.current.getTracks().forEach((track) => track.stop());
            streamRef.current = null;
          }
        };

        useEffect(() => {
          if (step === "location") {
            setError(null);
            if (!navigator.geolocation) {
              setError("Browser Anda tidak mendukung Geolocation.");
              setStep("confirm");
              return;
            }

            navigator.geolocation.getCurrentPosition(
              (position) => {
                const { latitude, longitude } = position.coords;
                const dist = getHaversineDistance(
                  latitude,
                  longitude,
                  TARGET_LOCATION.latitude,
                  TARGET_LOCATION.longitude
                );

                setLocationData({ latitude, longitude });
                setDistance(dist);

                if (dist <= GPS_RADIUS_METERS) {
                  setInArea(true);
                  setStep("confirm");
                } else {
                  setInArea(false);
                  setStep("reason");
                }
              },
              (err) => {
                let errMsg = "Gagal mendapatkan lokasi. ";
                if (err.code === 1)
                  errMsg += "Pastikan Anda mengizinkan akses lokasi.";
                if (err.code === 2) errMsg += "Sinyal lokasi tidak tersedia.";
                if (err.code === 3) errMsg += "Waktu tunggu habis.";
                setError(errMsg);
                setStep("confirm");
              },
              { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
          }
        }, [step]);

        const handleSubmit = async () => {
          setStep("loading");

          const attendanceData = {
            waktu: new Date(),
            fotoBase64: selfie,
            lat: locationData?.latitude,
            lng: locationData?.longitude,
            alasanLuarArea: inArea ? null : reason,
            jarak: distance,
          };

          try {
            await kirimAbsensiKeSheet({
              user,
              jenis: type,
              data: attendanceData,
              shiftName: todayShift?.nama || "",
            });
          } catch (e) {
            console.error(e);
          }

          onComplete(attendanceData);
          setStep("success");
        };

        const title = type === "checkIn" ? "Absen Check-in" : "Absen Check-out";

        const renderStep = () => {
          switch (step) {
            case "camera":
              return (
                <div className="text-center">
                  <p className={`${theme.colors.textSecondary} mb-4`}>
                    Posisikan wajah Anda di dalam frame dan ambil selfie untuk
                    verifikasi. Jika kamera tidak berfungsi, Anda tetap bisa
                    lanjut tanpa selfie.
                  </p>
                  {cameraSupported && (
                    <div
                      className={`w-full overflow-hidden ${theme.rounding.card} border-2 ${theme.colors.border} shadow-inner bg-black`}
                    >
                      <video
                        ref={webcamRef}
                        autoPlay
                        playsInline
                        muted
                        className="w-full h-auto"
                        style={{ transform: "scaleX(-1)" }}
                      />
                    </div>
                  )}
                  {error && (
                    <p className="text-red-500 text-sm mt-2">{error}</p>
                  )}
                  <div className="flex flex-col sm:flex-row gap-3 mt-4">
                    <Button
                      onClick={captureSelfie}
                      variant="secondary"
                      className="sm:flex-1"
                      disabled={!cameraSupported}
                    >
                      <Camera size={20} /> Ambil Foto
                    </Button>
                    <Button
                      onClick={continueWithoutSelfie}
                      variant="light"
                      className="sm:flex-1"
                    >
                      Lewati Selfie
                    </Button>
                  </div>
                </div>
              );

            case "location":
              return (
                <div className="flex flex-col items-center justify-center h-48">
                  <Spinner size={40} />
                  <p
                    className={`${theme.colors.textPrimary} mt-4 font-semibold`}
                  >
                    Mendeteksi lokasi Anda...
                  </p>
                  <p className={`${theme.colors.textSecondary} text-sm`}>
                    Pastikan GPS dan izin lokasi aktif.
                  </p>
                </div>
              );

            case "reason":
              return (
                <div>
                  <div
                    className={`flex items-center gap-3 p-4 ${theme.rounding.button} bg-yellow-100 border border-yellow-300 text-yellow-800`}
                  >
                    <AlertTriangle size={24} />
                    <div>
                      <h4 className="font-bold">Anda Berada di Luar Area!</h4>
                      <p className="text-sm">
                        Jarak Anda: {distance.toFixed(0)} meter dari PayBoss
                        Cafe.
                      </p>
                    </div>
                  </div>
                  <p
                    className={`${theme.colors.textSecondary} mt-4 mb-3`}
                  >
                    Harap pilih alasan Anda absen di luar area kerja:
                  </p>
                  <div className="space-y-2">
                    {reasons.map((r) => (
                      <label
                        key={r}
                        className={`flex items-center w-full p-3 ${
                          theme.rounding.input
                        } ${theme.colors.background} border ${
                          reason === r
                            ? "border-amber-800 ring-2 ring-amber-800"
                            : theme.colors.border
                        } cursor-pointer`}
                      >
                        <input
                          type="radio"
                          name="reason"
                          value={r}
                          checked={reason === r}
                          onChange={(e) => setReason(e.target.value)}
                          className="mr-3"
                        />
                        {r}
                      </label>
                    ))}
                  </div>
                  <Button
                    onClick={() => setStep("confirm")}
                    disabled={!reason}
                    className="mt-4"
                  >
                    Lanjutkan
                  </Button>
                </div>
              );

            case "confirm":
              return (
                <div>
                  <p className={`${theme.colors.textSecondary} mb-4`}>
                    Harap konfirmasi data{" "}
                    {type === "checkIn" ? "check-in" : "check-out"} Anda.
                  </p>
                  <div className="space-y-4">
                    <div className="flex items-center gap-4">
                      {selfie && (
                        <img
                          src={selfie}
                          alt="Selfie"
                          className={`w-24 h-24 object-cover ${theme.rounding.card} border-2 ${theme.colors.border}`}
                        />
                      )}
                      <div>
                        <h4 className="font-bold">{user.nama}</h4>
                        <p className={theme.colors.textSecondary}>{user.posisi}</p>
                        <p className={theme.colors.textSecondary}>
                          {formatTime(new Date())}
                        </p>
                      </div>
                    </div>
                    <div
                      className={`p-3 ${theme.rounding.input} ${theme.colors.background}`}
                    >
                      <h5 className="font-semibold flex items-center gap-2">
                        <MapPin
                          size={16}
                          className={
                            inArea ? "text-green-600" : "text-red-600"
                          }
                        />
                        Status Lokasi
                      </h5>
                      {locationData ? (
                        inArea ? (
                          <p className="text-green-600 text-sm font-medium">
                            Dalam Area PayBoss Cafe (¬±{distance.toFixed(0)}m).
                          </p>
                        ) : (
                          <p className="text-red-600 text-sm font-medium">
                            Di Luar Area PayBoss Cafe (¬±{distance.toFixed(0)}m).
                          </p>
                        )
                      ) : (
                        <p className="text-yellow-600 text-sm font-medium">
                          Gagal mendapatkan data lokasi.
                        </p>
                      )}
                      {reason && (
                        <p className="text-sm text-yellow-800 mt-1">
                          <b>Alasan:</b> {reason}
                        </p>
                      )}
                    </div>
                    {error && (
                      <p className="text-red-500 text-sm -mt-2">{error}</p>
                    )}
                  </div>
                  <Button
                    onClick={handleSubmit}
                    variant="accent"
                    className="mt-6"
                  >
                    <CheckCircle size={20} /> Konfirmasi{" "}
                    {type === "checkIn" ? "Check-in" : "Check-out"}
                  </Button>
                </div>
              );

            case "loading":
              return (
                <div className="flex flex-col items-center justify-center h-48">
                  <Spinner size={40} />
                  <p
                    className={`${theme.colors.textPrimary} mt-4 font-semibold`}
                  >
                    Menyimpan data absensi...
                  </p>
                </div>
              );

            case "success":
              return (
                <div className="flex flex-col items-center justify-center h-48 text-center">
                  <motion.div
                    initial={{ scale: 0.5 }}
                    animate={{ scale: 1 }}
                    transition={{ type: "spring", damping: 10, stiffness: 150 }}
                  >
                    <CheckCircle size={60} className="text-green-600" />
                  </motion.div>
                  <h3 className="text-2xl font-bold mt-4">Berhasil!</h3>
                  <p className={theme.colors.textSecondary}>
                    Absen {type === "checkIn" ? "check-in" : "check-out"} Anda
                    telah dicatat.
                  </p>
                  <Button onClick={onClose} className="mt-6 w-32">
                    Selesai
                  </Button>
                </div>
              );

            default:
              return null;
          }
        };

        return (
          <Modal title={title} onClose={onClose}>
            {renderStep()}
          </Modal>
        );
      };

      // --- KOMPONEN KARYAWAN HOME ---

      const KaryawanHome = ({
        user,
        dbAbsensi,
        dbRoster,
        onNavigate,
        onShowModal,
      }) => {
        const [todayRecord, setTodayRecord] = useState(null);
        const [todayShift, setTodayShift] = useState(null);
        const [greeting, setGreeting] = useState("");

        useEffect(() => {
          const todayStr = formatDateYYYYMMDD(new Date());
          const record = dbAbsensi.find(
            (a) => a.idKaryawan === user.id && a.tanggal === todayStr
          );
          setTodayRecord(record);

          const shiftCode = dbRoster[user.id]?.[todayStr] ?? "OFF";
          setTodayShift(shiftDetails[shiftCode] || shiftDetails["OFF"]);

          const hour = new Date().getHours();
          if (hour < 11) setGreeting("Selamat Pagi");
          else if (hour < 15) setGreeting("Selamat Siang");
          else if (hour < 19) setGreeting("Selamat Sore");
          else setGreeting("Selamat Malam");
        }, [dbAbsensi, user.id, dbRoster]);

        if (!todayShift) {
          return (
            <div className="flex items-center justify-center h-screen">
              <Spinner size={40} />
            </div>
          );
        }

        const handleAttendance = (type) => {
          onShowModal(type, todayShift);
        };

        const isCheckedIn = todayRecord && todayRecord.checkIn;
        const isCheckedOut = todayRecord && todayRecord.checkOut;
        const isOff = todayShift.nama === "OFF";

        let jobProgress = 0;
        let jobTotal = 0;
        if (todayRecord && todayRecord.jobDeskProgress) {
          jobTotal = todayRecord.jobDeskProgress.length;
          jobProgress = todayRecord.jobDeskProgress.filter((t) => t.completed)
            .length;
        }

        const todayDate = new Date(formatDateYYYYMMDD(new Date()) + "T00:00:00");

        return (
          <div className="p-4 space-y-6 pb-24">
            {/* Header salam + profil ringkas */}
            <div
              className={`p-6 ${theme.colors.primary} ${theme.rounding.card} shadow-lg text-white flex items-center justify-between gap-4`}
            >
              <div>
                <p className="text-lg font-light">{greeting},</p>
                <h2 className="text-3xl font-bold">{user.nama}</h2>
                <p className="text-stone-300 mt-1">{user.posisi}</p>
                <p className="text-stone-300 text-sm mt-1">
                  ID: {user.id}
                </p>
              </div>
              <div className="flex items-center gap-3">
                <div className="w-16 h-16 rounded-full bg-amber-500 flex items-center justify-center text-2xl font-bold">
                  {user.fotoInisial || user.nama.charAt(0)}
                </div>
              </div>
            </div>

            {/* Kartu absensi hari ini */}
            <div
              className={`p-6 ${theme.colors.card} ${theme.rounding.card} shadow-md`}
            >
              <h3
                className={`text-xl font-bold mb-4 ${theme.colors.textPrimary}`}
              >
                Absensi Hari Ini
              </h3>
              <p className={`${theme.colors.textSecondary} mb-1`}>
                {formatShortDate(todayDate)}
              </p>

              {isOff ? (
                <div className="text-center p-6 bg-stone-100 rounded-lg">
                  <Home size={32} className="mx-auto text-stone-500 mb-2" />
                  <h4 className="text-lg font-bold">Hari Libur</h4>
                  <p className={theme.colors.textSecondary}>
                    Nikmati waktu istirahat Anda.
                  </p>
                </div>
              ) : (
                <div className="space-y-4">
                  {isCheckedIn ? (
                    <div className="flex items-center justify-between p-4 bg-green-50 border border-green-200 rounded-lg">
                      <div className="flex items-center gap-3">
                        <CheckCircle size={24} className="text-green-600" />
                        <div>
                          <span className="font-bold text-green-700">
                            Check-in Berhasil
                          </span>
                          <p className="text-sm text-green-600">
                            pukul {formatTime(todayRecord.checkIn.waktu)}
                          </p>
                        </div>
                      </div>
                      {todayRecord.checkIn.alasanLuarArea && (
                        <AlertTriangle
                          size={20}
                          className="text-yellow-500"
                          title={`Absen di luar area: ${todayRecord.checkIn.alasanLuarArea}`}
                        />
                      )}
                    </div>
                  ) : (
                    <Button onClick={() => handleAttendance("checkIn")}>
                      <LogIn size={20} /> Check-in
                    </Button>
                  )}

                  {isCheckedIn && (
                    isCheckedOut ? (
                      <div className="flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div className="flex items-center gap-3">
                          <CheckCircle size={24} className="text-blue-600" />
                          <div>
                            <span className="font-bold text-blue-700">
                              Check-out Berhasil
                            </span>
                            <p className="text-sm text-blue-600">
                              pukul {formatTime(todayRecord.checkOut.waktu)}
                            </p>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <Button
                        onClick={() => handleAttendance("checkOut")}
                        variant="secondary"
                      >
                        <LogOut size={20} /> Check-out
                      </Button>
                    )
                  )}
                </div>
              )}
            </div>

            {/* Shift dan jobdesk */}
            {!isOff && (
              <div
                className={`p-6 ${theme.colors.card} ${theme.rounding.card} shadow-md space-y-4`}
              >
                <div>
                  <h4 className="text-lg font-bold flex items-center gap-2">
                    <Coffee size={20} className={todayShift.color} /> Shift
                    Anda
                  </h4>
                  <p className={`${theme.colors.textSecondary} text-lg`}>
                    {todayShift.nama} ({todayShift.waktu})
                  </p>
                </div>

                <div>
                  <h4 className="text-lg font-bold flex items-center gap-2 mb-2">
                    <ListChecks size={20} className="text-stone-700" />
                    Progres Job Desk
                  </h4>
                  <ProgressBar value={jobProgress} max={jobTotal} />
                  <p className={`${theme.colors.textSecondary} text-sm mt-2`}>
                    {jobTotal === 0
                      ? "Belum ada jobdesk untuk hari ini."
                      : `${jobProgress} dari ${jobTotal} tugas selesai.`}
                  </p>
                  <Button
                    onClick={() => onNavigate("jobdesk")}
                    variant="light"
                    className="mt-3"
                  >
                    <ListChecks size={18} /> Lihat & Update Job Desk
                  </Button>
                </div>
              </div>
            )}

            {/* Tombol riwayat */}
            <div className="flex gap-3">
              <Button
                variant="light"
                onClick={() => onNavigate("riwayat")}
                className="flex-1"
              >
                <Calendar size={18} /> Riwayat Absensi
              </Button>
            </div>
          </div>
        );
      };

      // --- HALAMAN JOBDESK KARYAWAN ---

      const JobdeskPage = ({ user, dbAbsensi, setDbAbsensi, onBack }) => {
        const todayStr = formatDateYYYYMMDD(new Date());

        // Pastikan record hari ini punya jobdesk
        useEffect(() => {
          setDbAbsensi((prev) => {
            const idx = prev.findIndex(
              (r) => r.idKaryawan === user.id && r.tanggal === todayStr
            );
            const tasksTemplate = buildJobdeskForPosition(user.posisi);

            // kalau tidak ada jobdesk template, biarkan saja
            if (tasksTemplate.length === 0) return prev;

            if (idx >= 0) {
              const rec = prev[idx];
              if (rec.jobDeskProgress && rec.jobDeskProgress.length > 0) {
                return prev;
              }
              const updated = { ...rec, jobDeskProgress: tasksTemplate };
              const arr = [...prev];
              arr[idx] = updated;
              return arr;
            } else {
              // belum ada record absensi, tapi kita buat record khusus jobdesk
              const newRec = {
                idKaryawan: user.id,
                namaKaryawan: user.nama,
                posisi: user.posisi,
                tanggal: todayStr,
                shift: "",
                checkIn: null,
                checkOut: null,
                jobDeskProgress: tasksTemplate,
                status: "",
              };
              return [...prev, newRec];
            }
          });
        }, [user, setDbAbsensi, todayStr]);

        const record =
          dbAbsensi.find(
            (r) => r.idKaryawan === user.id && r.tanggal === todayStr
          ) || null;

        const jobdesk = record?.jobDeskProgress || [];

        const toggleTask = (taskId) => {
          setDbAbsensi((prev) => {
            const idx = prev.findIndex(
              (r) => r.idKaryawan === user.id && r.tanggal === todayStr
            );
            if (idx < 0) return prev;
            const rec = prev[idx];
            const updatedTasks = (rec.jobDeskProgress || []).map((t) =>
              t.id === taskId ? { ...t, completed: !t.completed } : t
            );
            const updated = { ...rec, jobDeskProgress: updatedTasks };
            const arr = [...prev];
            arr[idx] = updated;
            return arr;
          });
        };

        const completedCount = jobdesk.filter((t) => t.completed).length;

        return (
          <div className="p-4 space-y-4 pb-24">
            <div className="flex items-center gap-2 mb-2">
              <button
                onClick={onBack}
                className="p-2 rounded-full bg-stone-200 hover:bg-stone-300"
              >
                <ChevronLeft size={20} />
              </button>
              <h2 className="text-xl font-bold">Job Desk Hari Ini</h2>
            </div>

            <div
              className={`p-4 ${theme.colors.card} ${theme.rounding.card} shadow-md`}
            >
              <p className={`${theme.colors.textSecondary} mb-1`}>
                {formatShortDate(new Date(todayStr + "T00:00:00"))}
              </p>
              <h3 className="text-lg font-bold mb-3">
                {user.nama} ‚Äì {user.posisi}
              </h3>

              {jobdesk.length === 0 ? (
                <p className={theme.colors.textSecondary}>
                  Belum ada jobdesk yang terdaftar untuk posisi ini.
                </p>
              ) : (
                <>
                  <p className={`${theme.colors.textSecondary} mb-2 text-sm`}>
                    {completedCount} dari {jobdesk.length} tugas selesai.
                  </p>
                  <ProgressBar value={completedCount} max={jobdesk.length} />
                  <div className="mt-4 space-y-2">
                    {jobdesk.map((task) => (
                      <label
                        key={task.id}
                        className={`flex items-start gap-3 p-3 rounded-xl border ${
                          task.completed
                            ? "border-green-500 bg-green-50"
                            : "border-stone-200 bg-stone-50"
                        } cursor-pointer`}
                      >
                        <input
                          type="checkbox"
                          className="mt-1"
                          checked={task.completed}
                          onChange={() => toggleTask(task.id)}
                        />
                        <span
                          className={
                            task.completed
                              ? "line-through text-stone-500"
                              : theme.colors.textPrimary
                          }
                        >
                          {task.label}
                        </span>
                      </label>
                    ))}
                  </div>
                </>
              )}
            </div>
          </div>
        );
      };

      // --- RIWAYAT ABSENSI KARYAWAN ---

      const RiwayatKaryawan = ({ user, dbAbsensi, onBack }) => {
        const records = dbAbsensi
          .filter((r) => r.idKaryawan === user.id)
          .sort((a, b) => (a.tanggal < b.tanggal ? 1 : -1))
          .slice(0, 30);

        return (
          <div className="p-4 space-y-4 pb-24">
            <div className="flex items-center gap-2 mb-2">
              <button
                onClick={onBack}
                className="p-2 rounded-full bg-stone-200 hover:bg-stone-300"
              >
                <ChevronLeft size={20} />
              </button>
              <h2 className="text-xl font-bold flex items-center gap-2">
                <Calendar size={20} /> Riwayat Absensi
              </h2>
            </div>

            {records.length === 0 ? (
              <p className={theme.colors.textSecondary}>
                Belum ada data absensi yang tercatat.
              </p>
            ) : (
              <div className="space-y-3">
                {records.map((rec, idx) => (
                  <div
                    key={idx}
                    className={`p-4 ${theme.colors.card} ${theme.rounding.card} shadow-sm border ${theme.colors.border}`}
                  >
                    <div className="flex justify-between items-center mb-2">
                      <div>
                        <p className="font-semibold">
                          {formatShortDate(new Date(rec.tanggal + "T00:00:00"))}
                        </p>
                        <p className="text-xs text-stone-500">
                          Shift: {rec.shift || "-"}
                        </p>
                      </div>
                      <span className="text-xs px-2 py-1 rounded-full bg-stone-100 text-stone-600">
                        {rec.status || "‚Äì"}
                      </span>
                    </div>
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      <div className="flex flex-col">
                        <span className="text-stone-400">Check-in</span>
                        <span className="font-medium">
                          {rec.checkIn ? formatTime(rec.checkIn.waktu) : "-"}
                        </span>
                      </div>
                      <div className="flex flex-col">
                        <span className="text-stone-400">Check-out</span>
                        <span className="font-medium">
                          {rec.checkOut ? formatTime(rec.checkOut.waktu) : "-"}
                        </span>
                      </div>
                    </div>
                    {rec.checkIn && rec.checkIn.alasanLuarArea && (
                      <p className="mt-2 text-xs text-yellow-800">
                        Absen luar area: {rec.checkIn.alasanLuarArea}
                      </p>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      };

      // --- DASHBOARD MANAGER (hari ini) ---

      const ManagerDashboard = ({ dbAbsensi, dbKaryawan, onRefresh, loadingAbsensi }) => {
        const todayStr = formatDateYYYYMMDD(new Date());

        const mapAbsensi = new Map();
        dbAbsensi
          .filter((r) => r.tanggal === todayStr)
          .forEach((r) => {
            mapAbsensi.set(r.idKaryawan, r);
          });

        const rows = dbKaryawan.map((k) => {
          const rec = mapAbsensi.get(k.id) || null;
          return { karyawan: k, record: rec };
        });

        return (
          <div className="p-4 space-y-4 pb-24">
            <div className="flex justify-between items-center mb-2">
              <h2 className="text-xl font-bold flex items-center gap-2">
                <BarChart2 size={20} /> Dashboard Absensi ‚Äì Hari Ini
              </h2>
              <button
                onClick={onRefresh}
                className="flex items-center gap-2 px-3 py-2 rounded-lg bg-stone-200 hover:bg-stone-300 text-sm"
              >
                {loadingAbsensi ? (
                  <>
                    <Spinner size={16} /> Memuat...
                  </>
                ) : (
                  <>
                    üîÑ Refresh
                  </>
                )}
              </button>
            </div>
            <p className={`${theme.colors.textSecondary} mb-2`}>
              Tanggal: {formatShortDate(new Date(todayStr + "T00:00:00"))}
            </p>

            <div className="overflow-x-auto">
              <table className="min-w-full text-sm border-collapse">
                <thead>
                  <tr className="bg-stone-200 text-stone-800">
                    <th className="px-3 py-2 text-left">Karyawan</th>
                    <th className="px-3 py-2 text-left">Posisi</th>
                    <th className="px-3 py-2 text-left">Check-in</th>
                    <th className="px-3 py-2 text-left">Check-out</th>
                    <th className="px-3 py-2 text-left">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {rows.map(({ karyawan, record }) => (
                    <tr
                      key={karyawan.id}
                      className="border-b border-stone-100 hover:bg-stone-50"
                    >
                      <td className="px-3 py-2">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center text-xs font-bold text-white">
                            {karyawan.fotoInisial || karyawan.nama.charAt(0)}
                          </div>
                          <div>
                            <div className="font-semibold">{karyawan.nama}</div>
                            <div className="text-xs text-stone-400">
                              ID: {karyawan.id}
                            </div>
                          </div>
                        </div>
                      </td>
                      <td className="px-3 py-2 text-stone-700">
                        {karyawan.posisi}
                      </td>
                      <td className="px-3 py-2">
                        {record && record.checkIn ? (
                          <span className="inline-flex items-center gap-1 text-green-700">
                            <CheckCircle size={14} />{" "}
                            {formatTime(record.checkIn.waktu)}
                          </span>
                        ) : (
                          <span className="text-xs text-stone-400">Belum</span>
                        )}
                      </td>
                      <td className="px-3 py-2">
                        {record && record.checkOut ? (
                          <span className="inline-flex items-center gap-1 text-blue-700">
                            <CheckCircle size={14} />{" "}
                            {formatTime(record.checkOut.waktu)}
                          </span>
                        ) : (
                          <span className="text-xs text-stone-400">Belum</span>
                        )}
                      </td>
                      <td className="px-3 py-2">
                        {record ? (
                          <span className="text-xs px-2 py-1 rounded-full bg-green-50 text-green-700 border border-green-100">
                            {record.status || "Hadir"}
                          </span>
                        ) : (
                          <span className="text-xs px-2 py-1 rounded-full bg-red-50 text-red-600 border border-red-100">
                            Belum Absen
                          </span>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      };

      // --- DATA KARYAWAN (MANAGER VIEW SEDERHANA) ---

      const DataKaryawanPage = ({ dbKaryawan }) => {
        return (
          <div className="p-4 space-y-4 pb-24">
            <h2 className="text-xl font-bold flex items-center gap-2">
              <Users size={20} /> Data Karyawan PayBoss
            </h2>
            <p className={theme.colors.textSecondary}>
              (Versi sederhana, data master di-edit dari Google Sheet dulu. Nanti bisa dikembangkan untuk edit/hapus lewat web app.)
            </p>
            <div className="space-y-3 mt-2">
              {dbKaryawan.map((k) => (
                <div
                  key={k.id}
                  className={`p-4 ${theme.colors.card} ${theme.rounding.card} shadow-sm border ${theme.colors.border} flex items-center gap-3`}
                >
                  <div className="w-12 h-12 rounded-full bg-amber-500 flex items-center justify-center text-lg font-bold text-white">
                    {k.fotoInisial || k.nama.charAt(0)}
                  </div>
                  <div className="flex-1">
                    <div className="font-semibold text-stone-800">
                      {k.nama}
                    </div>
                    <div className="text-xs text-stone-500">
                      ID: {k.id} ¬∑ {k.posisi}
                    </div>
                    {k.noWhatsapp && (
                      <div className="text-xs text-stone-500 mt-1">
                        WA: {k.noWhatsapp}
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      };

      // --- LOGIN PAGE ---

      const LoginPage = ({ onLoginKaryawan, onLoginManager }) => {
        const [mode, setMode] = useState("karyawan");
        const [id, setId] = useState("");
        const [password, setPassword] = useState("");
        const [error, setError] = useState("");

        const handleSubmit = (e) => {
          e.preventDefault();
          setError("");

          if (mode === "karyawan") {
            const karyawan = initialDbKaryawan.find(
              (k) =>
                k.id.toLowerCase() === id.trim().toLowerCase() &&
                k.password === password.trim()
            );
            if (!karyawan) {
              setError("ID atau password karyawan tidak sesuai.");
              return;
            }
            onLoginKaryawan(karyawan);
          } else {
            // Manager login sederhana
            if (
              (id.trim().toLowerCase() === "manager" ||
                id.trim().toLowerCase() === "admin") &&
              password.trim() === "payboss123"
            ) {
              onLoginManager();
            } else {
              setError("ID atau password manager tidak sesuai.");
            }
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-stone-700 via-amber-800 to-stone-900 p-4">
            <div
              className={`w-full max-w-md ${theme.colors.card} ${theme.rounding.card} shadow-2xl p-6 space-y-5`}
            >
              <div className="flex items-center gap-3 mb-2">
                <div className="w-10 h-10 rounded-full bg-amber-600 flex items-center justify-center text-2xl">
                  ‚òï
                </div>
                <div>
                  <h1 className="text-2xl font-bold text-stone-800">
                    PayBoss Cafe
                  </h1>
                  <p className="text-xs text-stone-500">
                    Sistem Absensi Karyawan & Dashboard Manager
                  </p>
                </div>
              </div>

              <div className="flex bg-stone-100 rounded-lg p-1 mb-2">
                <button
                  className={`flex-1 py-2 text-sm font-semibold rounded-md ${
                    mode === "karyawan"
                      ? "bg-white text-stone-800 shadow"
                      : "text-stone-500"
                  }`}
                  onClick={() => {
                    setMode("karyawan");
                    setError("");
                  }}
                >
                  Karyawan
                </button>
                <button
                  className={`flex-1 py-2 text-sm font-semibold rounded-md ${
                    mode === "manager"
                      ? "bg-white text-stone-800 shadow"
                      : "text-stone-500"
                  }`}
                  onClick={() => {
                    setMode("manager");
                    setError("");
                  }}
                >
                  Manager
                </button>
              </div>

              <form onSubmit={handleSubmit} className="space-y-3">
                <Input
                  placeholder={
                    mode === "karyawan" ? "ID Karyawan (mis. PB251101)" : "ID Manager (manager/admin)"
                  }
                  value={id}
                  onChange={(e) => setId(e.target.value)}
                  icon={<User size={18} />}
                />
                <Input
                  type="password"
                  placeholder="Password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  icon={<LockIcon />}
                />

                {error && (
                  <p className="text-xs text-red-600 bg-red-50 border border-red-100 rounded-md px-3 py-2">
                    {error}
                  </p>
                )}

                <Button type="submit">
                  <LogIn size={18} /> Masuk sebagai{" "}
                  {mode === "karyawan" ? "Karyawan" : "Manager"}
                </Button>
              </form>

              <p className="text-xs text-stone-400 mt-2">
                Contoh:
                <br />
                Karyawan: ID <b>PB251101</b>, password <b>dayat123</b>
                <br />
                Manager: ID <b>manager</b>, password <b>payboss123</b>
              </p>
            </div>
          </div>
        );
      };

      const LockIcon = (props) => <IconWrapper {...props}>üîí</IconWrapper>;

      // --- APP UTAMA ---

      const App = () => {
        const [dbKaryawan, setDbKaryawan] = useState(initialDbKaryawan);
        const [dbRoster, setDbRoster] = useState(initialDbRoster);
        const [dbAbsensi, setDbAbsensi] = useState([]);
        const [loadingAbsensi, setLoadingAbsensi] = useState(false);

        const [currentUser, setCurrentUser] = useState(null); // { role: 'karyawan'|'manager', data: {...} }
        const [activePage, setActivePage] = useState("home");

        const [attendanceModal, setAttendanceModal] = useState({
          open: false,
          type: null,
          shift: null,
        });

        // Muat data absensi dari Google Sheet (awal & interval)
        const reloadAbsensi = useCallback(async () => {
          setLoadingAbsensi(true);
          const data = await loadAbsensiDariSheet();
          setDbAbsensi(data);
          setLoadingAbsensi(false);
        }, []);

        useEffect(() => {
          let cancelled = false;

          const load = async () => {
            setLoadingAbsensi(true);
            const data = await loadAbsensiDariSheet();
            if (!cancelled) {
              setDbAbsensi(data);
              setLoadingAbsensi(false);
            }
          };

          load();
          const interval = setInterval(load, 60000); // auto refresh tiap 1 menit

          return () => {
            cancelled = true;
            clearInterval(interval);
          };
        }, []);

        const handleLoginKaryawan = (karyawan) => {
          setCurrentUser({ role: "karyawan", data: karyawan });
          setActivePage("home");
        };

        const handleLoginManager = () => {
          setCurrentUser({
            role: "manager",
            data: { nama: "Manager PayBoss" },
          });
          setActivePage("manager-dashboard");
        };

        const handleLogout = () => {
          setCurrentUser(null);
          setActivePage("home");
        };

        const openAttendanceModal = (type, shift) => {
          setAttendanceModal({ open: true, type, shift });
        };

        const closeAttendanceModal = () => {
          setAttendanceModal({ open: false, type: null, shift: null });
        };

        const handleAttendanceComplete = (type, attendanceData, shift) => {
          const user = currentUser?.data;
          if (!user) return;
          const tanggal = formatDateYYYYMMDD(attendanceData.waktu || new Date());

          setDbAbsensi((prev) => {
            const idx = prev.findIndex(
              (r) => r.idKaryawan === user.id && r.tanggal === tanggal
            );
            let record;
            if (idx >= 0) {
              record = { ...prev[idx] };
            } else {
              record = {
                idKaryawan: user.id,
                namaKaryawan: user.nama,
                posisi: user.posisi,
                tanggal,
                shift: shift?.nama || "",
                checkIn: null,
                checkOut: null,
                jobDeskProgress: buildJobdeskForPosition(user.posisi),
                status: "",
              };
            }

            if (type === "checkIn") {
              record.checkIn = attendanceData;
            } else if (type === "checkOut") {
              record.checkOut = attendanceData;
            }

            if (record.checkIn && record.checkOut) {
              record.status = "Hadir (Lengkap)";
            } else if (record.checkIn && !record.checkOut) {
              record.status = "Hadir (Belum Check-out)";
            }

            const arr = [...prev];
            if (idx >= 0) arr[idx] = record;
            else arr.push(record);

            return arr;
          });
        };

        if (!currentUser) {
          return (
            <LoginPage
              onLoginKaryawan={handleLoginKaryawan}
              onLoginManager={handleLoginManager}
            />
          );
        }

        const isKaryawan = currentUser.role === "karyawan";
        const user = currentUser.data;

        return (
          <div className="min-h-screen bg-stone-100">
            {/* Top nav */}
            <header className="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-stone-200">
              <div className="max-w-4xl mx-auto px-4 py-2 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="w-8 h-8 rounded-full bg-amber-600 flex items-center justify-center text-xl">
                    ‚òï
                  </div>
                  <div>
                    <div className="text-sm font-bold text-stone-800">
                      PayBoss Cafe Absensi
                    </div>
                    <div className="text-[11px] text-stone-500">
                      {isKaryawan ? "Portal Karyawan" : "Dashboard Manager"}
                    </div>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="hidden sm:flex flex-col items-end">
                    <span className="text-xs font-semibold text-stone-700">
                      {user.nama}
                    </span>
                    <span className="text-[11px] text-stone-500">
                      {isKaryawan ? user.posisi : "Manager"}
                    </span>
                  </div>
                  <button
                    onClick={handleLogout}
                    className="px-3 py-1 rounded-full bg-stone-200 hover:bg-stone-300 text-xs flex items-center gap-1"
                  >
                    <LogOut size={14} /> Keluar
                  </button>
                </div>
              </div>

              {/* Sub nav */}
              <div className="border-t border-stone-100 bg-white/90">
                <div className="max-w-4xl mx-auto px-4 flex gap-2 py-1 text-xs">
                  {isKaryawan ? (
                    <>
                      <button
                        onClick={() => setActivePage("home")}
                        className={`px-3 py-1 rounded-full flex items-center gap-1 ${
                          activePage === "home"
                            ? "bg-stone-800 text-white"
                            : "text-stone-600 hover:bg-stone-100"
                        }`}
                      >
                        <Home size={14} /> Beranda
                      </button>
                      <button
                        onClick={() => setActivePage("jobdesk")}
                        className={`px-3 py-1 rounded-full flex items-center gap-1 ${
                          activePage === "jobdesk"
                            ? "bg-stone-800 text-white"
                            : "text-stone-600 hover:bg-stone-100"
                        }`}
                      >
                        <ListChecks size={14} /> Jobdesk
                      </button>
                      <button
                        onClick={() => setActivePage("riwayat")}
                        className={`px-3 py-1 rounded-full flex items-center gap-1 ${
                          activePage === "riwayat"
                            ? "bg-stone-800 text-white"
                            : "text-stone-600 hover:bg-stone-100"
                        }`}
                      >
                        <Calendar size={14} /> Riwayat
                      </button>
                    </>
                  ) : (
                    <>
                      <button
                        onClick={() => setActivePage("manager-dashboard")}
                        className={`px-3 py-1 rounded-full flex items-center gap-1 ${
                          activePage === "manager-dashboard"
                            ? "bg-stone-800 text-white"
                            : "text-stone-600 hover:bg-stone-100"
                        }`}
                      >
                        <BarChart2 size={14} /> Dashboard
                      </button>
                      <button
                        onClick={() => setActivePage("data-karyawan")}
                        className={`px-3 py-1 rounded-full flex items-center gap-1 ${
                          activePage === "data-karyawan"
                            ? "bg-stone-800 text-white"
                            : "text-stone-600 hover:bg-stone-100"
                        }`}
                      >
                        <Users size={14} /> Data Karyawan
                      </button>
                    </>
                  )}
                </div>
              </div>
            </header>

            {/* Konten */}
            <main className="max-w-4xl mx-auto">
              {isKaryawan ? (
                <>
                  {activePage === "home" && (
                    <KaryawanHome
                      user={user}
                      dbAbsensi={dbAbsensi}
                      dbRoster={dbRoster}
                      onNavigate={setActivePage}
                      onShowModal={openAttendanceModal}
                    />
                  )}
                  {activePage === "jobdesk" && (
                    <JobdeskPage
                      user={user}
                      dbAbsensi={dbAbsensi}
                      setDbAbsensi={setDbAbsensi}
                      onBack={() => setActivePage("home")}
                    />
                  )}
                  {activePage === "riwayat" && (
                    <RiwayatKaryawan
                      user={user}
                      dbAbsensi={dbAbsensi}
                      onBack={() => setActivePage("home")}
                    />
                  )}
                </>
              ) : (
                <>
                  {activePage === "manager-dashboard" && (
                    <ManagerDashboard
                      dbAbsensi={dbAbsensi}
                      dbKaryawan={dbKaryawan}
                      onRefresh={reloadAbsensi}
                      loadingAbsensi={loadingAbsensi}
                    />
                  )}
                  {activePage === "data-karyawan" && (
                    <DataKaryawanPage dbKaryawan={dbKaryawan} />
                  )}
                </>
              )}
            </main>

            {/* Modal Absensi */}
            {attendanceModal.open && isKaryawan && (
              <AttendanceFlow
                user={user}
                type={attendanceModal.type}
                todayShift={attendanceModal.shift}
                onClose={closeAttendanceModal}
                onComplete={(data) =>
                  handleAttendanceComplete(
                    attendanceModal.type,
                    data,
                    attendanceModal.shift
                  )
                }
              />
            )}
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
