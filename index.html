<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PayBoss Cafe - Sistem Absensi</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel (untuk JSX di browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Framer Motion UMD -->
    <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>
  </head>

  <body class="bg-stone-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useRef, useEffect, useCallback } = React;

      // Inisialisasi Framer Motion dari UMD (fallback kalau gagal load)
      const fm = window.FramerMotion || null;
      const motion = fm
        ? fm.motion
        : {
            div: (props) => <div {...props} />, 
            form: (props) => <form {...props} />,
          };
      const AnimatePresence = fm ? fm.AnimatePresence : ({ children }) => <>{children}</>;

      // --- SIMPLE ICON WRAPPER (pengganti lucide-react) ---
      const IconWrapper = ({ children, className = "", size = 24 }) => (
        <span
          className={className}
          style={{ fontSize: size, display: "inline-flex", alignItems: "center", justifyContent: "center" }}
        >
          {children}
        </span>
      );

      const Home = (props) => <IconWrapper {...props}>üè†</IconWrapper>;
      const LogIn = (props) => <IconWrapper {...props}>üîë</IconWrapper>;
      const LogOut = (props) => <IconWrapper {...props}>üö™</IconWrapper>;
      const User = (props) => <IconWrapper {...props}>üë§</IconWrapper>;
      const BarChart2 = (props) => <IconWrapper {...props}>üìä</IconWrapper>;
      const Users = (props) => <IconWrapper {...props}>üë•</IconWrapper>;
      const Calendar = (props) => <IconWrapper {...props}>üìÖ</IconWrapper>;
      const FileText = (props) => <IconWrapper {...props}>üìÑ</IconWrapper>;
      const CheckCircle = (props) => <IconWrapper {...props}>‚úÖ</IconWrapper>;
      const XCircle = (props) => <IconWrapper {...props}>‚ùå</IconWrapper>;
      const MapPin = (props) => <IconWrapper {...props}>üìç</IconWrapper>;
      const Camera = (props) => <IconWrapper {...props}>üì∑</IconWrapper>;
      const ListChecks = (props) => <IconWrapper {...props}>‚úÖ</IconWrapper>;
      const ChevronLeft = (props) => <IconWrapper {...props}>‚óÄÔ∏è</IconWrapper>;
      const ChevronRight = (props) => <IconWrapper {...props}>‚ñ∂Ô∏è</IconWrapper>;
      const Plus = (props) => <IconWrapper {...props}>‚ûï</IconWrapper>;
      const Trash2 = (props) => <IconWrapper {...props}>üóëÔ∏è</IconWrapper>;
      const Edit = (props) => <IconWrapper {...props}>‚úèÔ∏è</IconWrapper>;
      const Clock = (props) => <IconWrapper {...props}>‚è∞</IconWrapper>;
      const AlertTriangle = (props) => <IconWrapper {...props}>‚ö†Ô∏è</IconWrapper>;
      const Coffee = (props) => <IconWrapper {...props}>‚òï</IconWrapper>;
      const ShieldCheck = (props) => <IconWrapper {...props}>üõ°Ô∏è</IconWrapper>;
      const Moon = (props) => <IconWrapper {...props}>üåô</IconWrapper>;
      const Sun = (props) => <IconWrapper {...props}>‚òÄÔ∏è</IconWrapper>;
      const Sunset = (props) => <IconWrapper {...props}>üåÜ</IconWrapper>;

      // --- STYLING & KONFIGURASI ---

      // Konfigurasi Tema PayBoss Cafe (Earthy Tones)
      const theme = {
        colors: {
          primary: "bg-stone-700", // Coklat tua
          primaryHover: "hover:bg-stone-800",
          secondary: "bg-amber-800", // Coklat muda (aksen)
          secondaryHover: "hover:bg-amber-900",
          accent: "bg-green-700", // Hijau
          accentHover: "hover:bg-green-800",
          background: "bg-stone-100", // Krem
          card: "bg-white",
          textPrimary: "text-stone-800",
          textSecondary: "text-stone-600",
          textLight: "text-white",
          border: "border-stone-200",
          danger: "bg-red-600",
          success: "bg-green-600",
        },
        rounding: {
          card: "rounded-2xl",
          button: "rounded-lg",
          input: "rounded-lg",
        },
      };

      // Lokasi PayBoss Cafe (Target GPS)
      const TARGET_LOCATION = {
        latitude: -2.1717657457047723,
        longitude: 115.4029877085838,
      };
      const GPS_RADIUS_METERS = 100;

      // Hardcode tanggal hari ini untuk demo roster (16 November 2025, Minggu)
      const TODAY = "2025-11-16";

      // URL Google Apps Script untuk read/write Google Sheet
      // GANTI dengan URL Web App milik Anda jika berbeda
      const GOOGLE_SHEET_WEBAPP_URL =
        "https://script.google.com/macros/s/AKfycbxOHwN1-GyfwWrQLucTf-X0Db_9HefScgxd5g2h35-ntTNyGQZ4NePhZ39OfeZqRvdM/exec";

      // --- DATABASE MOCK (BERDASARKAN FILE UPLOAD) ---

                  const initialDbKaryawan = [
        {
          id: "PB251101",
          nama: "Dayat",
          posisi: "Koordinator",
          password: "dayat123",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
          fotoInisial: "D",
        },
        {
          id: "PB251102",
          nama: "Ilham Ali Naufal",
          posisi: "Pramusaji",
          password: "ilham123",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
          fotoInisial: "IAN",
        },
        {
          id: "PB251104",
          nama: "Renita Aulia Jasmin",
          posisi: "Bartender",
          password: "renita123",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",     ],
        Chef: [
          "Persiapan 'mise en place' bahan baku kitchen",
          "Memasak pesanan sesuai SOP dan urutan (FIFO)",
          "Menjaga kualitas rasa dan presentasi hidangan",
          "Memastikan kebersihan area kitchen (kitchen station)",
          "Melakukan stok opname harian bahan baku kitchen",
        ],
        Koordinator: [
          "Memimpin briefing pagi tim FOH & BOH",
          "Memastikan ketersediaan stok (Bar & Kitchen)",
          "Menangani keluhan atau masukan tamu (service recovery)",
          "Membuat laporan closing harian",
          "Memastikan semua tim menjalankan SOP dengan baik",
        ],
      };

      const initialDbRoster = {
        PB251101: {
          "2025-11-16": "OFF",
          "2025-11-17": 1,
          "2025-11-18": 1,
          "2025-11-19": 1,
          "2025-11-20": 1,
          "2025-11-21": 1,
          "2025-11-22": 1,
        },
        PB251102: {
          "2025-11-16": 2,
          "2025-11-17": "OFF",
          "2025-11-18": 3,
          "2025-11-19": 3,
          "2025-11-20": 3,
          "2025-11-21": 3,
          "2025-11-22": 3,
        },
        PB251104: {
          "2025-11-16": 2,
          "2025-11-17": 2,
          "2025-11-18": "OFF",
          "2025-11-19": 2,
          "2025-11-20": 2,
          "2025-11-21": 2,
          "2025-11-22": 2,
        },
        PB251108: {
          "2025-11-16": 1,
          "2025-11-17": 1,
          "2025-11-18": 1,
          "2025-11-19": "OFF",
          "2025-11-20": 2,
          "2025-11-21": 2,
          "2025-11-22": 2,
        },
        PB251109: {
          "2025-11-16": 1,
          "2025-11-17": 1,
          "2025-11-18": 1,
          "2025-11-19": 1,
          "2025-11-20": "OFF",
          "2025-11-21": 1,
          "2025-11-22": "OFF",
        },
        PB251106: {
          "2025-11-16": 2,
          "2025-11-17": 2,
          "2025-11-18": "OFF",
          "2025-11-19": 2,
          "2025-11-20": 2,
          "2025-11-21": 2,
          "2025-11-22": 2,
        },
        PB251107: {
          "2025-11-16": 2,
          "2025-11-17": "OFF",
          "2025-11-18": 3,
          "2025-11-19": 3,
          "2025-11-20": 3,
          "2025-11-21": 3,
          "2025-11-22": 3,
        },
      };

      const shiftDetails = {
        1: { nama: "Pagi", ikon: Sun, waktu: "08:00 - 16:00", color: "text-blue-500" },
        2: { nama: "Siang", ikon: Sunset, waktu: "16:00 - 23:00", color: "text-orange-500" },
        3: { nama: "Malam", ikon: Moon, waktu: "23:00 - 08:00", color: "text-indigo-500" },
        OFF: { nama: "OFF", ikon: Home, waktu: "Libur", color: "text-gray-500" },
      };

      // --- FUNGSI UTILITAS ---

      function getHaversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // meter
        const œÜ1 = (lat1 * Math.PI) / 180;
        const œÜ2 = (lat2 * Math.PI) / 180;
        const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180;
        const ŒîŒª = ((lon2 - lon1) * Math.PI) / 180;

        const a =
          Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
          Math.cos(œÜ1) * Math.cos(œÜ2) *
            Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c; // dalam meter
      }

      function getNext7Days(startDateString) {
        const startDate = new Date(startDateString + "T00:00:00");
        const dates = [];
        for (let i = 0; i < 7; i++) {
          const nextDate = new Date(startDate.getTime());
          nextDate.setDate(startDate.getDate() + i);
          dates.push(nextDate);
        }
        return dates;
      }

      function formatDateYYYYMMDD(date) {
        return date.toISOString().split("T")[0];
      }

      function formatShortDate(date) {
        return date.toLocaleDateString("id-ID", {
          weekday: "long",
          day: "numeric",
          month: "short",
        });
      }

      function formatTime(date) {
        return date.toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      // --- FUNGSI KONEKSI GOOGLE SHEET ---
      // Contoh sederhana: kirim log absensi (check-in / check-out) ke Google Sheet
      // Google Apps Script (doPost) di sisi server perlu membaca JSON dan append ke Sheet.

      async function kirimAbsensiKeSheet({ user, jenis, data, shiftName }) {
        try {
          const payload = {
            action: "appendAbsensi", // bisa Anda pakai untuk switch-case di Apps Script
            timestamp: new Date().toISOString(),
            tanggal: TODAY,
            jenis, // "checkIn" / "checkOut"
            idKaryawan: user.id,
            namaKaryawan: user.nama,
            posisi: user.posisi,
            shift: shiftName,
            waktu: data.waktu.toISOString(),
            lat: data.lat || "",
            lng: data.lng || "",
            jarak: data.jarak || "",
            alasanLuarArea: data.alasanLuarArea || "",
          };

          // mode: "no-cors" supaya tidak error di browser saat Apps Script belum mengatur CORS dengan benar.
          // Di Apps Script, pastikan Web App sudah di-deploy dengan akses "Anyone with the link" dan log payload-nya.
          await fetch(GOOGLE_SHEET_WEBAPP_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
            mode: "no-cors",
          });
        } catch (err) {
          // Tangani kegagalan jaringan tanpa melempar error ke UI
          console.error("Gagal mengirim data ke Google Sheet", err);
        }
      }

      // Contoh fungsi membaca data absensi dari Google Sheet (opsional)
      // Apps Script doGet harus mengembalikan JSON: { data: [ ... ] }
      async function loadAbsensiDariSheet() {
        try {
          const res = await fetch(
            GOOGLE_SHEET_WEBAPP_URL + "?action=getAbsensi"
          );
          if (!res.ok) throw new Error("Response tidak OK");
          const json = await res.json();
          if (!json || !Array.isArray(json.data)) return null;

          // DI BAWAH INI hanya contoh mapping. Sesuaikan dengan struktur JSON Anda.
          return json.data.map((row) => ({
            id: row.id,
            idKaryawan: row.idKaryawan,
            namaKaryawan: row.namaKaryawan,
            posisi: row.posisi,
            tanggal: row.tanggal,
            shift: row.shift,
            checkIn: row.checkIn
              ? {
                  waktu: new Date(row.checkIn),
                  alasanLuarArea: row.alasanLuarArea || null,
                  lat: row.lat ? Number(row.lat) : null,
                  lng: row.lng ? Number(row.lng) : null,
                  jarak: row.jarak ? Number(row.jarak) : null,
                }
              : null,
            checkOut: row.checkOut
              ? {
                  waktu: new Date(row.checkOut),
                }
              : null,
            jobDeskProgress: [],
            status: row.status || "",
          }));
        } catch (err) {
          console.error("Gagal load absensi dari Google Sheet", err);
          return null;
        }
      }

      // --- KOMPONEN UI (SHARED) ---

      const Modal = ({ children, onClose, title }) => (
        <AnimatePresence>
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 p-4"
            onClick={onClose}
          >
            <motion.div
              initial={{ scale: 0.9, y: 20 }}
              animate={{ scale: 1, y: 0 }}
              exit={{ scale: 0.9, y: 20 }}
              className={`relative w-full max-w-lg overflow-hidden ${theme.colors.card} ${theme.rounding.card} shadow-2xl`}
              onClick={(e) => e.stopPropagation()}
            >
              <div
                className={`flex items-center justify-between p-5 ${theme.colors.border} border-b`}
              >
                <h3 className={`text-xl font-bold ${theme.colors.textPrimary}`}>
                  {title}
                </h3>
                <button
                  onClick={onClose}
                  className={`${theme.colors.textSecondary || "text-stone-600"} hover:text-red-500`}
                >
                  <XCircle size={24} />
                </button>
              </div>
              <div className="p-6">{children}</div>
            </motion.div>
          </motion.div>
        </AnimatePresence>
      );

      const Button = ({
        onClick,
        children,
        variant = "primary",
        disabled = false,
        className = "",
        type = "button",
      }) => {
        const variants = {
          primary: `${theme.colors.primary} ${theme.colors.textLight} ${theme.colors.primaryHover}`,
          secondary: `${theme.colors.secondary} ${theme.colors.textLight} ${theme.colors.secondaryHover}`,
          accent: `${theme.colors.accent} ${theme.colors.textLight} ${theme.colors.accentHover}`,
          danger: `${theme.colors.danger} ${theme.colors.textLight} hover:bg-red-700`,
          light: `${theme.colors.background} ${theme.colors.textPrimary} hover:bg-stone-200`,
        };

        return (
          <button
            type={type}
            onClick={onClick}
            disabled={disabled}
            className={`flex w-full items-center justify-center gap-2 p-3 font-semibold ${theme.rounding.button} transition-all duration-200 ${variants[variant]} ${
              disabled ? "opacity-50 cursor-not-allowed" : ""
            } ${className}`}
          >
            {children}
          </button>
        );
      };

      const Input = ({
        type = "text",
        placeholder,
        value,
        onChange,
        icon,
        className = "",
        ...rest
      }) => (
        <div className="relative w-full">
          {icon && (
            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400">
              {icon}
            </div>
          )}
          <input
            type={type}
            placeholder={placeholder}
            value={value}
            onChange={onChange}
            {...rest}
            className={`w-full ${theme.colors.background} ${theme.rounding.input} ${
              theme.colors.textPrimary
            } border ${theme.colors.border} p-3 ${
              icon ? "pl-10" : ""
            } focus:outline-none focus:ring-2 focus:ring-amber-800 ${className}`}
          />
        </div>
      );

      const Spinner = ({ size = 24 }) => (
        <motion.div
          animate={{ rotate: 360 }}
          transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
          className="border-t-transparent border-solid rounded-full border-stone-700 border-2"
          style={{ width: size, height: size }}
        />
      );

      const ProgressBar = ({ value, max }) => {
        const percent = max > 0 ? (value / max) * 100 : 0;
        return (
          <div
            className={`w-full ${theme.colors.background} ${theme.rounding.button} overflow-hidden`}
          >
            <motion.div
              className={`${theme.colors.accent} h-2`}
              initial={{ width: 0 }}
              animate={{ width: `${percent}%` }}
              transition={{ duration: 0.5, ease: "easeInOut" }}
            />
          </div>
        );
      };

      // --- KOMPONEN: ALUR ABSENSI (MODAL) ---

      const AttendanceFlow = ({ user, type, onClose, onComplete, todayShift }) => {
        const [step, setStep] = useState("camera");
        const [selfie, setSelfie] = useState(null);
        const [locationData, setLocationData] = useState(null);
        const [inArea, setInArea] = useState(false);
        const [distance, setDistance] = useState(0);
        const [error, setError] = useState(null);
        const [cameraSupported, setCameraSupported] = useState(true);

        const [reason, setReason] = useState("");
        const reasons = ["Sakit", "Izin", "Dinas Luar", "Lainnya"];

        const webcamRef = useRef(null);
        const streamRef = useRef(null);

        useEffect(() => {
          if (step === "camera") {
            const startCamera = async () => {
              try {
                if (
                  typeof navigator === "undefined" ||
                  !navigator.mediaDevices ||
                  !navigator.mediaDevices.getUserMedia
                ) {
                  // Lingkungan (misalnya sandbox / test) tidak mendukung kamera.
                  setCameraSupported(false);
                  setError(
                    "Kamera tidak didukung di browser/lingkungan ini. Anda bisa melanjutkan tanpa selfie."
                  );
                  return;
                }

                setCameraSupported(true);
                const stream = await navigator.mediaDevices.getUserMedia({
                  video: { facingMode: "user" },
                  audio: false,
                });
                if (webcamRef.current) {
                  webcamRef.current.srcObject = stream;
                  webcamRef.current.play();
                  streamRef.current = stream;
                }
              } catch (err) {
                // Jangan lempar error ke luar; cukup tampilkan pesan dan lanjutkan flow.
                console.error("Error accessing webcam:", err);
                setCameraSupported(false);
                setError(
                  "Gagal mengakses kamera. Periksa izin kamera Anda, atau lanjutkan tanpa selfie."
                );
                // Kita tidak langsung memaksa pindah step agar user bisa memilih tombol "Lanjut tanpa Selfie".
              }
            };
            startCamera();
          }

          return () => {
            if (streamRef.current) {
              streamRef.current.getTracks().forEach((track) => track.stop());
              streamRef.current = null;
            }
          };
        }, [step]);

        const captureSelfie = useCallback(() => {
          if (!webcamRef.current || !cameraSupported) {
            // Kalau kamera tidak tersedia, berikan info jelas.
            setError(
              "Kamera belum siap atau tidak didukung. Anda bisa menekan tombol 'Lanjut tanpa Selfie'."
            );
            return;
          }

          const video = webcamRef.current;
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;

          const ctx = canvas.getContext("2d");
          if (!ctx) {
            setError("Gagal memproses gambar.");
            return;
          }

          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageSrc = canvas.toDataURL("image/jpeg");

          if (!imageSrc) {
            setError("Gagal mengambil foto. Coba lagi.");
            return;
          }
          setSelfie(imageSrc);
          setStep("location");

          if (streamRef.current) {
            streamRef.current.getTracks().forEach((track) => track.stop());
            streamRef.current = null;
          }
        }, [cameraSupported]);

        const continueWithoutSelfie = () => {
          // Fallback untuk lingkungan tanpa kamera atau ketika user tidak bisa memberi izin.
          setSelfie(null);
          setError(null);
          setStep("location");

          if (streamRef.current) {
            streamRef.current.getTracks().forEach((track) => track.stop());
            streamRef.current = null;
          }
        };

        useEffect(() => {
          if (step === "location") {
            setError(null);
            if (!navigator.geolocation) {
              setError("Browser Anda tidak mendukung Geolocation.");
              setStep("confirm");
              return;
            }

            navigator.geolocation.getCurrentPosition(
              (position) => {
                const { latitude, longitude } = position.coords;
                const dist = getHaversineDistance(
                  latitude,
                  longitude,
                  TARGET_LOCATION.latitude,
                  TARGET_LOCATION.longitude
                );

                setLocationData({ latitude, longitude });
                setDistance(dist);

                if (dist <= GPS_RADIUS_METERS) {
                  setInArea(true);
                  setStep("confirm");
                } else {
                  setInArea(false);
                  setStep("reason");
                }
              },
              (err) => {
                let errMsg = "Gagal mendapatkan lokasi. ";
                if (err.code === 1)
                  errMsg += "Pastikan Anda mengizinkan akses lokasi.";
                if (err.code === 2) errMsg += "Sinyal lokasi tidak tersedia.";
                if (err.code === 3) errMsg += "Waktu tunggu habis.";
                setError(errMsg);
                setStep("confirm");
              },
              { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
          }
        }, [step]);

        const handleSubmit = async () => {
          setStep("loading");

          const attendanceData = {
            waktu: new Date(),
            fotoBase64: selfie,
            lat: locationData?.latitude,
            lng: locationData?.longitude,
            alasanLuarArea: inArea ? null : reason,
            jarak: distance,
          };

          try {
            await kirimAbsensiKeSheet({
              user,
              jenis: type,
              data: attendanceData,
              shiftName: todayShift?.nama || "",
            });
          } catch (e) {
            // Error dari kirimAbsensiKeSheet sudah ditangani di dalam fungsi tersebut
            console.error(e);
          }

          onComplete(attendanceData);
          setStep("success");
        };

        const title = type === "checkIn" ? "Absen Check-in" : "Absen Check-out";

        const renderStep = () => {
          switch (step) {
            case "camera":
              return (
                <div className="text-center">
                  <p className={`${theme.colors.textSecondary} mb-4`}>
                    Posisikan wajah Anda di dalam frame dan ambil selfie untuk
                    verifikasi. Jika kamera tidak berfungsi, Anda tetap bisa
                    lanjut tanpa selfie.
                  </p>
                  {cameraSupported && (
                    <div
                      className={`w-full overflow-hidden ${theme.rounding.card} border-2 ${theme.colors.border} shadow-inner bg-black`}
                    >
                      <video
                        ref={webcamRef}
                        autoPlay
                        playsInline
                        muted
                        className="w-full h-auto"
                        style={{ transform: "scaleX(-1)" }}
                      />
                    </div>
                  )}
                  {error && (
                    <p className="text-red-500 text-sm mt-2">{error}</p>
                  )}
                  <div className="flex flex-col sm:flex-row gap-3 mt-4">
                    <Button
                      onClick={captureSelfie}
                      variant="secondary"
                      className="sm:flex-1"
                      disabled={!cameraSupported}
                    >
                      <Camera size={20} /> Ambil Foto
                    </Button>
                    <Button
                      onClick={continueWithoutSelfie}
                      variant="light"
                      className="sm:flex-1"
                    >
                      Lewati Selfie
                    </Button>
                  </div>
                </div>
              );

            case "location":
              return (
                <div className="flex flex-col items-center justify-center h-48">
                  <Spinner size={40} />
                  <p
                    className={`${theme.colors.textPrimary} mt-4 font-semibold`}
                  >
                    Mendeteksi lokasi Anda...
                  </p>
                  <p className={`${theme.colors.textSecondary} text-sm`}>
                    Pastikan GPS dan izin lokasi aktif.
                  </p>
                </div>
              );

            case "reason":
              return (
                <div>
                  <div
                    className={`flex items-center gap-3 p-4 ${theme.rounding.button} bg-yellow-100 border border-yellow-300 text-yellow-800`}
                  >
                    <AlertTriangle size={24} />
                    <div>
                      <h4 className="font-bold">Anda Berada di Luar Area!</h4>
                      <p className="text-sm">
                        Jarak Anda: {distance.toFixed(0)} meter dari PayBoss
                        Cafe.
                      </p>
                    </div>
                  </div>
                  <p
                    className={`${theme.colors.textSecondary} mt-4 mb-3`}
                  >
                    Harap pilih alasan Anda absen di luar area kerja:
                  </p>
                  <div className="space-y-2">
                    {reasons.map((r) => (
                      <label
                        key={r}
                        className={`flex items-center w-full p-3 ${
                          theme.rounding.input
                        } ${theme.colors.background} border ${
                          reason === r
                            ? "border-amber-800 ring-2 ring-amber-800"
                            : theme.colors.border
                        } cursor-pointer`}
                      >
                        <input
                          type="radio"
                          name="reason"
                          value={r}
                          checked={reason === r}
                          onChange={(e) => setReason(e.target.value)}
                          className="mr-3"
                        />
                        {r}
                      </label>
                    ))}
                  </div>
                  <Button
                    onClick={() => setStep("confirm")}
                    disabled={!reason}
                    className="mt-4"
                  >
                    Lanjutkan
                  </Button>
                </div>
              );

            case "confirm":
              return (
                <div>
                  <p className={`${theme.colors.textSecondary} mb-4`}>
                    Harap konfirmasi data {" "}
                    {type === "checkIn" ? "check-in" : "check-out"} Anda.
                  </p>
                  <div className="space-y-4">
                    <div className="flex items-center gap-4">
                      {selfie && (
                        <img
                          src={selfie}
                          alt="Selfie"
                          className={`w-24 h-24 object-cover ${theme.rounding.card} border-2 ${theme.colors.border}`}
                        />
                      )}
                      <div>
                        <h4 className="font-bold">{user.nama}</h4>
                        <p className={theme.colors.textSecondary}>{user.posisi}</p>
                        <p className={theme.colors.textSecondary}>
                          {formatTime(new Date())}
                        </p>
                      </div>
                    </div>
                    <div
                      className={`p-3 ${theme.rounding.input} ${theme.colors.background}`}
                    >
                      <h5 className="font-semibold flex items-center gap-2">
                        <MapPin
                          size={16}
                          className={
                            inArea ? "text-green-600" : "text-red-600"
                          }
                        />
                        Status Lokasi
                      </h5>
                      {locationData ? (
                        inArea ? (
                          <p className="text-green-600 text-sm font-medium">
                            Dalam Area PayBoss Cafe (¬±{distance.toFixed(0)}m).
                          </p>
                        ) : (
                          <p className="text-red-600 text-sm font-medium">
                            Di Luar Area PayBoss Cafe (¬±{distance.toFixed(0)}m).
                          </p>
                        )
                      ) : (
                        <p className="text-yellow-600 text-sm font-medium">
                          Gagal mendapatkan data lokasi.
                        </p>
                      )}
                      {reason && (
                        <p className="text-sm text-yellow-800 mt-1">
                          <b>Alasan:</b> {reason}
                        </p>
                      )}
                    </div>
                    {error && (
                      <p className="text-red-500 text-sm -mt-2">{error}</p>
                    )}
                  </div>
                  <Button
                    onClick={handleSubmit}
                    variant="accent"
                    className="mt-6"
                  >
                    <CheckCircle size={20} /> Konfirmasi {" "}
                    {type === "checkIn" ? "Check-in" : "Check-out"}
                  </Button>
                </div>
              );

            case "loading":
              return (
                <div className="flex flex-col items-center justify-center h-48">
                  <Spinner size={40} />
                  <p
                    className={`${theme.colors.textPrimary} mt-4 font-semibold`}
                  >
                    Menyimpan data absensi...
                  </p>
                </div>
              );

            case "success":
              return (
                <div className="flex flex-col items-center justify-center h-48 text-center">
                  <motion.div
                    initial={{ scale: 0.5 }}
                    animate={{ scale: 1 }}
                    transition={{ type: "spring", damping: 10, stiffness: 150 }}
                  >
                    <CheckCircle size={60} className="text-green-600" />
                  </motion.div>
                  <h3 className="text-2xl font-bold mt-4">Berhasil!</h3>
                  <p className={theme.colors.textSecondary}>
                    Absen {type === "checkIn" ? "check-in" : "check-out"} Anda
                    telah dicatat.
                  </p>
                  <Button onClick={onClose} className="mt-6 w-32">
                    Selesai
                  </Button>
                </div>
              );

            default:
              return null;
          }
        };

        return (
          <Modal title={title} onClose={onClose}>
            {renderStep()}
          </Modal>
        );
      };

      // --- KOMPONEN KARYAWAN ---

      const KaryawanHome = ({
        user,
        dbAbsensi,
        setDbAbsensi,
        dbRoster,
        onNavigate,
        onShowModal,
      }) => {
        const [todayRecord, setTodayRecord] = useState(null);
        const [todayShift, setTodayShift] = useState(null);
        const [greeting, setGreeting] = useState("");

        useEffect(() => {
          const record = dbAbsensi.find(
            (a) => a.idKaryawan === user.id && a.tanggal === TODAY
          );
          setTodayRecord(record);

          const shiftCode = dbRoster[user.id]?.[TODAY];
          setTodayShift(shiftDetails[shiftCode] || shiftDetails["OFF"]);

          const hour = new Date().getHours();
          if (hour < 11) setGreeting("Selamat Pagi");
          else if (hour < 15) setGreeting("Selamat Siang");
          else if (hour < 19) setGreeting("Selamat Sore");
          else setGreeting("Selamat Malam");
        }, [dbAbsensi, user.id, user.posisi, dbRoster]);

        if (!todayShift) {
          return (
            <div className="flex items-center justify-center h-screen">
              <Spinner size={40} />
            </div>
          );
        }

        const handleAttendance = (type) => {
          onShowModal(type, todayShift);
        };

        const isCheckedIn = todayRecord && todayRecord.checkIn;
        const isCheckedOut = todayRecord && todayRecord.checkOut;
        const isOff = todayShift.nama === "OFF";

        let jobProgress = 0;
        let jobTotal = 0;
        if (isCheckedIn) {
          jobTotal = todayRecord.jobDeskProgress.length;
          jobProgress = todayRecord.jobDeskProgress.filter((t) => t.completed)
            .length;
        }

        return (
          <div className="p-4 space-y-6">
            <div
              className={`p-6 ${theme.colors.primary} ${theme.rounding.card} shadow-lg text-white`}
            >
              <p className="text-lg font-light">{greeting},</p>
              <h2 className="text-3xl font-bold">{user.nama}</h2>
              <p className="text-stone-300 mt-1">{user.posisi}</p>
            </div>

            <div
              className={`p-6 ${theme.colors.card} ${theme.rounding.card} shadow-md`}
            >
              <h3
                className={`text-xl font-bold mb-4 ${theme.colors.textPrimary}`}
              >
                Absensi Hari Ini
              </h3>
              <p className={`${theme.colors.textSecondary} mb-1`}>
                {formatShortDate(new Date(TODAY + "T00:00:00"))}
              </p>

              {isOff ? (
                <div className="text-center p-6 bg-stone-100 rounded-lg">
                  <Home size={32} className="mx-auto text-stone-500 mb-2" />
                  <h4 className="text-lg font-bold">Hari Libur</h4>
                  <p className={theme.colors.textSecondary}>
                    Nikmati waktu istirahat Anda.
                  </p>
                </div>
              ) : (
                <div className="space-y-4">
                  {isCheckedIn ? (
                    <div className="flex items-center justify-between p-4 bg-green-50 border border-green-200 rounded-lg">
                      <div className="flex items-center gap-3">
                        <CheckCircle size={24} className="text-green-600" />
                        <div>
                          <span className="font-bold text-green-700">
                            Check-in Berhasil
                          </span>
                          <p className="text-sm text-green-600">
                            pukul {formatTime(todayRecord.checkIn.waktu)}
                          </p>
                        </div>
                      </div>
                      {todayRecord.checkIn.alasanLuarArea && (
                        <AlertTriangle
                          size={20}
                          className="text-yellow-500"
                          title={`Absen di luar area: ${todayRecord.checkIn.alasanLuarArea}`}
                        />
                      )}
                    </div>
                  ) : (
                    <Button onClick={() => handleAttendance("checkIn")}>
                      <LogIn size={20} /> Check-in
                    </Button>
                  )}

                  {isCheckedIn && (
                    isCheckedOut ? (
                      <div className="flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div className="flex items-center gap-3">
                          <CheckCircle size={24} className="text-blue-600" />
                          <div>
                            <span className="font-bold text-blue-700">
                              Check-out Berhasil
                            </span>
                            <p className="text-sm text-blue-600">
                              pukul {formatTime(todayRecord.checkOut.waktu)}
                            </p>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <Button
                        onClick={() => handleAttendance("checkOut")}
                        variant="secondary"
                      >
                        <LogOut size={20} /> Check-out
                      </Button>
                    )
                  )}
                </div>
              )}
            </div>

            {!isOff && (
              <div
                className={`p-6 ${theme.colors.card} ${theme.rounding.card} shadow-md space-y-4`}
              >
                <div>
                  <h4 className="text-lg font-bold flex items-center gap-2">
                    <Coffee size={20} className={todayShift.color} /> Shift
                    Anda
                  </h4>
                  <p className={`${theme.colors.textSecondary} text-lg`}>
                    {todayShift.nama} ({todayShift.waktu})
                  </p>
                </div>

                {isCheckedIn && (
                  <div>
                    <h4 className="text-lg font-bold flex items-center gap-2 mb-2">
                      <ListChecks size={20} className="text-stone-700" />
                      Progres Job Desk
                    </h4>
                    <ProgressBar value={jobProgress} max={jobTotal} />
                    <p
                      className={`${theme.colors.textSecondary} text-sm mt-2`}
                    >
                      {jobProgress} dari {jobTotal} tugas selesai.
                    </p>
                    <Button
                      onClick={() => onNavigate("jobdesk")}
                      variant="light"
                      className="mt-3
