<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payboss - Super Dashboard v3.7 (Stable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; }
        .nav-item { cursor: pointer; transition: all 0.3s ease; border-bottom: 3px solid transparent; color: #64748b; }
        .nav-item:hover { color: #1e293b; }
        .nav-item.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: bold; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-slate-800 min-h-screen relative pb-20">

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="fixed inset-0 bg-slate-900 bg-opacity-95 z-[9999] flex items-center justify-center backdrop-blur-sm transition-all duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-user-tie text-2xl text-blue-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800">Manager Area</h2>
            <form id="login-form" class="space-y-4 mt-6">
                <input type="email" id="email" required placeholder="Email" class="w-full px-4 py-3 border rounded-lg">
                <input type="password" id="password" required placeholder="Password" class="w-full px-4 py-3 border rounded-lg">
                <div id="login-error" class="text-red-500 text-xs hidden font-bold">Akses Ditolak / Salah Password.</div>
                <button type="submit" id="btn-login" class="w-full py-3 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-700 transition">Masuk Dashboard</button>
            </form>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main-content" class="filter blur-md pointer-events-none transition duration-500 max-w-7xl mx-auto p-4 md:p-6">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-chart-pie text-blue-600"></i> Payboss Analytics</h1>
                <p class="text-slate-500 text-sm">Laporan Harian & Kontrol Keuangan</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="bg-white px-4 py-2 rounded-lg shadow border text-right">
                    <p class="text-[10px] uppercase font-bold text-slate-400">Tanggal Laporan</p>
                    <p id="header-date" class="font-bold text-sm text-blue-600">Loading...</p>
                </div>
                <button id="btn-logout" class="p-2 text-red-600 hover:bg-red-50 rounded-lg border border-red-200"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <!-- TABS -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 flex overflow-x-auto">
            <div onclick="switchTab('ops')" id="tab-ops" class="nav-item active flex-1 py-4 text-center min-w-[150px]"><i class="fas fa-cash-register mr-2"></i> Closing & Bank</div>
            <div onclick="switchTab('analytics')" id="tab-analytics" class="nav-item flex-1 py-4 text-center min-w-[150px]"><i class="fas fa-chart-line mr-2"></i> Analisis Toko</div>
            <div onclick="switchTab('data')" id="tab-data" class="nav-item flex-1 py-4 text-center min-w-[150px]"><i class="fas fa-table mr-2"></i> Data Transaksi</div>
        </div>

        <!-- ERROR BANNER (GLOBAL) -->
        <div id="global-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">Koneksi Bermasalah!</strong>
            <span class="block sm:inline"> Gagal mengambil data. Pastikan Anda login dengan akun Manager dan Rules Database sudah diperbarui.</span>
        </div>

        <!-- TAB 1: OPERASIONAL -->
        <div id="view-ops" class="tab-view fade-in">
            <!-- Shift Summaries -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Grand Total -->
                <div class="glass-card p-5 border-l-4 border-purple-600 bg-purple-50 relative overflow-hidden">
                    <div class="flex justify-between items-start">
                        <div><span class="text-xs font-bold text-purple-600 uppercase tracking-wider">Total Hari Ini</span><div class="text-2xl font-black text-slate-800 mt-1" id="grand-total">Rp 0</div></div>
                        <i class="fas fa-coins text-purple-200 text-3xl absolute top-4 right-4"></i>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-4 text-xs border-t border-purple-200 pt-2">
                        <div><span class="text-slate-500 block">Cash</span><span id="grand-cash" class="font-bold text-slate-700">0</span></div>
                        <div><span class="text-slate-500 block">QRIS</span><span id="grand-qris" class="font-bold text-green-600">0</span></div>
                    </div>
                </div>
                <!-- Shift 1 -->
                <div class="glass-card p-5 border-l-4 border-yellow-400 relative overflow-hidden">
                    <div class="flex justify-between items-start"><div><span class="text-xs font-bold text-slate-400 uppercase">Shift 1 (Pagi)</span><div class="text-xl font-bold text-slate-800 mt-1" id="s1-total">Rp 0</div></div><span class="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-1 rounded font-bold">08:00 - 16:00</span></div>
                    <div class="grid grid-cols-2 gap-2 mt-4 text-xs border-t pt-2 border-slate-100"><div><span class="text-slate-400 block">Cash</span><span id="s1-cash" class="font-bold text-slate-700">0</span></div><div><span class="text-slate-400 block">QRIS</span><span id="s1-qris" class="font-bold text-green-600">0</span></div></div>
                </div>
                <!-- Shift 2 -->
                <div class="glass-card p-5 border-l-4 border-orange-400 relative overflow-hidden">
                    <div class="flex justify-between items-start"><div><span class="text-xs font-bold text-slate-400 uppercase">Shift 2 (Sore)</span><div class="text-xl font-bold text-slate-800 mt-1" id="s2-total">Rp 0</div></div><span class="bg-orange-100 text-orange-800 text-[10px] px-2 py-1 rounded font-bold">16:00 - 23:00</span></div>
                    <div class="grid grid-cols-2 gap-2 mt-4 text-xs border-t pt-2 border-slate-100"><div><span class="text-slate-400 block">Cash</span><span id="s2-cash" class="font-bold text-slate-700">0</span></div><div><span class="text-slate-400 block">QRIS</span><span id="s2-qris" class="font-bold text-green-600">0</span></div></div>
                </div>
                <!-- Shift 3 -->
                <div class="glass-card p-5 border-l-4 border-blue-500 relative overflow-hidden">
                    <div class="flex justify-between items-start"><div><span class="text-xs font-bold text-slate-400 uppercase">Shift 3 (Malam)</span><div class="text-xl font-bold text-slate-800 mt-1" id="s3-total">Rp 0</div></div><span class="bg-blue-100 text-blue-800 text-[10px] px-2 py-1 rounded font-bold">23:00 - 08:00</span></div>
                    <div class="grid grid-cols-2 gap-2 mt-4 text-xs border-t pt-2 border-slate-100"><div><span class="text-slate-400 block">Cash</span><span id="s3-cash" class="font-bold text-slate-700">0</span></div><div><span class="text-slate-400 block">QRIS</span><span id="s3-qris" class="font-bold text-green-600">0</span></div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Closing Calculator -->
                <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-calculator text-blue-500"></i> Closing Kasir</h3>
                        <button onclick="resetCalculator()" class="text-xs bg-slate-200 hover:bg-slate-300 px-3 py-1 rounded transition">Reset Manual</button>
                    </div>
                    
                    <!-- Shift Selector -->
                    <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                        <button onclick="setShift('s1', this)" class="shift-btn flex-1 py-2 px-3 rounded text-xs font-bold border transition text-slate-600 hover:bg-blue-50">S1</button>
                        <button onclick="setShift('s2', this)" class="shift-btn flex-1 py-2 px-3 rounded text-xs font-bold border transition text-slate-600 hover:bg-blue-50">S2</button>
                        <button onclick="setShift('s3', this)" class="shift-btn flex-1 py-2 px-3 rounded text-xs font-bold border transition text-slate-600 hover:bg-blue-50">S3</button>
                        <button onclick="setShift('all', this)" class="shift-btn flex-1 py-2 px-3 rounded text-xs font-bold bg-blue-600 text-white shadow-md border-blue-600">ALL</button>
                    </div>

                    <!-- Auto-filled Badge -->
                    <div id="auto-fill-badge" class="hidden mb-4 bg-green-100 border border-green-300 text-green-800 px-3 py-2 rounded-lg text-xs flex flex-col gap-1">
                        <div class="flex items-center gap-2 font-bold"><i class="fas fa-check-circle"></i> Data Terintegrasi Absensi</div>
                        <div class="flex justify-between">
                            <span>Kasir: <strong id="reporter-name">...</strong></span>
                            <span id="report-status-badge" class="bg-green-200 px-2 rounded text-[10px]">Shift Berjalan</span>
                        </div>
                    </div>
                    <div id="no-data-badge" class="hidden mb-4 bg-gray-100 border border-gray-300 text-gray-500 px-3 py-2 rounded-lg text-xs text-center">
                        Belum ada data absensi kasir untuk shift ini.
                    </div>

                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Modal Awal</label>
                                <input type="number" id="input-modal-awal" oninput="calculateClosing()" class="w-full p-2 border rounded text-right font-mono text-sm outline-none focus:border-blue-500" placeholder="0">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Bon / Pengeluaran</label>
                                <input type="number" id="input-pengeluaran" oninput="calculateClosing()" class="w-full p-2 border rounded text-right font-mono text-sm text-orange-600 outline-none focus:border-orange-500" placeholder="0">
                                <div id="expense-desc-display" class="text-[9px] text-right text-orange-400 mt-1 italic truncate"></div>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Total Uang Fisik (Hitungan Akhir)</label>
                            <input type="number" id="input-fisik-akhir" oninput="calculateClosing()" class="w-full p-3 border-2 border-blue-200 rounded text-right font-bold text-lg outline-none focus:border-blue-500" placeholder="0">
                        </div>
                        
                        <!-- Hasil -->
                        <div class="bg-slate-50 p-4 rounded-xl border mt-2">
                            <div class="flex justify-between text-xs mb-2"><span class="text-slate-500">Target Sistem (Cash):</span><span id="system-cash-display" class="font-bold text-slate-700">Rp 0</span></div>
                            <div class="flex justify-between text-xs mb-2 border-b border-slate-200 pb-2"><span class="text-slate-500">Target Fisik (Laci - Modal + Bon):</span><span id="calculated-physical-revenue" class="font-bold text-blue-600">Rp 0</span></div>
                            <div class="flex justify-between items-center pt-2"><span class="font-bold text-slate-700 text-sm">Selisih (Variance):</span><div class="text-right"><span id="variance-amount" class="block font-black text-xl text-slate-400">Rp 0</span><span id="variance-status" class="text-[10px] bg-slate-200 px-2 py-0.5 rounded text-slate-500 font-bold">Menunggu Input</span></div></div>
                        </div>
                    </div>
                </div>

                <!-- Bank Control -->
                <div class="glass-card p-6">
                    <h3 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center gap-2"><i class="fas fa-university text-green-600"></i> Kontrol Bank & QRIS</h3>
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100 mb-6"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-green-800 uppercase">Total QRIS Hari Ini</span><i class="fas fa-qrcode text-green-600 opacity-50"></i></div><div class="flex justify-between items-end"><span id="bank-qris-system" class="text-2xl font-black text-green-700">Rp 0</span><div class="text-right"><p class="text-[10px] text-green-600">Est. Bersih (MDR 0.7%)</p><p id="est-net-receive" class="font-bold text-green-800">Rp 0</p></div></div></div>
                    <form onsubmit="submitBankExpense(event)" class="space-y-3 bg-white p-1 rounded"><p class="text-xs font-bold text-slate-400 uppercase">Catat Pengeluaran Transfer</p><div class="flex gap-2"><input type="text" id="expense-desc" required placeholder="Ket (Misal: Beli Gula)" class="flex-1 p-2 border rounded text-sm outline-none focus:border-blue-500"><input type="number" id="expense-amount" required placeholder="Rp" class="w-24 p-2 border rounded text-sm outline-none focus:border-blue-500"></div><button type="submit" id="btn-save-expense" class="w-full bg-slate-800 text-white py-2 rounded text-xs font-bold hover:bg-slate-700 transition">Simpan Catatan</button></form><div class="mt-4 max-h-32 overflow-y-auto space-y-1" id="bank-expense-list"></div>
                </div>
            </div>
        </div>

        <!-- TAB 2: ANALISIS -->
        <div id="view-analytics" class="tab-view hidden fade-in">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6 flex flex-wrap items-center gap-4"><div class="flex items-center gap-2"><span class="text-xs font-bold text-slate-500">Dari:</span><input type="date" id="ana-start-date" class="p-2 border rounded text-sm"></div><div class="flex items-center gap-2"><span class="text-xs font-bold text-slate-500">Sampai:</span><input type="date" id="ana-end-date" class="p-2 border rounded text-sm"></div><button onclick="loadHistoricalData()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow">Tampilkan Data</button></div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="glass-card p-6 lg:col-span-2"><h3 class="font-bold text-slate-700 mb-4"><i class="fas fa-clock text-blue-500"></i> Jam Ramai</h3><div class="h-80 w-full"><canvas id="hourlyChart"></canvas></div></div><div class="glass-card p-6"><h3 class="font-bold text-slate-700 mb-4"><i class="fas fa-crown text-yellow-500"></i> Menu Terlaris</h3><div class="space-y-2 overflow-y-auto h-80 pr-2" id="top-items-list"></div></div></div>
        </div>

        <!-- TAB 3: DATA -->
        <div id="view-data" class="tab-view hidden fade-in">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6 flex flex-wrap items-center gap-4 justify-between"><div class="flex gap-4"><div class="flex items-center gap-2"><span class="text-xs font-bold text-slate-500">Dari:</span><input type="date" id="rep-start-date" class="p-2 border rounded text-sm"></div><div class="flex items-center gap-2"><span class="text-xs font-bold text-slate-500">Sampai:</span><input type="date" id="rep-end-date" class="p-2 border rounded text-sm"></div><button onclick="loadReportData()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow">Cari</button></div><button onclick="downloadReportCSV()" class="text-xs bg-green-600 text-white px-3 py-2 rounded font-bold hover:bg-green-700 flex items-center gap-2 shadow"><i class="fas fa-file-excel"></i> Export CSV</button></div>
            <div class="glass-card overflow-hidden"><div class="p-4 bg-slate-50 border-b border-slate-200"><h3 class="font-bold text-slate-700" id="report-title">Hasil Pencarian</h3></div><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-white text-slate-500 text-xs uppercase font-bold border-b"><tr><th class="p-4">Waktu</th><th class="p-4">Customer</th><th class="p-4">Items</th><th class="p-4">Metode</th><th class="p-4 text-right">Total</th></tr></thead><tbody id="report-table-body" class="divide-y divide-slate-100 text-slate-600"><tr><td colspan="5" class="p-6 text-center italic text-slate-400">Silakan pilih tanggal.</td></tr></tbody><tfoot class="bg-slate-50 font-bold text-slate-700"><tr><td colspan="4" class="p-4 text-right">TOTAL:</td><td class="p-4 text-right" id="report-total-sum">Rp 0</td></tr></tfoot></table></div></div>
        </div>

        <input type="hidden" id="active-shift-filter" value="all">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, orderBy, addDoc, serverTimestamp, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyB0nHqdAw_dV9pHcQ_cSnWtNsn4CwwwUNc", authDomain: "payboss-cafe-system.firebaseapp.com", projectId: "payboss-cafe-system", storageBucket: "payboss-cafe-system.appspot.com", messagingSenderId: "570523503793", appId: "1:570523503793:web:0a7ba7ce751eb95a3f6690" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);

        let allOrdersToday = []; let allShiftReports = [];
        let systemCashTotal = 0; let systemQrisTotalFullDay = 0; let chartInstance = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('main-content').classList.remove('filter', 'blur-md', 'pointer-events-none');
                initDailyDashboard();
                
                const todayStr = new Date().toISOString().slice(0,10);
                document.getElementById('ana-start-date').value = todayStr;
                document.getElementById('ana-end-date').value = todayStr;
                document.getElementById('rep-start-date').value = todayStr;
                document.getElementById('rep-end-date').value = todayStr;
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
                document.getElementById('main-content').classList.add('filter', 'blur-md', 'pointer-events-none');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } 
            catch (error) { document.getElementById('login-error').classList.remove('hidden'); }
        });
        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-view').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-'+tab).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
        }

        function initDailyDashboard() {
            const today = new Date(); today.setHours(0,0,0,0);
            document.getElementById('header-date').textContent = today.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long'});
            
            // 1. Listen ORDERS (Added error handling)
            onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), (snapshot) => {
                allOrdersToday = []; systemQrisTotalFullDay = 0;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (!data.createdAt) return;
                    const orderDate = data.createdAt.toDate();
                    if (orderDate.getTime() >= today.getTime() || (orderDate.getHours() < 8 && orderDate.getDate() === new Date().getDate())) {
                        const formattedTime = doc.data().createdAt.toDate().toLocaleTimeString('id-ID', {hour12: false, hour: '2-digit', minute:'2-digit'});
                        allOrdersToday.push({ ...data, formattedTime, rawDate: orderDate });
                        if(orderDate.getDate() === new Date().getDate() && (data.paymentMethod||'').toLowerCase().includes('qris')) {
                            systemQrisTotalFullDay += (data.total || 0);
                        }
                    }
                });
                updateShiftCards(); updateBankPanel(); applyFilter();
            }, (error) => {
                console.error("Orders Listener Error:", error);
                if(error.code === 'permission-denied') document.getElementById('global-error').classList.remove('hidden');
            });

            // 2. Listen SHIFT REPORTS (Added error handling)
            onSnapshot(query(collection(db, "shift_reports"), orderBy("timestamp", "desc")), (snapshot) => {
                allShiftReports = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(!d.timestamp) return;
                    if(d.timestamp.toDate().getTime() >= today.getTime() - (12*60*60*1000)) { 
                        const tStr = d.timestamp.toDate().toLocaleTimeString('id-ID', {hour12: false, hour: '2-digit', minute:'2-digit'});
                        allShiftReports.push({ ...d, timeStr: tStr });
                    }
                });
                applyFilter();
            }, (error) => {
                console.error("Shift Reports Listener Error:", error);
                if(error.code === 'permission-denied') document.getElementById('global-error').classList.remove('hidden');
            });

            // 3. Listen Bank Expenses (Added error handling)
            onSnapshot(query(collection(db, "bank_expenses"), orderBy("timestamp", "desc")), (snap) => {
                const list = document.getElementById('bank-expense-list'); list.innerHTML = '';
                let has = false;
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.timestamp && d.timestamp.toDate().setHours(0,0,0,0) === today.getTime()) {
                        has = true;
                        list.innerHTML += `<div class="flex justify-between text-xs bg-red-50 p-2 rounded border border-red-100 mb-1 items-center"><span>${d.desc}</span><span class="font-bold text-red-500">- Rp ${d.amount.toLocaleString('id-ID')}</span></div>`;
                    }
                });
                if(!has) list.innerHTML = '<p class="text-xs text-gray-400 text-center italic mt-4">Belum ada data.</p>';
            }, (error) => {
                console.error("Bank Expenses Listener Error:", error);
                if(error.code === 'permission-denied') document.getElementById('global-error').classList.remove('hidden');
            });
        }

        // SHIFT MAPPING
        function getShift(timeStr) {
            if (timeStr >= '08:00' && timeStr < '16:00') return 's1';
            if (timeStr >= '16:00' && timeStr < '23:00') return 's2';
            if (timeStr >= '23:00' || timeStr < '08:00') return 's3';
            return null;
        }

        function updateShiftCards() {
            let s1={t:0,c:0,q:0}, s2={t:0,c:0,q:0}, s3={t:0,c:0,q:0}, grand={t:0,c:0,q:0};
            const todayDate = new Date().getDate();
            allOrdersToday.forEach(o => {
                const t = o.formattedTime; const amt = o.total||0; const isQris = (o.paymentMethod||'').toLowerCase().includes('qris');
                const shift = getShift(t); const d = o.rawDate.getDate();
                if (d !== todayDate && shift !== 's3') return; 
                if (shift==='s1') { s1.t+=amt; isQris?s1.q+=amt:s1.c+=amt; }
                else if (shift==='s2') { s2.t+=amt; isQris?s2.q+=amt:s2.c+=amt; }
                else if (shift==='s3') { s3.t+=amt; isQris?s3.q+=amt:s3.c+=amt; }
                grand.t+=amt; isQris?grand.q+=amt:grand.c+=amt;
            });
            const fmt = n => n.toLocaleString('id-ID');
            document.getElementById('grand-total').innerText = 'Rp '+fmt(grand.t); document.getElementById('grand-cash').innerText = fmt(grand.c); document.getElementById('grand-qris').innerText = fmt(grand.q);
            document.getElementById('s1-total').innerText = 'Rp '+fmt(s1.t); document.getElementById('s1-cash').innerText = fmt(s1.c); document.getElementById('s1-qris').innerText = fmt(s1.q);
            document.getElementById('s2-total').innerText = 'Rp '+fmt(s2.t); document.getElementById('s2-cash').innerText = fmt(s2.c); document.getElementById('s2-qris').innerText = fmt(s2.q);
            document.getElementById('s3-total').innerText = 'Rp '+fmt(s3.t); document.getElementById('s3-cash').innerText = fmt(s3.c); document.getElementById('s3-qris').innerText = fmt(s3.q);
        }

        window.setShift = (sc, btn) => {
            document.getElementById('active-shift-filter').value = sc;
            document.querySelectorAll('.shift-btn').forEach(b => { b.classList.remove('bg-blue-600','text-white','shadow-md'); b.classList.add('text-slate-600'); });
            if(btn) { btn.classList.remove('text-slate-600'); btn.classList.add('bg-blue-600','text-white','shadow-md'); }
            applyFilter();
        }

        window.applyFilter = () => {
            const sc = document.getElementById('active-shift-filter').value;
            const todayDate = new Date().getDate();
            const filtered = allOrdersToday.filter(o => {
                if (o.rawDate.getDate() !== todayDate && getShift(o.formattedTime) !== 's3') return false;
                return sc === 'all' || getShift(o.formattedTime) === sc;
            });
            let cash = 0;
            filtered.forEach(o => { if(!(o.paymentMethod||'').toLowerCase().includes('qris')) cash += (o.total||0); });
            systemCashTotal = cash;
            document.getElementById('system-cash-display').innerText = `Rp ${cash.toLocaleString('id-ID')}`;

            if (sc !== 'all') {
                const report = allShiftReports.find(r => getShift(r.timeStr) === sc && r.type.includes('end'));
                const startReport = allShiftReports.find(r => getShift(r.timeStr) === sc && r.type.includes('start'));
                if (report) {
                    document.getElementById('input-fisik-akhir').value = report.cash_end || 0;
                    document.getElementById('input-pengeluaran').value = report.expenses || 0;
                    document.getElementById('auto-fill-badge').classList.remove('hidden');
                    document.getElementById('reporter-name').innerText = report.employee;
                    document.getElementById('expense-desc-display').innerText = report.expense_notes ? `"${report.expense_notes}"` : '';
                }
                if (startReport) document.getElementById('input-modal-awal').value = startReport.cash_start || 0;
                if (!report && !startReport) {
                    document.getElementById('auto-fill-badge').classList.add('hidden');
                    document.getElementById('no-data-badge').classList.remove('hidden');
                } else {
                    document.getElementById('no-data-badge').classList.add('hidden');
                }
            } else {
                document.getElementById('auto-fill-badge').classList.add('hidden');
                document.getElementById('no-data-badge').classList.add('hidden');
            }
            calculateClosing();
        }

        window.calculateClosing = () => {
            const modal = parseFloat(document.getElementById('input-modal-awal').value)||0;
            const laci = parseFloat(document.getElementById('input-fisik-akhir').value)||0;
            const bon = parseFloat(document.getElementById('input-pengeluaran').value)||0;
            const fisik = (laci - modal) + bon;
            const selisih = fisik - systemCashTotal;
            document.getElementById('calculated-physical-revenue').innerText = `Rp ${fisik.toLocaleString('id-ID')}`;
            const elAmt = document.getElementById('variance-amount');
            const elSts = document.getElementById('variance-status');
            elAmt.innerText = `Rp ${selisih.toLocaleString('id-ID')}`;
            if(document.getElementById('input-fisik-akhir').value=='') { elAmt.className="block font-black text-xl text-slate-400"; elSts.innerText="Menunggu Input"; elSts.className="text-[10px] bg-slate-200 px-2 py-0.5 rounded text-slate-500"; }
            else if(selisih==0) { elAmt.className="block font-black text-xl text-green-600"; elSts.innerText="KLOP"; elSts.className="text-[10px] bg-green-100 px-2 py-0.5 rounded text-green-800 font-bold"; }
            else if(selisih<0) { elAmt.className="block font-black text-xl text-red-600"; elSts.innerText="MINUS"; elSts.className="text-[10px] bg-red-100 px-2 py-0.5 rounded text-red-800 font-bold"; }
            else { elAmt.className="block font-black text-xl text-blue-600"; elSts.innerText="SURPLUS"; elSts.className="text-[10px] bg-blue-100 px-2 py-0.5 rounded text-blue-800 font-bold"; }
        }
        window.resetCalculator = () => { document.getElementById('input-modal-awal').value=''; document.getElementById('input-fisik-akhir').value=''; document.getElementById('input-pengeluaran').value=''; calculateClosing(); }
        function updateBankPanel() { document.getElementById('bank-qris-system').innerText = `Rp ${systemQrisTotalFullDay.toLocaleString('id-ID')}`; document.getElementById('est-net-receive').innerText = `Rp ${Math.round(systemQrisTotalFullDay * 0.993).toLocaleString('id-ID')}`; }
        window.submitBankExpense = async (e) => { e.preventDefault(); try { await addDoc(collection(db, "bank_expenses"), { desc: document.getElementById('expense-desc').value, amount: parseFloat(document.getElementById('expense-amount').value), timestamp: serverTimestamp(), user: auth.currentUser.email }); document.getElementById('expense-desc').value=''; document.getElementById('expense-amount').value=''; alert("Tersimpan!"); } catch(e) { alert(e.message); } }
        
        window.loadHistoricalData = async function() {
            const startVal = document.getElementById('ana-start-date').value;
            const endVal = document.getElementById('ana-end-date').value;
            if (!startVal || !endVal) return alert("Pilih tanggal.");
            const start = new Date(startVal); const end = new Date(endVal); end.setHours(23, 59, 59, 999);
            const q = query(collection(db, "orders"), where("createdAt", ">=", Timestamp.fromDate(start)), where("createdAt", "<=", Timestamp.fromDate(end)), orderBy("createdAt", "desc"));
            try {
                const snapshot = await getDocs(q); let itemCounts = {}; let hourlySales = new Array(24).fill(0);
                snapshot.forEach(doc => {
                    const data = doc.data(); const date = data.createdAt.toDate();
                    hourlySales[date.getHours()] += (data.total || 0);
                    if (data.items && Array.isArray(data.items)) data.items.forEach(item => { const name = item.name + (item.variant ? ` (${item.variant})` : ''); itemCounts[name] = (itemCounts[name] || 0) + (item.qty || 1); });
                });
                updateCharts(hourlySales);
                const sorted = Object.entries(itemCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
                document.getElementById('top-items-list').innerHTML = sorted.length ? sorted.map(([n,c],i) => `<div class="flex justify-between p-2 border-b"><div class="flex gap-2"><span class="font-bold w-5">${i+1}</span><span>${n}</span></div><span class="bg-blue-100 px-2 rounded font-bold text-blue-700 text-xs">${c}x</span></div>`).join('') : '<p class="text-center text-sm text-gray-400 mt-4">Tidak ada data.</p>';
            } catch (error) { alert(error.message); }
        }
        function updateCharts(data) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'bar', data: { labels: Array.from({length:24}, (_,i)=>`${String(i).padStart(2,'0')}:00`), datasets: [{ label: 'Total (Rp)', data: data, backgroundColor: '#3b82f6', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x: { grid:{display:false} }, y: { grid:{borderDash:[4,4]} } } } });
        }
        window.loadReportData = async function() {
            const startVal = document.getElementById('rep-start-date').value;
            const endVal = document.getElementById('rep-end-date').value;
            if (!startVal || !endVal) return alert("Pilih tanggal.");
            const start = new Date(startVal); const end = new Date(endVal); end.setHours(23, 59, 59, 999);
            const tbody = document.getElementById('report-table-body'); tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center italic text-slate-400">Memuat...</td></tr>';
            const q = query(collection(db, "orders"), where("createdAt", ">=", Timestamp.fromDate(start)), where("createdAt", "<=", Timestamp.fromDate(end)), orderBy("createdAt", "desc"));
            try {
                const snapshot = await getDocs(q); let total = 0; let html = ''; let reportOrders = [];
                snapshot.forEach(doc => {
                    const d = doc.data(); const tStr = d.createdAt.toDate().toLocaleTimeString('id-ID', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'});
                    const iStr = (d.items||[]).map(i=>`${i.qty}x ${i.name}`).join(', '); reportOrders.push({...d, tStr, iStr}); total += (d.total||0);
                    html += `<tr class="hover:bg-slate-50 border-b"><td class="p-4 text-xs">${tStr}</td><td class="p-4 font-bold">${d.customer}</td><td class="p-4 text-xs truncate max-w-[150px]">${iStr}</td><td class="p-4">${d.paymentMethod}</td><td class="p-4 text-right font-bold">Rp ${(d.total||0).toLocaleString('id-ID')}</td></tr>`;
                });
                tbody.innerHTML = html || '<tr><td colspan="5" class="p-6 text-center italic text-slate-400">Tidak ada data.</td></tr>'; document.getElementById('report-total-sum').innerText = `Rp ${total.toLocaleString('id-ID')}`; window.currentReportData = reportOrders;
            } catch (e) { alert(e.message); }
        }
        window.downloadReportCSV = function() { if (!window.currentReportData || window.currentReportData.length === 0) return alert("Tampilkan data dulu."); let csv = "Waktu,Customer,Items,Metode,Total\n"; window.currentReportData.forEach(o => csv += `${o.tStr},"${o.customer}","${o.itemsStr}",${o.paymentMethod},${o.total}\n`); const link = document.createElement("a"); link.href = "data:text/csv;charset=utf-8," + encodeURI(csv); link.download = "Laporan_Payboss.csv"; link.click(); }
    </script>
</body>
</html>
```I made some changes.
I've updated the `dashboard_keuangan.html` to handle the "permission denied" errors gracefully. I added `.catch()` blocks or error callbacks to all Firestore snapshot listeners (`onSnapshot`) within `initDailyDashboard`. Now, if permissions fail (e.g., due to Rules issues or auth state), the console won't crash with an uncaught exception, and a user-friendly "Connection Issue" banner will appear at the top of the dashboard. I also double-checked the shift logic to ensure it aligns with your specified hours.
