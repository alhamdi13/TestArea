<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PayBoss Cafe - Absensi Selfie & GPS</title>
  <style>
    :root {
      --primary: #8b4513;
      --primary-dark: #5c2e0c;
      --accent: #f4a261;
      --bg: linear-gradient(135deg, #8b4513 0%, #d2b48c 100%);
      --card-bg: rgba(255, 255, 255, 0.12);
      --card-border: rgba(255, 255, 255, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1f2933;
    }

    .app-wrapper {
      width: 100%;
      max-width: 960px;
      padding: 16px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 20px;
      border: 1px solid var(--card-border);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(18px);
      padding: 20px 20px 16px;
      color: #ffffff;
    }

    @media (min-width: 768px) {
      .card {
        padding: 24px 28px 20px;
      }
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .title-group h1 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: 0.03em;
    }

    .title-group p {
      margin: 4px 0 0;
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .badge {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(0, 0, 0, 0.06);
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #4ade80;
      box-shadow: 0 0 0 4px rgba(74, 222, 128, 0.25);
    }

    .layout {
      display: grid;
      grid-template-columns: 1.1fr;
      gap: 16px;
    }

    @media (min-width: 920px) {
      .layout {
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      }
    }

    .section-title {
      font-size: 0.9rem;
      margin: 0 0 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.9;
    }

    .section-subtitle {
      font-size: 0.75rem;
      margin: 0 0 10px;
      opacity: 0.8;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }

    label {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    input[type="text"],
    select,
    textarea {
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      background: rgba(0, 0, 0, 0.15);
      color: #f9fafb;
      font-size: 0.85rem;
      outline: none;
      width: 100%;
      resize: vertical;
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(249, 250, 251, 0.55);
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #fbbf77;
      box-shadow: 0 0 0 1px rgba(248, 196, 113, 0.7);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 10px;
      margin-top: 6px;
      font-size: 0.75rem;
    }

    .info-pill {
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.25);
      border: 1px dashed rgba(255, 255, 255, 0.4);
    }

    .info-label {
      opacity: 0.7;
      margin-bottom: 2px;
    }

    .info-value {
      font-weight: 600;
      font-size: 0.8rem;
    }

    button {
      font-family: inherit;
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #f4a261;
      color: #1f2933;
      font-weight: 600;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.25);
    }

    .btn-primary:hover {
      background: #f6ad74;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(0, 0, 0, 0.35);
      color: #f9fafb;
      border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .btn-secondary:hover {
      background: rgba(0, 0, 0, 0.5);
    }

    .btn-icon {
      font-size: 1.1rem;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .location-status {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 0.78rem;
      border: 1px solid rgba(255, 255, 255, 0.45);
      background: rgba(0, 0, 0, 0.25);
      min-height: 40px;
    }

    .location-status.error {
      border-color: #fecaca;
      background: rgba(127, 29, 29, 0.65);
    }

    .location-status.success {
      border-color: #bbf7d0;
      background: rgba(20, 83, 45, 0.7);
    }

    .location-status span.label {
      opacity: 0.8;
      margin-right: 4px;
    }

    .location-status strong {
      font-weight: 600;
    }

    .camera-frame {
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      overflow: hidden;
      background: rgba(0, 0, 0, 0.65);
      position: relative;
      aspect-ratio: 3/4;
      max-height: 360px;
    }

    .camera-frame video,
    .camera-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .camera-overlay {
      position: absolute;
      inset: 0;
      border-radius: 16px;
      box-shadow:
        0 0 0 999px rgba(0, 0, 0, 0.25),
        0 0 0 2px rgba(255, 255, 255, 0.8);
      margin: 20px;
      border-radius: 999px;
      pointer-events: none;
    }

    .camera-hint {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.65);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .dot-rec {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f97373;
      box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.6);
      animation: pulse 1.2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.6;
      }
    }

    .camera-actions {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .submit-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px dashed rgba(255, 255, 255, 0.35);
    }

    .submit-helper {
      font-size: 0.72rem;
      opacity: 0.8;
      max-width: 280px;
    }

    .result-panel {
      margin-top: 12px;
      border-radius: 14px;
      padding: 8px 10px;
      background: rgba(0, 0, 0, 0.4);
      font-size: 0.72rem;
      max-height: 240px;
      overflow: auto;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .result-panel pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .hidden {
      display: none !important;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.35);
      font-size: 0.7rem;
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #facc15;
    }

    .mode-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .btn-mode {
      font-size: 0.78rem;
      padding: 6px 10px;
    }

    .btn-mode-active {
      background: #f4a261;
      color: #1f2933;
      border-color: rgba(255, 255, 255, 0.8);
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <div class="card">
      <header class="card-header">
        <div class="title-group">
          <h1>PayBoss Cafe &mdash; Absensi Selfie &amp; GPS</h1>
          <p>Absensi karyawan dengan bukti foto &amp; lokasi langsung di titik kerja.</p>
        </div>
        <div class="badge" id="badge-date">
          <span class="badge-dot"></span>
          <span><span id="today-date">&mdash;</span></span>
        </div>
      </header>

      <form id="attendance-form" autocomplete="off">
        <div class="layout">
          <!-- Kolom Kiri: Data Karyawan & Lokasi -->
          <div>
            <h2 class="section-title">Data Karyawan</h2>
            <p class="section-subtitle">Isi identitas singkat sebelum ambil lokasi &amp; selfie.</p>

            <div class="field-group">
              <label for="employee-name">Nama Karyawan</label>
              <input
                type="text"
                id="employee-name"
                name="employeeName"
                placeholder="Contoh: Zahra, Rian, Ikhsan"
                required
              />
            </div>

            <div class="field-group">
              <label for="employee-id">ID / NIK / Username Absensi</label>
              <input
                type="text"
                id="employee-id"
                name="employeeId"
                placeholder="Contoh: PB-001"
                required
              />
            </div>

            <div class="field-group">
              <label for="employee-role">Posisi</label>
              <select id="employee-role" name="employeeRole" required>
                <option value="">Pilih posisi...</option>
                <option value="Kasir">Kasir</option>
                <option value="Barista">Barista</option>
                <option value="Waitress">Waitress</option>
                <option value="Koki">Koki</option>
                <option value="Koordinator">Koordinator / Supervisor</option>
                <option value="Lainnya">Lainnya</option>
              </select>
            </div>

            <div class="field-group">
              <label for="shift">Shift</label>
              <select id="shift" name="shift" required>
                <option value="">Pilih shift...</option>
                <option value="Shift-1">Shift 1 (08:00 - 16:00)</option>
                <option value="Shift-2">Shift 2 (16:00 - 24:00)</option>
                <option value="Shift-3">Shift 3 (00:00 - 08:00)</option>
              </select>
            </div>

            <h2 class="section-title" style="margin-top: 14px;">Mode Absensi</h2>
            <p class="section-subtitle">Default: On Site (wajib selfie). Jika kamera bermasalah, gunakan mode Absen di Luar Area.</p>

            <div class="field-group">
              <label>Jenis absensi</label>
              <div class="mode-row">
                <button type="button" class="btn-secondary btn-mode" id="btn-mode-onsite">On Site (Default)</button>
                <button type="button" class="btn-secondary btn-mode" id="btn-mode-outarea">Absen di Luar Area</button>
              </div>
              <div class="location-status" id="outarea-info">
                <span class="label">Info:</span>
                <span>Mode normal (On Site). Selfie &amp; GPS di titik kerja wajib sebelum kirim absensi.</span>
              </div>
            </div>

            <div class="field-group hidden" id="outarea-reason-group">
              <label for="outarea-reason">Alasan Absen di Luar Area</label>
              <textarea
                id="outarea-reason"
                name="outOfAreaReason"
                placeholder="Contoh: Kamera HP rusak / jaringan bermasalah / tugas di luar lokasi cafe"
                rows="2"
              ></textarea>
            </div>

            <h2 class="section-title" style="margin-top: 8px;">Lokasi On The Spot</h2>
            <p class="section-subtitle">Tekan tombol di bawah saat sudah berada di lokasi kerja (cafe / karaoke / billiard / luar area).</p>

            <button type="button" class="btn-secondary" id="btn-location">
              <span class="btn-icon">üìç</span>
              <span>Ambil Lokasi Saya Sekarang</span>
            </button>

            <div class="location-status" id="location-status">
              <span class="label">Status:</span>
              <span>Belum ada lokasi. Pastikan GPS diaktifkan &amp; akses lokasi diizinkan.</span>
            </div>

            <div class="info-grid">
              <div class="info-pill">
                <div class="info-label">Latitude</div>
                <div class="info-value" id="lat-value">&mdash;</div>
              </div>
              <div class="info-pill">
                <div class="info-label">Longitude</div>
                <div class="info-value" id="lng-value">&mdash;</div>
              </div>
              <div class="info-pill">
                <div class="info-label">Akurasi</div>
                <div class="info-value" id="acc-value">&mdash;</div>
              </div>
              <div class="info-pill">
                <div class="info-label">Jarak ke Titik</div>
                <div class="info-value" id="dist-value">&mdash;</div>
              </div>
            </div>

            <!-- Hidden fields lokasi untuk dikirim ke backend -->
            <input type="hidden" id="lat-hidden" name="latitude" />
            <input type="hidden" id="lng-hidden" name="longitude" />
            <input type="hidden" id="acc-hidden" name="accuracy" />
          </div>

          <!-- Kolom Kanan: Kamera / Selfie -->
          <div>
            <h2 class="section-title">Selfie Kehadiran</h2>
            <p class="section-subtitle">Selfie wajib untuk mode On Site. Di mode Luar Area, selfie opsional namun tetap disarankan.</p>

            <div class="camera-frame" id="camera-frame">
              <video id="video" autoplay playsinline class="hidden"></video>
              <img id="selfie-preview" alt="Preview selfie" class="hidden" />
              <div class="camera-overlay" id="camera-overlay"></div>
              <div class="camera-hint" id="camera-hint">
                <span class="dot-rec"></span>
                <span>Aktifkan kamera &amp; posisikan wajah di lingkaran.</span>
              </div>
            </div>

            <canvas id="canvas" class="hidden"></canvas>

            <div class="camera-actions">
              <button type="button" class="btn-secondary" id="btn-start-camera">
                <span class="btn-icon">üé•</span>
                <span>Nyalakan Kamera</span>
              </button>

              <button type="button" class="btn-primary" id="btn-capture" disabled>
                <span class="btn-icon">üì∏</span>
                <span>Ambil Selfie</span>
              </button>

              <button type="button" class="btn-secondary" id="btn-retake" disabled>
                <span class="btn-icon">üîÅ</span>
                <span>Ulangi</span>
              </button>
            </div>

            <div style="margin-top: 8px; font-size: 0.7rem; opacity: 0.85; display: flex; gap: 6px; flex-wrap: wrap;">
              <div class="pill">
                <span class="pill-dot"></span>
                <span>Gunakan HP &amp; izinkan akses kamera + lokasi.</span>
              </div>
              <div class="pill">
                <span class="pill-dot" style="background:#22c55e;"></span>
                <span>Data foto &amp; GPS siap dikirim ke database / Google Sheet.</span>
              </div>
            </div>
          </div>
        </div>

        <div class="submit-row">
          <div class="submit-helper">
            Mode <strong>On Site</strong>: wajib nama, ID, posisi, shift, lokasi (dalam radius 200 m) &amp; selfie.<br />
            Mode <strong>Luar Area</strong>: wajib nama, ID, posisi, shift, lokasi &amp; alasan.
          </div>
          <button type="submit" class="btn-primary" id="btn-submit" disabled>
            <span class="btn-icon">‚úÖ</span>
            <span>Kirim Absensi</span>
          </button>
        </div>

        <div class="result-panel hidden" id="result-panel">
          <pre id="result-output"></pre>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Titik referensi PayBoss Cafe (dari link maps)
    const BASE_LAT = -2.1717546572371975;
    const BASE_LNG = 115.40299759147925;
    const ALLOWED_RADIUS_M = 200; // 200 meter

    // URL Web App Google Apps Script (API ke Google Sheet)
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxOHwN1-GyfwWrQLucTf-X0Db_9HefScgxd5g2h35-ntTNyGQZ4NePhZ39OfeZqRvdM/exec";

    function calculateDistanceMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000; // radius bumi dalam meter
      const toRad = (deg) => (deg * Math.PI) / 180;
      const phi1 = toRad(lat1);
      const phi2 = toRad(lat2);
      const dPhi = toRad(lat2 - lat1);
      const dLambda = toRad(lon2 - lon1);

      const a =
        Math.sin(dPhi / 2) * Math.sin(dPhi / 2) +
        Math.cos(phi1) * Math.cos(phi2) *
        Math.sin(dLambda / 2) * Math.sin(dLambda / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    const form = document.getElementById("attendance-form");
    const nameInput = document.getElementById("employee-name");
    const idInput = document.getElementById("employee-id");
    const roleInput = document.getElementById("employee-role");
    const shiftInput = document.getElementById("shift");

    const btnModeOnsite = document.getElementById("btn-mode-onsite");
    const btnModeOutarea = document.getElementById("btn-mode-outarea");
    const outareaInfo = document.getElementById("outarea-info");
    const outareaReasonGroup = document.getElementById("outarea-reason-group");
    const outareaReasonInput = document.getElementById("outarea-reason");

    const btnLocation = document.getElementById("btn-location");
    const locationStatus = document.getElementById("location-status");
    const latValue = document.getElementById("lat-value");
    const lngValue = document.getElementById("lng-value");
    const accValue = document.getElementById("acc-value");
    const distValue = document.getElementById("dist-value");
    const latHidden = document.getElementById("lat-hidden");
    const lngHidden = document.getElementById("lng-hidden");
    const accHidden = document.getElementById("acc-hidden");

    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const selfiePreview = document.getElementById("selfie-preview");
    const btnStartCamera = document.getElementById("btn-start-camera");
    const btnCapture = document.getElementById("btn-capture");
    const btnRetake = document.getElementById("btn-retake");
    const cameraHint = document.getElementById("camera-hint");

    const btnSubmit = document.getElementById("btn-submit");
    const resultPanel = document.getElementById("result-panel");
    const resultOutput = document.getElementById("result-output");
    const todayDateEl = document.getElementById("today-date");

    let locationData = null;
    let photoDataUrl = null;
    let mediaStream = null;
    let isOutOfAreaMode = false;

    function setTodayBadge() {
      const now = new Date();
      const formatter = new Intl.DateTimeFormat("id-ID", {
        weekday: "short",
        day: "2-digit",
        month: "short",
        year: "numeric",
      });
      todayDateEl.textContent = formatter.format(now);
    }

    setTodayBadge();

    function runEnvironmentChecks() {
      const tests = [
        {
          name: "Geolocation support",
          passed: "geolocation" in navigator,
        },
        {
          name: "Camera (mediaDevices.getUserMedia)",
          passed: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
        },
        {
          name: "Secure context (https/localhost)",
          passed: location.protocol === "https:" || location.hostname === "localhost",
        },
      ];

      console.table(tests);

      const summaryLines = tests.map((t) => `${t.name}: ${t.passed ? "OK" : "TIDAK TERSEDIA"}`);

      resultPanel.classList.remove("hidden");
      resultOutput.textContent =
        "Cek lingkungan (otomatis saat load halaman):\n" +
        summaryLines.join("\n") +
        "\n\nCatatan: Jika kamera gagal, pastikan semua status di atas \"OK\".\nData absensi akan muncul di bawah log ini setiap kali kirim.";
    }

    runEnvironmentChecks();

    function updateSubmitState() {
      const hasBasic =
        nameInput.value.trim() && idInput.value.trim() && roleInput.value && shiftInput.value;
      const hasLocation = !!locationData;
      const hasPhoto = !!photoDataUrl;
      const hasOutareaReason = outareaReasonInput.value.trim().length > 0;
      const insideRadiusOk = !!(locationData && locationData.insideRadius);

      if (isOutOfAreaMode) {
        btnSubmit.disabled = !(hasBasic && hasLocation && hasOutareaReason);
      } else {
        btnSubmit.disabled = !(hasBasic && hasLocation && hasPhoto && insideRadiusOk);
      }
    }

    [nameInput, idInput, roleInput, shiftInput].forEach((el) => {
      el.addEventListener("input", updateSubmitState);
      el.addEventListener("change", updateSubmitState);
    });

    outareaReasonInput.addEventListener("input", updateSubmitState);

    function setMode(outArea) {
      isOutOfAreaMode = outArea;

      if (outArea) {
        btnModeOutarea.classList.add("btn-mode-active");
        btnModeOnsite.classList.remove("btn-mode-active");
        outareaReasonGroup.classList.remove("hidden");
        outareaInfo.classList.add("error");
        outareaInfo.innerHTML =
          '<span class="label">Info:</span>' +
          "<span><strong>Mode ABSEN DI LUAR AREA.</strong> Selfie boleh gagal / tidak tersedia, " +
          "namun lokasi &amp; alasan wajib diisi. Absensi ini akan tercatat sebagai out-of-area override.</span>";
      } else {
        btnModeOnsite.classList.add("btn-mode-active");
        btnModeOutarea.classList.remove("btn-mode-active");
        outareaReasonGroup.classList.add("hidden");
        outareaInfo.classList.remove("error");
        outareaInfo.innerHTML =
          '<span class="label">Info:</span>' +
          "<span>Mode normal (On Site). Selfie &amp; GPS di titik kerja wajib sebelum kirim absensi.</span>";
      }

      updateSubmitState();
    }

    setMode(false);

    btnModeOnsite.addEventListener("click", () => setMode(false));
    btnModeOutarea.addEventListener("click", () => setMode(true));

    btnLocation.addEventListener("click", () => {
      if (!("geolocation" in navigator)) {
        locationStatus.classList.remove("success");
        locationStatus.classList.add("error");
        locationStatus.innerHTML =
          '<span class="label">Status:</span> Browser tidak mendukung GPS. Coba gunakan HP / browser lain.';
        return;
      }

      locationStatus.classList.remove("error");
      locationStatus.classList.remove("success");
      locationStatus.innerHTML =
        '<span class="label">Status:</span> Mengambil lokasi... mohon tunggu dan pastikan sinyal GPS bagus.';

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;
          const accuracy = position.coords.accuracy;
          const distance = calculateDistanceMeters(latitude, longitude, BASE_LAT, BASE_LNG);

          locationData = {
            latitude: latitude,
            longitude: longitude,
            accuracy: accuracy,
            distanceMeters: distance,
            insideRadius: distance <= ALLOWED_RADIUS_M,
            timestamp: new Date().toISOString(),
          };

          latValue.textContent = latitude.toFixed(6);
          lngValue.textContent = longitude.toFixed(6);
          accValue.textContent = accuracy ? accuracy.toFixed(1) + " m" : "N/A";
          distValue.textContent = distance ? distance.toFixed(1) + " m" : "N/A";

          latHidden.value = latitude;
          lngHidden.value = longitude;
          accHidden.value = accuracy;

          if (locationData.insideRadius) {
            locationStatus.classList.add("success");
            locationStatus.classList.remove("error");
            locationStatus.innerHTML =
              '<span class="label">Status:</span><strong> Lokasi berhasil diambil.</strong> ' +
              "Anda berada di dalam radius kerja (‚âà " +
              distance.toFixed(1) +
              " m dari titik referensi). Absensi On Site diperbolehkan.";
          } else {
            locationStatus.classList.add("error");
            locationStatus.classList.remove("success");
            locationStatus.innerHTML =
              '<span class="label">Status:</span><strong> Lokasi berhasil diambil, namun di luar area.</strong> ' +
              "Jarak dari titik referensi ‚âà " +
              distance.toFixed(1) +
              " m (&gt; " +
              ALLOWED_RADIUS_M +
              " m). Absensi On Site tidak dapat digunakan. " +
              'Silakan gunakan mode <strong>Absen di Luar Area</strong> dan isi alasan.';
          }

          updateSubmitState();
        },
        (error) => {
          console.error("Geolocation error:", error);
          locationData = null;
          latValue.textContent = "‚Äî";
          lngValue.textContent = "‚Äî";
          accValue.textContent = "‚Äî";
          distValue.textContent = "‚Äî";
          latHidden.value = "";
          lngHidden.value = "";
          accHidden.value = "";

          locationStatus.classList.add("error");
          locationStatus.classList.remove("success");
          let message = "Gagal mengambil lokasi.";
          if (error.code === error.PERMISSION_DENIED) {
            message += " Akses lokasi ditolak. Cek pengaturan browser & izinkan lokasi.";
          } else if (error.code === error.POSITION_UNAVAILABLE) {
            message += " Sinyal GPS lemah atau tidak tersedia.";
          } else if (error.code === error.TIMEOUT) {
            message += " Waktu permintaan lokasi habis. Coba ambil lagi.";
          }
          locationStatus.innerHTML = '<span class="label">Status:</span> ' + message;

          updateSubmitState();
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0,
        }
      );
    });

    async function startCamera() {
      try {
        if (mediaStream) {
          return;
        }

        const constraints = {
          video: {
            facingMode: "user",
          },
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        mediaStream = stream;
        video.srcObject = stream;

        video.classList.remove("hidden");
        selfiePreview.classList.add("hidden");
        btnCapture.disabled = false;
        btnRetake.disabled = true;

        cameraHint.innerHTML =
          '<span class="dot-rec"></span><span>Kamera aktif. Posisikan wajah di lingkaran, lalu tekan "Ambil Selfie".</span>';
      } catch (err) {
        console.error("Error membuka kamera:", err);

        video.classList.add("hidden");
        selfiePreview.classList.add("hidden");
        btnCapture.disabled = true;
        btnRetake.disabled = true;
        cameraHint.innerHTML =
          '<span class="dot-rec"></span>' +
          "<span>Gagal membuka kamera. Periksa izin kamera & jalankan via HTTPS/localhost.</span>";

        alert(
          "Tidak dapat mengakses kamera.\n\n" +
          "Kemungkinan penyebab:\n" +
          "- Izin kamera ditolak\n" +
          "- Halaman tidak dibuka via HTTPS/localhost\n" +
          "- Tidak ada device kamera\n\n" +
          "Detail teknis: " + (err.message || err.name)
        );
      }
    }

    function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach((track) => track.stop());
        mediaStream = null;
      }
      video.srcObject = null;
    }

    btnStartCamera.addEventListener("click", () => {
      if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) {
        alert("Browser tidak mendukung kamera. Coba gunakan HP / browser Chrome/Edge versi terbaru.");
        return;
      }

      if (location.protocol !== "https:" && location.hostname !== "localhost") {
        alert(
          "Kamera hanya bisa diakses jika halaman ini dibuka via HTTPS atau localhost.\n" +
          "Contoh:\n- Upload ke hosting dengan https\n- Atau jalankan lewat Live Server (http://localhost:...)"
        );
        return;
      }

      startCamera();
    });

    btnCapture.addEventListener("click", () => {
      if (!mediaStream) {
        alert('Kamera belum aktif. Tekan "Nyalakan Kamera" dulu.');
        return;
      }

      const videoWidth = video.videoWidth;
      const videoHeight = video.videoHeight;
      if (!videoWidth || !videoHeight) {
        alert("Kamera belum siap. Tunggu sebentar lalu coba lagi.");
        return;
      }

      canvas.width = videoWidth;
      canvas.height = videoHeight;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, videoWidth, videoHeight);

      photoDataUrl = canvas.toDataURL("image/jpeg", 0.8);

      selfiePreview.src = photoDataUrl;
      selfiePreview.classList.remove("hidden");
      video.classList.add("hidden");
      btnRetake.disabled = false;

      cameraHint.innerHTML =
        '<span class="dot-rec" style="background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,0.6);"></span>' +
        '<span>Selfie tersimpan. Jika kurang jelas, tekan "Ulangi".</span>';

      stopCamera();
      btnCapture.disabled = true;

      updateSubmitState();
    });

    btnRetake.addEventListener("click", () => {
      photoDataUrl = null;
      selfiePreview.src = "";
      selfiePreview.classList.add("hidden");
      btnRetake.disabled = true;
      cameraHint.innerHTML =
        '<span class="dot-rec"></span><span>Aktifkan kamera lagi lalu ambil selfie baru.</span>';
      startCamera();
      updateSubmitState();
    });

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      if (!isOutOfAreaMode) {
        if (!photoDataUrl || !locationData) {
          alert("Mode On Site: Selfie & lokasi wajib diambil sebelum kirim absensi.");
          return;
        }
        if (!locationData.insideRadius) {
          alert(
            "Mode On Site hanya diperbolehkan jika Anda berada di dalam radius " +
            ALLOWED_RADIUS_M +
            " meter dari titik PayBoss Cafe.\n" +
            'Silakan gunakan mode "Absen di Luar Area" jika Anda berada di luar radius.'
          );
          return;
        }
      } else {
        if (!locationData) {
          alert("Mode Luar Area: Lokasi tetap wajib diambil untuk bukti titik absensi.");
          return;
        }
        if (!outareaReasonInput.value.trim()) {
          alert("Mode Luar Area: Alasan absen di luar area wajib diisi.");
          return;
        }
      }

      const now = new Date();
      const attendanceRecord = {
        employeeName: nameInput.value.trim(),
        employeeId: idInput.value.trim(),
        employeeRole: roleInput.value,
        shift: shiftInput.value,
        timestamp: now.toISOString(),
        localTime: now.toLocaleString("id-ID"),
        mode: isOutOfAreaMode ? "OUT_OF_AREA" : "ONSITE",
        isOutOfArea: isOutOfAreaMode,
        outOfAreaReason: isOutOfAreaMode ? outareaReasonInput.value.trim() : null,
        location: locationData,
        photo: photoDataUrl || null
      };

      try {
        const existing = JSON.parse(localStorage.getItem("payboss_attendance") || "[]");
        existing.push(attendanceRecord);
        localStorage.setItem("payboss_attendance", JSON.stringify(existing));
      } catch (err) {
        console.warn("Gagal menyimpan ke localStorage (boleh diabaikan):", err);
      }

      try {
        await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(attendanceRecord),
        });
        console.log("Data absensi terkirim ke Apps Script");
      } catch (err) {
        console.error("Gagal mengirim ke Google Sheet:", err);
      }

      resultPanel.classList.remove("hidden");
      const previousText = resultOutput.textContent || "";
      const newLog = "\n\n=== ABSENSI BARU ===\n" + JSON.stringify(attendanceRecord, null, 2);
      resultOutput.textContent = previousText + newLog;

      if (isOutOfAreaMode) {
        const distanceInfo =
          locationData && typeof locationData.distanceMeters === "number"
            ? "\nJarak dari titik referensi ‚âà " + locationData.distanceMeters.toFixed(1) + " m."
            : "";
        alert(
          "Absensi berhasil direkam sebagai ABSEN DI LUAR AREA.\n" +
          "Pastikan pengelola melakukan verifikasi manual terhadap data ini." +
          distanceInfo
        );
      } else {
        alert(
          "Absensi On Site dengan selfie berhasil direkam.\n" +
          "Data juga dikirim ke Google Sheet melalui Apps Script."
        );
      }

      updateSubmitState();
    });

    window.addEventListener("beforeunload", () => {
      stopCamera();
    });
  </script>
</body>
</html>
