<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PayBoss Cafe - Sistem Absensi</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel (untuk JSX di browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Framer Motion UMD -->
    <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>
  </head>

  <body class="bg-stone-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useRef, useEffect, useCallback } = React;

      // Inisialisasi Framer Motion dari UMD (fallback kalau gagal load)
      const fm = window.FramerMotion || null;
      const motion = fm
        ? fm.motion
        : {
            div: (props) => <div {...props} />,
            form: (props) => <form {...props} />,
          };
      const AnimatePresence = fm ? fm.AnimatePresence : ({ children }) => <>{children}</>;

      // --- SIMPLE ICON WRAPPER (pengganti lucide-react) ---
      const IconWrapper = ({ children, className = "", size = 24 }) => (
        <span
          className={className}
          style={{ fontSize: size, display: "inline-flex", alignItems: "center", justifyContent: "center" }}
        >
          {children}
        </span>
      );

      const Home = (props) => <IconWrapper {...props}>üè†</IconWrapper>;
      const LogIn = (props) => <IconWrapper {...props}>üîë</IconWrapper>;
      const LogOut = (props) => <IconWrapper {...props}>üö™</IconWrapper>;
      const User = (props) => <IconWrapper {...props}>üë§</IconWrapper>;
      const BarChart2 = (props) => <IconWrapper {...props}>üìä</IconWrapper>;
      const Users = (props) => <IconWrapper {...props}>üë•</IconWrapper>;
      const Calendar = (props) => <IconWrapper {...props}>üìÖ</IconWrapper>;
      const FileText = (props) => <IconWrapper {...props}>üìÑ</IconWrapper>;
      const CheckCircle = (props) => <IconWrapper {...props}>‚úÖ</IconWrapper>;
      const XCircle = (props) => <IconWrapper {...props}>‚ùå</IconWrapper>;
      const MapPin = (props) => <IconWrapper {...props}>üìç</IconWrapper>;
      const Camera = (props) => <IconWrapper {...props}>üì∑</IconWrapper>;
      const ListChecks = (props) => <IconWrapper {...props}>‚úÖ</IconWrapper>;
      const ChevronLeft = (props) => <IconWrapper {...props}>‚óÄÔ∏è</IconWrapper>;
      const ChevronRight = (props) => <IconWrapper {...props}>‚ñ∂Ô∏è</IconWrapper>;
      const Plus = (props) => <IconWrapper {...props}>‚ûï</IconWrapper>;
      const Trash2 = (props) => <IconWrapper {...props}>üóëÔ∏è</IconWrapper>;
      const Edit = (props) => <IconWrapper {...props}>‚úèÔ∏è</IconWrapper>;
      const Clock = (props) => <IconWrapper {...props}>‚è∞</IconWrapper>;
      const AlertTriangle = (props) => <IconWrapper {...props}>‚ö†Ô∏è</IconWrapper>;
      const Coffee = (props) => <IconWrapper {...props}>‚òï</IconWrapper>;
      const ShieldCheck = (props) => <IconWrapper {...props}>üõ°Ô∏è</IconWrapper>;
      const Moon = (props) => <IconWrapper {...props}>üåô</IconWrapper>;
      const Sun = (props) => <IconWrapper {...props}>‚òÄÔ∏è</IconWrapper>;
      const Sunset = (props) => <IconWrapper {...props}>üåÜ</IconWrapper>;
      const LockIcon = (props) => <IconWrapper {...props}>üîí</IconWrapper>;

      // --- STYLING & KONFIGURASI ---

      const theme = {
        colors: {
          primary: "bg-stone-700",
          primaryHover: "hover:bg-stone-800",
          secondary: "bg-amber-800",
          secondaryHover: "hover:bg-amber-900",
          accent: "bg-green-700",
          accentHover: "hover:bg-green-800",
          background: "bg-stone-100",
          card: "bg-white",
          textPrimary: "text-stone-800",
          textSecondary: "text-stone-600",
          textLight: "text-white",
          border: "border-stone-200",
          danger: "bg-red-600",
          success: "bg-green-600",
        },
        rounding: {
          card: "rounded-2xl",
          button: "rounded-lg",
          input: "rounded-lg",
        },
      };

      // Lokasi PayBoss Cafe
      const TARGET_LOCATION = {
        latitude: -2.1717657457047723,
        longitude: 115.4029877085838,
      };
      const GPS_RADIUS_METERS = 100;

      // Hardcode tanggal hari ini (nanti bisa diganti Date.now)
      const TODAY = "2025-11-16";

      // URL Google Apps Script Web App
      const GOOGLE_SHEET_WEBAPP_URL =
        "https://script.google.com/macros/s/AKfycbxOHwN1-GyfwWrQLucTf-X0Db_9HefScgxd5g2h35-ntTNyGQZ4NePhZ39OfeZqRvdM/exec";

      // --- DATA MASTER KARYAWAN & ROSTER ---

      const initialDbKaryawan = [
        {
          id: "PB251101",
          nama: "Dayat",
          posisi: "Koordinator",
          password: "dayat123",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
          fotoInisial: "D",
        },
        {
          id: "PB251102",
          nama: "Ilham Ali Naufal",
          posisi: "Pramusaji",
          password: "ilham123",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
          fotoInisial: "IAN",
        },
        {
          id: "PB251104",
          nama: "Renita Aulia Jasmin",
          posisi: "Bartender",
          password: "renita123",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
          fotoInisial: "RAJ",
        },
        {
          id: "PB251106",
          nama: "Annisa",
          posisi: "Kasir",
          password: "annisa123",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
          fotoInisial: "A",
        },
        {
          id: "PB251107",
          nama: "Rudi",
          posisi: "Barista",
          password: "rudi123",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
          fotoInisial: "R",
        },
        {
          id: "PB251108",
          nama: "Siti",
          posisi: "Pramusaji",
          password: "siti123",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
          fotoInisial: "S",
        },
        {
          id: "PB251109",
          nama: "Budi",
          posisi: "Koki",
          password: "budi123",
          tanggalLahir: "",
          fotoUrl: "",
          noWhatsapp: "",
          email: "",
          alamat: "",
          statusPernikahan: "",
          kontakDarurat: "",
          fotoInisial: "B",
        },
      ];

      const initialDbRoster = {
        PB251101: {
          "2025-11-16": "OFF",
          "2025-11-17": 1,
          "2025-11-18": 1,
          "2025-11-19": 1,
          "2025-11-20": 1,
          "2025-11-21": 1,
          "2025-11-22": 1,
        },
        PB251102: {
          "2025-11-16": 2,
          "2025-11-17": "OFF",
          "2025-11-18": 3,
          "2025-11-19": 3,
          "2025-11-20": 3,
          "2025-11-21": 3,
          "2025-11-22": 3,
        },
        PB251104: {
          "2025-11-16": 2,
          "2025-11-17": 2,
          "2025-11-18": "OFF",
          "2025-11-19": 2,
          "2025-11-20": 2,
          "2025-11-21": 2,
          "2025-11-22": 2,
        },
        PB251108: {
          "2025-11-16": 1,
          "2025-11-17": 1,
          "2025-11-18": 1,
          "2025-11-19": "OFF",
          "2025-11-20": 2,
          "2025-11-21": 2,
          "2025-11-22": 2,
        },
        PB251109: {
          "2025-11-16": 1,
          "2025-11-17": 1,
          "2025-11-18": 1,
          "2025-11-19": 1,
          "2025-11-20": "OFF",
          "2025-11-21": 1,
          "2025-11-22": "OFF",
        },
        PB251106: {
          "2025-11-16": 2,
          "2025-11-17": 2,
          "2025-11-18": "OFF",
          "2025-11-19": 2,
          "2025-11-20": 2,
          "2025-11-21": 2,
          "2025-11-22": 2,
        },
        PB251107: {
          "2025-11-16": 2,
          "2025-11-17": "OFF",
          "2025-11-18": 3,
          "2025-11-19": 3,
          "2025-11-20": 3,
          "2025-11-21": 3,
          "2025-11-22": 3,
        },
      };

      const shiftDetails = {
        1: { nama: "Pagi", ikon: Sun, waktu: "08:00 - 16:00", color: "text-blue-500" },
        2: { nama: "Siang", ikon: Sunset, waktu: "16:00 - 23:00", color: "text-orange-500" },
        3: { nama: "Malam", ikon: Moon, waktu: "23:00 - 08:00", color: "text-indigo-500" },
        OFF: { nama: "OFF", ikon: Home, waktu: "Libur", color: "text-gray-500" },
      };

      // --- FUNGSI UTILITAS ---

      function getHaversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const œÜ1 = (lat1 * Math.PI) / 180;
        const œÜ2 = (lat2 * Math.PI) / 180;
        const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180;
        const ŒîŒª = ((lon2 - lon1) * Math.PI) / 180;

        const a =
          Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
          Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c;
      }

      function formatShortDate(date) {
        return date.toLocaleDateString("id-ID", {
          weekday: "long",
          day: "numeric",
          month: "short",
        });
      }

      function formatTime(date) {
        return date.toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      // --- KONEKSI GOOGLE SHEET ---

      async function kirimAbsensiKeSheet({ user, jenis, data, shiftName }) {
        try {
          const payload = {
            action: "appendAbsensi",
            timestamp: new Date().toISOString(),
            tanggal: TODAY,
            jenis,
            idKaryawan: user.id,
            namaKaryawan: user.nama,
            posisi: user.posisi,
            shift: shiftName,
            waktu: data.waktu.toISOString(),
            lat: data.lat || "",
            lng: data.lng || "",
            jarak: data.jarak || "",
            alasanLuarArea: data.alasanLuarArea || "",
          };

          await fetch(GOOGLE_SHEET_WEBAPP_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
            mode: "no-cors",
          });
        } catch (err) {
          console.error("Gagal mengirim data ke Google Sheet", err);
        }
      }

      async function loadAbsensiDariSheet() {
        try {
          const res = await fetch(
            GOOGLE_SHEET_WEBAPP_URL + "?action=getAbsensi&ts=" + Date.now()
          );
          if (!res.ok) throw new Error("Response tidak OK");
          const json = await res.json();
          if (!json || !Array.isArray(json.data)) return null;

          // Mapping fleksibel (ikut header di Apps Script)
          return json.data.map((row) => ({
            id: row.id || row.ID || row.Id || "",
            idKaryawan: row.idKaryawan || row.IDKaryawan || row.karyawanId,
            namaKaryawan: row.namaKaryawan || row.Nama || row.nama,
            posisi: row.posisi || row.Posisi || "",
            tanggal: row.tanggal || row.Tanggal,
            shift: row.shift || row.Shift,
            checkIn: row.checkIn
              ? {
                  waktu: new Date(row.checkIn),
                  alasanLuarArea: row.alasanLuarArea || row.AlasanLuarArea || null,
                  lat: row.lat ? Number(row.lat) : null,
                  lng: row.lng ? Number(row.lng) : null,
                  jarak: row.jarak ? Number(row.jarak) : null,
                }
              : null,
            checkOut: row.checkOut
              ? {
                  waktu: new Date(row.checkOut),
                }
              : null,
            jobDeskProgress: [],
            status: row.status || row.Status || "",
          }));
        } catch (err) {
          console.error("Gagal load absensi dari Google Sheet", err);
          return null;
        }
      }

      // --- KOMPONEN REUSABLE ---

      const Modal = ({ children, onClose, title }) => (
        <AnimatePresence>
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 p-4"
            onClick={onClose}
          >
            <motion.div
              initial={{ scale: 0.9, y: 20 }}
              animate={{ scale: 1, y: 0 }}
              exit={{ scale: 0.9, y: 20 }}
              className={`relative w-full max-w-lg overflow-hidden ${theme.colors.card} ${theme.rounding.card} shadow-2xl`}
              onClick={(e) => e.stopPropagation()}
            >
              <div
                className={`flex items-center justify-between p-5 ${theme.colors.border} border-b`}
              >
                <h3 className={`text-xl font-bold ${theme.colors.textPrimary}`}>
                  {title}
                </h3>
                <button
                  onClick={onClose}
                  className={`${theme.colors.textSecondary} hover:text-red-500`}
                >
                  <XCircle size={24} />
                </button>
              </div>
              <div className="p-6">{children}</div>
            </motion.div>
          </motion.div>
        </AnimatePresence>
      );

      const Button = ({
        onClick,
        children,
        variant = "primary",
        disabled = false,
        className = "",
        type = "button",
      }) => {
        const variants = {
          primary: `${theme.colors.primary} ${theme.colors.textLight} ${theme.colors.primaryHover}`,
          secondary: `${theme.colors.secondary} ${theme.colors.textLight} ${theme.colors.secondaryHover}`,
          accent: `${theme.colors.accent} ${theme.colors.textLight} ${theme.colors.accentHover}`,
          danger: `${theme.colors.danger} ${theme.colors.textLight} hover:bg-red-700`,
          light: `${theme.colors.background} ${theme.colors.textPrimary} hover:bg-stone-200`,
        };

        return (
          <button
            type={type}
            onClick={onClick}
            disabled={disabled}
            className={`flex w-full items-center justify-center gap-2 p-3 font-semibold ${theme.rounding.button} transition-all duration-200 ${variants[variant]} ${
              disabled ? "opacity-50 cursor-not-allowed" : ""
            } ${className}`}
          >
            {children}
          </button>
        );
      };

      const Input = ({
        type = "text",
        placeholder,
        value,
        onChange,
        icon,
        className = "",
        ...rest
      }) => (
        <div className="relative w-full">
          {icon && (
            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400">
              {icon}
            </div>
          )}
          <input
            type={type}
            placeholder={placeholder}
            value={value}
            onChange={onChange}
            {...rest}
            className={`w-full ${theme.colors.background} ${theme.rounding.input} ${
              theme.colors.textPrimary
            } border ${theme.colors.border} p-3 ${
              icon ? "pl-10" : ""
            } focus:outline-none focus:ring-2 focus:ring-amber-800 ${className}`}
          />
        </div>
      );

      const Spinner = ({ size = 24 }) => (
        <motion.div
          animate={{ rotate: 360 }}
          transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
          className="border-t-transparent border-solid rounded-full border-stone-700 border-2"
          style={{ width: size, height: size }}
        />
      );

      const ProgressBar = ({ value, max }) => {
        const percent = max > 0 ? (value / max) * 100 : 0;
        return (
          <div
            className={`w-full ${theme.colors.background} ${theme.rounding.button} overflow-hidden`}
          >
            <motion.div
              className={`${theme.colors.accent} h-2`}
              initial={{ width: 0 }}
              animate={{ width: `${percent}%` }}
              transition={{ duration: 0.5, ease: "easeInOut" }}
            />
          </div>
        );
      };

      // --- MODAL ALUR ABSENSI (SELFIE + GPS) ---

      const AttendanceFlow = ({ user, type, onClose, onComplete, todayShift }) => {
        const [step, setStep] = useState("camera");
        const [selfie, setSelfie] = useState(null);
        const [locationData, setLocationData] = useState(null);
        const [inArea, setInArea] = useState(false);
        const [distance, setDistance] = useState(0);
        const [error, setError] = useState(null);
        const [cameraSupported, setCameraSupported] = useState(true);

        const [reason, setReason] = useState("");
        const reasons = ["Sakit", "Izin", "Dinas Luar", "Lainnya"];

        const webcamRef = useRef(null);
        const streamRef = useRef(null);

        useEffect(() => {
          if (step === "camera") {
            const startCamera = async () => {
              try {
                if (
                  typeof navigator === "undefined" ||
                  !navigator.mediaDevices ||
                  !navigator.mediaDevices.getUserMedia
                ) {
                  setCameraSupported(false);
                  setError(
                    "Kamera tidak didukung di browser/lingkungan ini. Anda bisa melanjutkan tanpa selfie."
                  );
                  return;
                }

                setCameraSupported(true);
                const stream = await navigator.mediaDevices.getUserMedia({
                  video: { facingMode: "user" },
                  audio: false,
                });
                if (webcamRef.current) {
                  webcamRef.current.srcObject = stream;
                  webcamRef.current.play();
                  streamRef.current = stream;
                }
              } catch (err) {
                console.error("Error accessing webcam:", err);
                setCameraSupported(false);
                setError(
                  "Gagal mengakses kamera. Periksa izin kamera Anda, atau lanjutkan tanpa selfie."
                );
              }
            };
            startCamera();
          }

          return () => {
            if (streamRef.current) {
              streamRef.current.getTracks().forEach((track) => track.stop());
              streamRef.current = null;
            }
          };
        }, [step]);

        const captureSelfie = useCallback(() => {
          if (!webcamRef.current || !cameraSupported) {
            setError(
              "Kamera belum siap atau tidak didukung. Anda bisa menekan tombol 'Lanjut tanpa Selfie'."
            );
            return;
          }

          const video = webcamRef.current;
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;

          const ctx = canvas.getContext("2d");
          if (!ctx) {
            setError("Gagal memproses gambar.");
            return;
          }

          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageSrc = canvas.toDataURL("image/jpeg");

          if (!imageSrc) {
            setError("Gagal mengambil foto. Coba lagi.");
            return;
          }
          setSelfie(imageSrc);
          setStep("location");

          if (streamRef.current) {
            streamRef.current.getTracks().forEach((track) => track.stop());
            streamRef.current = null;
          }
        }, [cameraSupported]);

        const continueWithoutSelfie = () => {
          setSelfie(null);
          setError(null);
          setStep("location");

          if (streamRef.current) {
            streamRef.current.getTracks().forEach((track) => track.stop());
            streamRef.current = null;
          }
        };

        useEffect(() => {
          if (step === "location") {
            setError(null);
            if (!navigator.geolocation) {
              setError("Browser Anda tidak mendukung Geolocation.");
              setStep("confirm");
              return;
            }

            navigator.geolocation.getCurrentPosition(
              (position) => {
                const { latitude, longitude } = position.coords;
                const dist = getHaversineDistance(
                  latitude,
                  longitude,
                  TARGET_LOCATION.latitude,
                  TARGET_LOCATION.longitude
                );

                setLocationData({ latitude, longitude });
                setDistance(dist);

                if (dist <= GPS_RADIUS_METERS) {
                  setInArea(true);
                  setStep("confirm");
                } else {
                  setInArea(false);
                  setStep("reason");
                }
              },
              (err) => {
                let errMsg = "Gagal mendapatkan lokasi. ";
                if (err.code === 1)
                  errMsg += "Pastikan Anda mengizinkan akses lokasi.";
                if (err.code === 2) errMsg += "Sinyal lokasi tidak tersedia.";
                if (err.code === 3) errMsg += "Waktu tunggu habis.";
                setError(errMsg);
                setStep("confirm");
              },
              { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
          }
        }, [step]);

        const handleSubmit = async () => {
          setStep("loading");

          const attendanceData = {
            waktu: new Date(),
            fotoBase64: selfie,
            lat: locationData?.latitude,
            lng: locationData?.longitude,
            alasanLuarArea: inArea ? null : reason,
            jarak: distance,
          };

          try {
            await kirimAbsensiKeSheet({
              user,
              jenis: type,
              data: attendanceData,
              shiftName: todayShift?.nama || "",
            });
          } catch (e) {
            console.error(e);
          }

          onComplete(attendanceData);
          setStep("success");
        };

        const title = type === "checkIn" ? "Absen Check-in" : "Absen Check-out";

        const renderStep = () => {
          switch (step) {
            case "camera":
              return (
                <div className="text-center">
                  <p className={`${theme.colors.textSecondary} mb-4`}>
                    Posisikan wajah Anda di dalam frame dan ambil selfie untuk
                    verifikasi. Jika kamera tidak berfungsi, Anda tetap bisa
                    lanjut tanpa selfie.
                  </p>
                  {cameraSupported && (
                    <div
                      className={`w-full overflow-hidden ${theme.rounding.card} border-2 ${theme.colors.border} shadow-inner bg-black`}
                    >
                      <video
                        ref={webcamRef}
                        autoPlay
                        playsInline
                        muted
                        className="w-full h-auto"
                        style={{ transform: "scaleX(-1)" }}
                      />
                    </div>
                  )}
                  {error && (
                    <p className="text-red-500 text-sm mt-2">{error}</p>
                  )}
                  <div className="flex flex-col sm:flex-row gap-3 mt-4">
                    <Button
                      onClick={captureSelfie}
                      variant="secondary"
                      className="sm:flex-1"
                      disabled={!cameraSupported}
                    >
                      <Camera size={20} /> Ambil Foto
                    </Button>
                    <Button
                      onClick={continueWithoutSelfie}
                      variant="light"
                      className="sm:flex-1"
                    >
                      Lewati Selfie
                    </Button>
                  </div>
                </div>
              );

            case "location":
              return (
                <div className="flex flex-col items-center justify-center h-48">
                  <Spinner size={40} />
                  <p
                    className={`${theme.colors.textPrimary} mt-4 font-semibold`}
                  >
                    Mendeteksi lokasi Anda...
                  </p>
                  <p className={`${theme.colors.textSecondary} text-sm`}>
                    Pastikan GPS dan izin lokasi aktif.
                  </p>
                </div>
              );

            case "reason":
              return (
                <div>
                  <div
                    className={`flex items-center gap-3 p-4 ${theme.rounding.button} bg-yellow-100 border border-yellow-300 text-yellow-800`}
                  >
                    <AlertTriangle size={24} />
                    <div>
                      <h4 className="font-bold">Anda Berada di Luar Area!</h4>
                      <p className="text-sm">
                        Jarak Anda: {distance.toFixed(0)} meter dari PayBoss
                        Cafe.
                      </p>
                    </div>
                  </div>
                  <p className={`${theme.colors.textSecondary} mt-4 mb-3`}>
                    Harap pilih alasan Anda absen di luar area kerja:
                  </p>
                  <div className="space-y-2">
                    {reasons.map((r) => (
                      <label
                        key={r}
                        className={`flex items-center w-full p-3 ${
                          theme.rounding.input
                        } ${theme.colors.background} border ${
                          reason === r
                            ? "border-amber-800 ring-2 ring-amber-800"
                            : theme.colors.border
                        } cursor-pointer`}
                      >
                        <input
                          type="radio"
                          name="reason"
                          value={r}
                          checked={reason === r}
                          onChange={(e) => setReason(e.target.value)}
                          className="mr-3"
                        />
                        {r}
                      </label>
                    ))}
                  </div>
                  <Button
                    onClick={() => setStep("confirm")}
                    disabled={!reason}
                    className="mt-4"
                  >
                    Lanjutkan
                  </Button>
                </div>
              );

            case "confirm":
              return (
                <div>
                  <p className={`${theme.colors.textSecondary} mb-4`}>
                    Harap konfirmasi data{" "}
                    {type === "checkIn" ? "check-in" : "check-out"} Anda.
                  </p>
                  <div className="space-y-4">
                    <div className="flex items-center gap-4">
                      {selfie && (
                        <img
                          src={selfie}
                          alt="Selfie"
                          className={`w-24 h-24 object-cover ${theme.rounding.card} border-2 ${theme.colors.border}`}
                        />
                      )}
                      <div>
                        <h4 className="font-bold">{user.nama}</h4>
                        <p className={theme.colors.textSecondary}>{user.posisi}</p>
                        <p className={theme.colors.textSecondary}>
                          {formatTime(new Date())}
                        </p>
                      </div>
                    </div>
                    <div
                      className={`p-3 ${theme.rounding.input} ${theme.colors.background}`}
                    >
                      <h5 className="font-semibold flex items-center gap-2">
                        <MapPin
                          size={16}
                          className={inArea ? "text-green-600" : "text-red-600"}
                        />
                        Status Lokasi
                      </h5>
                      {locationData ? (
                        inArea ? (
                          <p className="text-green-600 text-sm font-medium">
                            Dalam Area PayBoss Cafe (¬±{distance.toFixed(0)}m).
                          </p>
                        ) : (
                          <p className="text-red-600 text-sm font-medium">
                            Di Luar Area PayBoss Cafe (¬±{distance.toFixed(0)}m).
                          </p>
                        )
                      ) : (
                        <p className="text-yellow-600 text-sm font-medium">
                          Gagal mendapatkan data lokasi.
                        </p>
                      )}
                      {reason && (
                        <p className="text-sm text-yellow-800 mt-1">
                          <b>Alasan:</b> {reason}
                        </p>
                      )}
                    </div>
                    {error && (
                      <p className="text-red-500 text-sm -mt-2">{error}</p>
                    )}
                  </div>
                  <Button
                    onClick={handleSubmit}
                    variant="accent"
                    className="mt-6"
                  >
                    <CheckCircle size={20} /> Konfirmasi{" "}
                    {type === "checkIn" ? "Check-in" : "Check-out"}
                  </Button>
                </div>
              );

            case "loading":
              return (
                <div className="flex flex-col items-center justify-center h-48">
                  <Spinner size={40} />
                  <p
                    className={`${theme.colors.textPrimary} mt-4 font-semibold`}
                  >
                    Menyimpan data absensi...
                  </p>
                </div>
              );

            case "success":
              return (
                <div className="flex flex-col items-center justify-center h-48 text-center">
                  <motion.div
                    initial={{ scale: 0.5 }}
                    animate={{ scale: 1 }}
                    transition={{ type: "spring", damping: 10, stiffness: 150 }}
                  >
                    <CheckCircle size={60} className="text-green-600" />
                  </motion.div>
                  <h3 className="text-2xl font-bold mt-4">Berhasil!</h3>
                  <p className={theme.colors.textSecondary}>
                    Absen {type === "checkIn" ? "check-in" : "check-out"} Anda
                    telah dicatat.
                  </p>
                  <Button onClick={onClose} className="mt-6 w-32">
                    Selesai
                  </Button>
                </div>
              );

            default:
              return null;
          }
        };

        return (
          <Modal title={title} onClose={onClose}>
            {renderStep()}
          </Modal>
        );
      };

      // --- KOMPONEN KARYAWAN HOME ---

      const KaryawanHome = ({
        user,
        dbAbsensi,
        setDbAbsensi,
        dbRoster,
        onNavigate,
        onShowModal,
      }) => {
        const [todayRecord, setTodayRecord] = useState(null);
        const [todayShift, setTodayShift] = useState(null);
        const [greeting, setGreeting] = useState("");

        useEffect(() => {
          const record = dbAbsensi.find(
            (a) => a.idKaryawan === user.id && a.tanggal === TODAY
          );
          setTodayRecord(record || null);

          const shiftCode = dbRoster[user.id]?.[TODAY];
          setTodayShift(shiftDetails[shiftCode] || shiftDetails["OFF"]);

          const hour = new Date().getHours();
          if (hour < 11) setGreeting("Selamat Pagi");
          else if (hour < 15) setGreeting("Selamat Siang");
          else if (hour < 19) setGreeting("Selamat Sore");
          else setGreeting("Selamat Malam");
        }, [dbAbsensi, user.id, dbRoster]);

        if (!todayShift) {
          return (
            <div className="flex items-center justify-center h-screen">
              <Spinner size={40} />
            </div>
          );
        }

        const handleAttendance = (type) => {
          onShowModal(type, todayShift);
        };

        const isCheckedIn = todayRecord && todayRecord.checkIn;
        const isCheckedOut = todayRecord && todayRecord.checkOut;
        const isOff = todayShift.nama === "OFF";

        let jobProgress = 0;
        let jobTotal = 0;
        if (isCheckedIn && todayRecord.jobDeskProgress) {
          jobTotal = todayRecord.jobDeskProgress.length;
          jobProgress = todayRecord.jobDeskProgress.filter((t) => t.completed)
            .length;
        }

        return (
          <div className="p-4 space-y-6">
            <div
              className={`p-6 ${theme.colors.primary} ${theme.rounding.card} shadow-lg text-white`}
            >
              <p className="text-lg font-light">{greeting},</p>
              <h2 className="text-3xl font-bold">{user.nama}</h2>
              <p className="text-stone-300 mt-1">{user.posisi}</p>
            </div>

            <div
              className={`p-6 ${theme.colors.card} ${theme.rounding.card} shadow-md`}
            >
              <h3
                className={`text-xl font-bold mb-4 ${theme.colors.textPrimary}`}
              >
                Absensi Hari Ini
              </h3>
              <p className={`${theme.colors.textSecondary} mb-1`}>
                {formatShortDate(new Date(TODAY + "T00:00:00"))}
              </p>

              {isOff ? (
                <div className="text-center p-6 bg-stone-100 rounded-lg">
                  <Home size={32} className="mx-auto text-stone-500 mb-2" />
                  <h4 className="text-lg font-bold">Hari Libur</h4>
                  <p className={theme.colors.textSecondary}>
                    Nikmati waktu istirahat Anda.
                  </p>
                </div>
              ) : (
                <div className="space-y-4">
                  {isCheckedIn ? (
                    <div className="flex items-center justify-between p-4 bg-green-50 border border-green-200 rounded-lg">
                      <div className="flex items-center gap-3">
                        <CheckCircle size={24} className="text-green-600" />
                        <div>
                          <span className="font-bold text-green-700">
                            Check-in Berhasil
                          </span>
                          <p className="text-sm text-green-600">
                            pukul {formatTime(todayRecord.checkIn.waktu)}
                          </p>
                        </div>
                      </div>
                      {todayRecord.checkIn.alasanLuarArea && (
                        <AlertTriangle
                          size={20}
                          className="text-yellow-500"
                          title={`Absen di luar area: ${todayRecord.checkIn.alasanLuarArea}`}
                        />
                      )}
                    </div>
                  ) : (
                    <Button onClick={() => handleAttendance("checkIn")}>
                      <LogIn size={20} /> Check-in
                    </Button>
                  )}

                  {isCheckedIn &&
                    (isCheckedOut ? (
                      <div className="flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div className="flex items-center gap-3">
                          <CheckCircle size={24} className="text-blue-600" />
                          <div>
                            <span className="font-bold text-blue-700">
                              Check-out Berhasil
                            </span>
                            <p className="text-sm text-blue-600">
                              pukul {formatTime(todayRecord.checkOut.waktu)}
                            </p>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <Button
                        onClick={() => handleAttendance("checkOut")}
                        variant="secondary"
                      >
                        <LogOut size={20} /> Check-out
                      </Button>
                    ))}
                </div>
              )}
            </div>

            {!isOff && (
              <div
                className={`p-6 ${theme.colors.card} ${theme.rounding.card} shadow-md space-y-4`}
              >
                <div>
                  <h4 className="text-lg font-bold flex items-center gap-2">
                    <Coffee size={20} className={todayShift.color} /> Shift
                    Anda
                  </h4>
                  <p className={`${theme.colors.textSecondary} text-lg`}>
                    {todayShift.nama} ({todayShift.waktu})
                  </p>
                </div>

                {isCheckedIn && (
                  <div>
                    <h4 className="text-lg font-bold flex items-center gap-2 mb-2">
                      <ListChecks size={20} className="text-stone-700" />
                      Progres Job Desk
                    </h4>
                    <ProgressBar value={jobProgress} max={jobTotal} />
                    <p
                      className={`${theme.colors.textSecondary} text-sm mt-2`}
                    >
                      {jobProgress} dari {jobTotal} tugas selesai.
                    </p>
                    <Button
                      onClick={() => onNavigate("jobdesk")}
                      variant="light"
                      className="mt-3"
                    >
                      Lihat / Update Job Desk
                    </Button>
                  </div>
                )}
              </div>
            )}
          </div>
        );
      };

      // --- JOB DESK KARYAWAN (SIMPLE MOCK) ---

      const JOB_DESK_TEMPLATE = {
        Koordinator: [
          "Memimpin briefing tim",
          "Mengecek kesiapan operasional",
          "Membuat laporan akhir shift",
        ],
        Kasir: [
          "Membuka dan menutup kasir",
          "Input transaksi dengan benar",
          "Rekonsiliasi kas di akhir shift",
        ],
        Barista: [
          "Menyiapkan minuman sesuai resep",
          "Menjaga kebersihan area bar",
          "Mencatat kebutuhan stok bahan",
        ],
        Pramusaji: [
          "Menyambut tamu dengan ramah",
          "Mengantar makanan/minuman",
          "Membersihkan meja setelah tamu selesai",
        ],
        Bartender: [
          "Menyiapkan minuman bar",
          "Menjaga stok minuman",
          "Menjaga kebersihan area bar",
        ],
        Koki: [
          "Menyiapkan bahan masak",
          "Memasak sesuai pesanan",
          "Menjaga kebersihan dapur",
        ],
      };

      const KaryawanJobDesk = ({ user, dbAbsensi, setDbAbsensi, onBack }) => {
        const [record, setRecord] = useState(null);

        useEffect(() => {
          let r = dbAbsensi.find(
            (a) => a.idKaryawan === user.id && a.tanggal === TODAY
          );
          if (!r) {
            const tasks =
              JOB_DESK_TEMPLATE[user.posisi] || JOB_DESK_TEMPLATE["Pramusaji"];
            r = {
              id: Date.now().toString(),
              idKaryawan: user.id,
              namaKaryawan: user.nama,
              posisi: user.posisi,
              tanggal: TODAY,
              shift: null,
              checkIn: null,
              checkOut: null,
              jobDeskProgress: tasks.map((t, idx) => ({
                id: `task-${idx}`,
                nama: t,
                completed: false,
              })),
              status: "",
            };
            setDbAbsensi((prev) => [...prev, r]);
          }
          setRecord(r);
        }, [user, dbAbsensi, setDbAbsensi]);

        const toggleTask = (taskId) => {
          setRecord((prev) => {
            if (!prev) return prev;
            const updatedTasks = prev.jobDeskProgress.map((t) =>
              t.id === taskId ? { ...t, completed: !t.completed } : t
            );
            const updatedRecord = { ...prev, jobDeskProgress: updatedTasks };
            setDbAbsensi((all) =>
              all.map((a) => (a.id === updatedRecord.id ? updatedRecord : a))
            );
            return updatedRecord;
          });
        };

        if (!record) {
          return (
            <div className="flex items-center justify-center h-screen">
              <Spinner size={40} />
            </div>
          );
        }

        const total = record.jobDeskProgress.length;
        const done = record.jobDeskProgress.filter((t) => t.completed).length;

        return (
          <div className="p-4 space-y-4">
            <button
              onClick={onBack}
              className="inline-flex items-center gap-2 text-stone-600 hover:text-stone-900 mb-2"
            >
              <ChevronLeft size={20} /> Kembali
            </button>
            <div
              className={`p-5 ${theme.colors.card} ${theme.rounding.card} shadow-md`}
            >
              <h3 className={`text-xl font-bold ${theme.colors.textPrimary}`}>
                Job Desk Hari Ini
              </h3>
              <p className={theme.colors.textSecondary}>
                {user.nama} ‚Ä¢ {user.posisi}
              </p>
              <p className={`${theme.colors.textSecondary} text-sm mt-1`}>
                {formatShortDate(new Date(TODAY + "T00:00:00"))}
              </p>

              <div className="mt-4">
                <ProgressBar value={done} max={total} />
                <p className={`${theme.colors.textSecondary} text-sm mt-2`}>
                  {done} dari {total} tugas selesai.
                </p>
              </div>

              <ul className="mt-4 space-y-2">
                {record.jobDeskProgress.map((task) => (
                  <li
                    key={task.id}
                    className={`flex items-center gap-3 p-3 ${theme.rounding.input} ${theme.colors.background} border ${theme.colors.border}`}
                  >
                    <input
                      type="checkbox"
                      checked={task.completed}
                      onChange={() => toggleTask(task.id)}
                      className="w-5 h-5"
                    />
                    <span
                      className={`flex-1 ${
                        task.completed ? "line-through text-stone-400" : ""
                      }`}
                    >
                      {task.nama}
                    </span>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        );
      };

      // --- DASHBOARD MANAGER ---

      const ManagerDashboard = ({ dbAbsensi, onBack }) => {
        const [selectedDate, setSelectedDate] = useState(TODAY);

        const recordsForDate = dbAbsensi.filter(
          (a) => a.tanggal === selectedDate
        );

        return (
          <div className="p-4 space-y-4">
            <button
              onClick={onBack}
              className="inline-flex items-center gap-2 text-stone-600 hover:text-stone-900 mb-2"
            >
              <ChevronLeft size={20} /> Kembali
            </button>
            <div
              className={`p-5 ${theme.colors.card} ${theme.rounding.card} shadow-md`}
            >
              <h3 className={`text-xl font-bold ${theme.colors.textPrimary}`}>
                Dashboard Absensi
              </h3>
              <p className={theme.colors.textSecondary}>
                Rekap absensi harian karyawan PayBoss Cafe
              </p>

              <div className="mt-4 flex flex-col sm:flex-row gap-3 items-start sm:items-end">
                <div className="flex flex-col">
                  <label
                    className={`text-sm mb-1 ${theme.colors.textSecondary}`}
                  >
                    Tanggal
                  </label>
                  <input
                    type="date"
                    value={selectedDate}
                    onChange={(e) => setSelectedDate(e.target.value)}
                    className={`border ${theme.colors.border} ${theme.rounding.input} p-2`}
                  />
                </div>
                <p className={`${theme.colors.textSecondary} text-sm`}>
                  Total data: {recordsForDate.length}
                </p>
              </div>

              <div className="mt-4 overflow-auto max-h-[60vh]">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="bg-stone-100 text-left">
                      <th className="px-3 py-2 border">ID</th>
                      <th className="px-3 py-2 border">Nama</th>
                      <th className="px-3 py-2 border">Posisi</th>
                      <th className="px-3 py-2 border">Shift</th>
                      <th className="px-3 py-2 border">Check-in</th>
                      <th className="px-3 py-2 border">Check-out</th>
                      <th className="px-3 py-2 border">Status</th>
                      <th className="px-3 py-2 border">Alasan Luar Area</th>
                    </tr>
                  </thead>
                  <tbody>
                    {recordsForDate.length === 0 ? (
                      <tr>
                        <td
                          colSpan="8"
                          className="text-center py-4 text-stone-500"
                        >
                          Belum ada data absensi untuk tanggal ini.
                        </td>
                      </tr>
                    ) : (
                      recordsForDate.map((rec, idx) => (
                        <tr key={idx} className="border-b">
                          <td className="px-3 py-2 border">{rec.idKaryawan}</td>
                          <td className="px-3 py-2 border">
                            {rec.namaKaryawan}
                          </td>
                          <td className="px-3 py-2 border">{rec.posisi}</td>
                          <td className="px-3 py-2 border text-center">
                            {rec.shift}
                          </td>
                          <td className="px-3 py-2 border">
                            {rec.checkIn
                              ? formatTime(rec.checkIn.waktu)
                              : "-"}
                          </td>
                          <td className="px-3 py-2 border">
                            {rec.checkOut
                              ? formatTime(rec.checkOut.waktu)
                              : "-"}
                          </td>
                          <td className="px-3 py-2 border">{rec.status || ""}</td>
                          <td className="px-3 py-2 border">
                            {rec.checkIn?.alasanLuarArea || "-"}
                          </td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        );
      };

      // --- AUTH / LOGIN ---

      const Landing = ({ onSelect }) => (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-amber-100 via-stone-100 to-amber-50 p-4">
          <div
            className={`w-full max-w-lg ${theme.colors.card} ${theme.rounding.card} shadow-2xl p-8 space-y-6`}
          >
            <div className="flex items-center gap-3">
              <Coffee size={36} />
              <div>
                <h1 className="text-2xl font-extrabold text-stone-800">
                  PayBoss Cafe
                </h1>
                <p className="text-stone-500 text-sm">
                  Sistem Absensi & Monitoring Shift
                </p>
              </div>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
              <Button onClick={() => onSelect("karyawan")}>
                <User size={20} /> Login Karyawan
              </Button>
              <Button variant="secondary" onClick={() => onSelect("manager")}>
                <ShieldCheck size={20} /> Login Manager
              </Button>
            </div>

            <div className="text-xs text-stone-400 pt-4 border-t border-stone-100">
              Dibuat untuk PayBoss Cafe ‚Ä¢ GPS + Selfie ‚Ä¢ Tersinkronisasi dengan
              Google Sheet
            </div>
          </div>
        </div>
      );

      const LoginForm = ({ type, onLogin, onBack }) => {
        const [id, setId] = useState("");
        const [password, setPassword] = useState("");
        const [error, setError] = useState("");

        const handleSubmit = (e) => {
          e.preventDefault();
          setError("");
          onLogin({ id: id.trim(), password: password.trim(), type, setError });
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-amber-100 via-stone-100 to-amber-50 p-4">
            <div
              className={`w-full max-w-md ${theme.colors.card} ${theme.rounding.card} shadow-2xl p-8 space-y-6`}
            >
              <button
                onClick={onBack}
                className="inline-flex items-center gap-2 text-stone-500 hover:text-stone-800 text-sm"
              >
                <ChevronLeft size={18} /> Kembali
              </button>

              <div className="flex items-center gap-3 mt-2">
                {type === "karyawan" ? (
                  <User size={32} />
                ) : (
                  <ShieldCheck size={32} />
                )}
                <div>
                  <h2 className="text-xl font-bold text-stone-800">
                    {type === "karyawan"
                      ? "Login Karyawan"
                      : "Login Manager"}
                  </h2>
                  <p className="text-stone-500 text-sm">
                    Masukkan ID dan password PayBoss Anda
                  </p>
                </div>
              </div>

              <form onSubmit={handleSubmit} className="space-y-4 mt-2">
                <Input
                  placeholder="ID Karyawan (mis. PB251101)"
                  value={id}
                  onChange={(e) => setId(e.target.value)}
                  icon={<User size={18} />}
                  required
                />
                <Input
                  type="password"
                  placeholder="Password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  icon={<LockIcon />}
                  required
                />
                {error && (
                  <p className="text-red-500 text-sm text-center">{error}</p>
                )}
                <Button type="submit">
                  <LogIn size={20} /> Masuk
                </Button>
              </form>
            </div>
          </div>
        );
      };

      // --- APP UTAMA ---

      const App = () => {
        const [view, setView] = useState("landing"); // landing | login-karyawan | login-manager | home-karyawan | jobdesk | manager
        const [currentUser, setCurrentUser] = useState(null);
        const [dbAbsensi, setDbAbsensi] = useState([]);
        const [dbRoster] = useState(initialDbRoster);
        const [loadingAbsensi, setLoadingAbsensi] = useState(true);
        const [attendanceModal, setAttendanceModal] = useState({
          open: false,
          type: null,
          todayShift: null,
        });

        // --- LOAD ABSENSI DARI GOOGLE SHEET SAAT APP PERTAMA KALI DIBUKA ---
        useEffect(() => {
          let intervalId;

          const refreshAbsensi = async () => {
            setLoadingAbsensi(true);
            const data = await loadAbsensiDariSheet();
            if (data) {
              setDbAbsensi(data);
            }
            setLoadingAbsensi(false);
          };

          // load pertama kali
          refreshAbsensi();

          // auto-refresh tiap 60 detik
          intervalId = setInterval(refreshAbsensi, 60 * 1000);

          // refresh ketika tab kembali aktif
          const handleVisibility = () => {
            if (document.visibilityState === "visible") {
              refreshAbsensi();
            }
          };
          document.addEventListener("visibilitychange", handleVisibility);

          return () => {
            clearInterval(intervalId);
            document.removeEventListener("visibilitychange", handleVisibility);
          };
        }, []);

        const handleSelectRole = (role) => {
          setView(role === "karyawan" ? "login-karyawan" : "login-manager");
        };

        const findKaryawanById = (id) =>
          initialDbKaryawan.find((k) => k.id.toLowerCase() === id.toLowerCase());

        const handleLogin = ({ id, password, type, setError }) => {
          if (type === "karyawan") {
            const k = findKaryawanById(id);
            if (!k || k.password !== password) {
              setError("ID atau password karyawan salah.");
              return;
            }
            setCurrentUser({ ...k, role: "karyawan" });
            setView("home-karyawan");
          } else {
            // manager: login sederhana (bisa diganti sesuai kebutuhan)
            if (id === "manager" && password === "manager123") {
              setCurrentUser({
                id: "manager",
                nama: "Manager PayBoss",
                posisi: "Manager",
                role: "manager",
              });
              setView("manager");
            } else {
              setError("ID atau password manager salah.");
            }
          }
        };

        const handleLogout = () => {
          setCurrentUser(null);
          setView("landing");
        };

        const openAttendanceModal = (type, todayShift) => {
          setAttendanceModal({ open: true, type, todayShift });
        };

        const closeAttendanceModal = () => {
          setAttendanceModal({ open: false, type: null, todayShift: null });
        };

        const handleAttendanceComplete = (attendanceData) => {
          if (!currentUser) return;

          setDbAbsensi((prev) => {
            const existingIndex = prev.findIndex(
              (a) => a.idKaryawan === currentUser.id && a.tanggal === TODAY
            );

            if (attendanceModal.type === "checkIn") {
              const newRecord = {
                id:
                  existingIndex >= 0
                    ? prev[existingIndex].id
                    : Date.now().toString(),
                idKaryawan: currentUser.id,
                namaKaryawan: currentUser.nama,
                posisi: currentUser.posisi,
                tanggal: TODAY,
                shift: attendanceModal.todayShift?.nama || "",
                checkIn: {
                  waktu: attendanceData.waktu,
                  alasanLuarArea: attendanceData.alasanLuarArea,
                  lat: attendanceData.lat,
                  lng: attendanceData.lng,
                  jarak: attendanceData.jarak,
                },
                checkOut:
                  existingIndex >= 0 ? prev[existingIndex].checkOut : null,
                jobDeskProgress:
                  existingIndex >= 0
                    ? prev[existingIndex].jobDeskProgress || []
                    : [],
                status: "Hadir",
              };

              if (existingIndex >= 0) {
                const updated = [...prev];
                updated[existingIndex] = newRecord;
                return updated;
              }
              return [...prev, newRecord];
            } else {
              if (existingIndex < 0) {
                return prev;
              }
              const updated = [...prev];
              updated[existingIndex] = {
                ...updated[existingIndex],
                checkOut: {
                  waktu: attendanceData.waktu,
                },
              };
              return updated;
            }
          });
        };

        // --- RENDER VIEW ---

        if (view === "landing") {
          return <Landing onSelect={handleSelectRole} />;
        }

        if (view === "login-karyawan" || view === "login-manager") {
          return (
            <LoginForm
              type={view === "login-karyawan" ? "karyawan" : "manager"}
              onLogin={handleLogin}
              onBack={() => setView("landing")}
            />
          );
        }

        if (!currentUser) {
          return <Landing onSelect={handleSelectRole} />;
        }

        return (
          <div className="min-h-screen flex flex-col bg-stone-100">
            <header className="flex items-center justify-between px-4 py-3 bg-stone-800 text-white">
              <div className="flex items-center gap-2">
                <Coffee size={24} />
                <div>
                  <h1 className="font-bold text-lg">PayBoss Cafe</h1>
                  <p className="text-xs text-stone-300">
                    Sistem Absensi & Monitoring Shift
                  </p>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <div className="text-right">
                  <p className="text-sm font-semibold">
                    {currentUser.nama || currentUser.id}
                  </p>
                  <p className="text-xs text-stone-300">
                    {currentUser.role === "manager"
                      ? "Manager"
                      : currentUser.posisi}
                  </p>
                </div>
                <button
                  onClick={handleLogout}
                  className="flex items-center gap-1 text-xs bg-red-600 hover:bg-red-700 px-3 py-1 rounded-full"
                >
                  <LogOut size={16} /> Keluar
                </button>
              </div>
            </header>

            {loadingAbsensi && (
              <div className="flex items-center justify-center py-2 text-xs text-stone-500 gap-2">
                <Spinner size={12} /> Sinkronisasi data absensi dari Google
                Sheet...
              </div>
            )}

            <main className="flex-1">
              {currentUser.role === "karyawan" && view === "home-karyawan" && (
                <KaryawanHome
                  user={currentUser}
                  dbAbsensi={dbAbsensi}
                  setDbAbsensi={setDbAbsensi}
                  dbRoster={dbRoster}
                  onNavigate={(v) => setView(v === "jobdesk" ? "jobdesk" : "home-karyawan")}
                  onShowModal={openAttendanceModal}
                />
              )}

              {currentUser.role === "karyawan" && view === "jobdesk" && (
                <KaryawanJobDesk
                  user={currentUser}
                  dbAbsensi={dbAbsensi}
                  setDbAbsensi={setDbAbsensi}
                  onBack={() => setView("home-karyawan")}
                />
              )}

              {currentUser.role === "manager" && view === "manager" && (
                <ManagerDashboard
                  dbAbsensi={dbAbsensi}
                  onBack={() => {
                    handleLogout();
                  }}
                />
              )}
            </main>

            {attendanceModal.open && currentUser && (
              <AttendanceFlow
                user={currentUser}
                type={attendanceModal.type}
                todayShift={attendanceModal.todayShift}
                onClose={closeAttendanceModal}
                onComplete={handleAttendanceComplete}
              />
            )}
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
