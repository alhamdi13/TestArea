<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Cafe Payboss - GPS & Face Rec</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Face API untuk deteksi wajah -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- SweetAlert untuk notifikasi cantik -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Kunci tampilan agar tidak bisa di-scroll berlebih */
        body { overscroll-behavior: none; }
        .camera-container { position: relative; overflow: hidden; border-radius: 1rem; }
        video { transform: scaleX(-1); object-fit: cover; width: 100%; height: 100%; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }
        .overlay-box { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

    <!-- Header -->
    <div class="bg-blue-800 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div>
                <h1 class="font-bold text-lg">Cafe Payboss</h1>
                <p class="text-xs opacity-80">Sistem Absensi Validasi Ganda</p>
            </div>
            <div class="text-right">
                <div id="serverTime" class="font-mono font-bold text-xl">--:--</div>
                <div id="serverDate" class="text-xs">Memuat waktu...</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-4 max-w-md mx-auto w-full space-y-4">
        
        <!-- Status Panel -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-semibold text-gray-600">Status Lokasi</span>
                <span id="gpsStatus" class="text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 font-bold">Mencari...</span>
            </div>
            <div class="text-xs text-gray-500 space-y-1">
                <p>Lat: <span id="latVal">-</span></p>
                <p>Lng: <span id="lngVal">-</span></p>
                <p>Akurasi: <span id="accVal">-</span> meter</p>
            </div>
        </div>

        <!-- Input Form -->
        <div class="bg-white rounded-xl p-4 shadow-sm space-y-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Karyawan</label>
                <select id="employeeName" class="w-full p-2 border rounded-lg bg-gray-50">
                    <option value="">-- Pilih Nama --</option>
                    <option value="Alhamdi">Alhamdi</option>
                    <option value="Budi">Budi</option>
                    <option value="Siti">Siti</option>
                    <!-- Tambahkan nama lain di sini -->
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipe Absen</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setMode('IN')" id="btnIn" class="p-2 rounded-lg border text-center font-bold bg-blue-50 border-blue-200 text-blue-700">MASUK</button>
                    <button onclick="setMode('OUT')" id="btnOut" class="p-2 rounded-lg border text-center font-bold bg-gray-50 text-gray-500">PULANG</button>
                </div>
            </div>
        </div>

        <!-- Camera Section -->
        <div class="bg-white rounded-xl p-2 shadow-sm">
            <div class="text-center mb-2">
                <p class="text-sm font-bold text-gray-700">Verifikasi Wajah</p>
                <p id="faceStatus" class="text-xs text-red-500">Wajah tidak terdeteksi</p>
            </div>
            
            <div class="camera-container aspect-[3/4] bg-black relative">
                <video id="video" autoplay muted playsinline></video>
                <canvas id="overlay"></canvas>
                <div id="loadingCamera" class="absolute inset-0 flex items-center justify-center text-white text-sm">
                    Memuat Kamera & AI...
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <button id="btnSubmit" onclick="submitAttendance()" disabled class="w-full bg-gray-400 text-white font-bold py-4 rounded-xl shadow-lg transition-all transform active:scale-95">
            AMBIL FOTO & ABSEN
        </button>

    </div>

    <script>
        // ================= KONFIGURASI =================
        // Ganti URL ini dengan URL Web App Google Apps Script Anda
        const GOOGLE_SCRIPT_URL = "PASTE_URL_GOOGLE_SCRIPT_ANDA_DISINI";
        
        // Lokasi Cafe Payboss (Ganti dengan koordinat asli)
        const OFFICE_LOC = { lat: -2.171698, lng: 115.402943, radius: 100 }; // Radius dalam meter

        // ================= STATE VARIABLES =================
        let currentStream = null;
        let selectedMode = 'IN';
        let locationValid = false;
        let faceValid = false;
        let currentPosition = null;
        let serverTimeOffset = 0; // Selisih waktu device vs server

        // ================= INISIALISASI =================
        async function init() {
            // 1. Sync Waktu Server (Anti-Cheat Jam HP)
            syncTime();
            
            // 2. Load Model Wajah
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'),
            ]);

            // 3. Start Fitur
            startCamera();
            watchLocation();
            
            document.getElementById('loadingCamera').style.display = 'none';
        }

        // ================= 1. SISTEM WAKTU (ANTI-RESET TANGGAL) =================
        async function syncTime() {
            try {
                // Mengambil waktu dari API publik tepercaya
                const response = await fetch('https://worldtimeapi.org/api/timezone/Asia/Makassar');
                const data = await response.json();
                const serverNow = new Date(data.datetime).getTime();
                const deviceNow = Date.now();
                serverTimeOffset = serverNow - deviceNow;
                
                setInterval(updateClock, 1000);
            } catch (e) {
                console.warn("Gagal sync waktu, menggunakan waktu device (kurang aman)", e);
                serverTimeOffset = 0; 
                setInterval(updateClock, 1000);
            }
        }

        function getTrustedTime() {
            return new Date(Date.now() + serverTimeOffset);
        }

        function updateClock() {
            const now = getTrustedTime();
            document.getElementById('serverTime').innerText = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('serverDate').innerText = now.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
        }

        // ================= 2. SISTEM GPS (ANTI-FAKE GPS) =================
        function watchLocation() {
            if (!navigator.geolocation) {
                Swal.fire('Error', 'Browser tidak mendukung GPS', 'error');
                return;
            }

            navigator.geolocation.watchPosition(
                (pos) => {
                    currentPosition = pos;
                    const { latitude, longitude, accuracy } = pos.coords;
                    
                    // Validasi Akurasi (Fake GPS seringkali punya akurasi statis atau terlalu presisi/buruk)
                    document.getElementById('latVal').innerText = latitude.toFixed(6);
                    document.getElementById('lngVal').innerText = longitude.toFixed(6);
                    document.getElementById('accVal').innerText = accuracy.toFixed(0);

                    const distance = getDistanceFromLatLonInM(latitude, longitude, OFFICE_LOC.lat, OFFICE_LOC.lng);

                    // Logika Validasi
                    if (accuracy > 100) {
                        updateGpsStatus(false, "Sinyal GPS Buruk");
                    } else if (distance > OFFICE_LOC.radius) {
                        updateGpsStatus(false, `Diluar Area (${Math.round(distance)}m)`);
                    } else {
                        updateGpsStatus(true, "Di Dalam Area");
                    }
                    
                    checkReadyState();
                },
                (err) => {
                    updateGpsStatus(false, "GPS Error/Ditolak");
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } // Paksa refresh data baru
            );
        }

        function updateGpsStatus(isValid, text) {
            locationValid = isValid;
            const el = document.getElementById('gpsStatus');
            el.innerText = text;
            el.className = isValid 
                ? "text-xs px-2 py-1 rounded-full bg-green-100 text-green-800 font-bold"
                : "text-xs px-2 py-1 rounded-full bg-red-100 text-red-800 font-bold";
        }

        // Hitung jarak (Haversine Formula)
        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            var R = 6371000; 
            var dLat = deg2rad(lat2-lat1);
            var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }

        // ================= 3. FACE DETECTION (ANTI-FOTO PALSU) =================
        async function startCamera() {
            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                video.srcObject = stream;
                
                video.addEventListener('play', () => {
                    const canvas = document.getElementById('overlay');
                    const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
                    faceapi.matchDimensions(canvas, displaySize);

                    setInterval(async () => {
                        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
                        
                        // Cek apakah wajah valid (Confidence > 0.5)
                        if (detections.length > 0 && detections[0].score > 0.5) {
                            faceValid = true;
                            document.getElementById('faceStatus').innerText = "Wajah Terdeteksi ✅";
                            document.getElementById('faceStatus').className = "text-xs text-green-600 font-bold";
                            
                            // Gambar kotak wajah (opsional)
                            const resizedDetections = faceapi.resizeResults(detections, displaySize);
                            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                            faceapi.draw.drawDetections(canvas, resizedDetections);
                        } else {
                            faceValid = false;
                            document.getElementById('faceStatus').innerText = "Wajah Tidak Terdeteksi ❌";
                            document.getElementById('faceStatus').className = "text-xs text-red-500";
                            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                        }
                        checkReadyState();
                    }, 500);
                });
            } catch (err) {
                Swal.fire('Error', 'Gagal akses kamera. Pastikan izin diberikan.', 'error');
            }
        }

        // ================= LOGIKA UTAMA =================
        function setMode(mode) {
            selectedMode = mode;
            document.getElementById('btnIn').className = mode === 'IN' ? "p-2 rounded-lg border text-center font-bold bg-blue-50 border-blue-200 text-blue-700" : "p-2 rounded-lg border text-center font-bold bg-gray-50 text-gray-500";
            document.getElementById('btnOut').className = mode === 'OUT' ? "p-2 rounded-lg border text-center font-bold bg-blue-50 border-blue-200 text-blue-700" : "p-2 rounded-lg border text-center font-bold bg-gray-50 text-gray-500";
        }

        function checkReadyState() {
            const btn = document.getElementById('btnSubmit');
            const name = document.getElementById('employeeName').value;
            
            if (locationValid && faceValid && name) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-400');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                btn.disabled = true;
                btn.classList.add('bg-gray-400');
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        }

        async function submitAttendance() {
            if (GOOGLE_SCRIPT_URL === "PASTE_URL_GOOGLE_SCRIPT_ANDA_DISINI") {
                Swal.fire('Config Error', 'URL Google Script belum dipasang di kode!', 'warning');
                return;
            }

            // 1. Capture Foto
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const photoData = canvas.toDataURL('image/jpeg', 0.7); // Compress 0.7

            // 2. Siapkan Data
            const payload = {
                timestamp: getTrustedTime().toISOString(),
                nama: document.getElementById('employeeName').value,
                status: selectedMode,
                lat: currentPosition.coords.latitude,
                lng: currentPosition.coords.longitude,
                foto: photoData
            };

            // 3. Kirim ke Google Sheet (via Apps Script)
            Swal.fire({
                title: 'Mengirim Data...',
                text: 'Mohon tunggu sebentar',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading() }
            });

            try {
                // Gunakan 'no-cors' untuk simple request ke Google Script
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Karena mode 'no-cors', kita asumsikan sukses jika tidak error network
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil!',
                    text: `Absen ${selectedMode} tercatat pada ${getTrustedTime().toLocaleTimeString()}`,
                    confirmButtonText: 'Oke'
                }).then(() => {
                   location.reload(); // Refresh agar bersih
                });

            } catch (error) {
                Swal.fire('Gagal', 'Tidak dapat terhubung ke server.', 'error');
                console.error(error);
            }
        }

        // Jalankan
        init();
    </script>
</body>
</html>
