<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal PayBoss Staf - Payboss Cafe</title>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2B48C 100%);
            min-height: 100vh;
        }
        .hidden { display: none !important; }

        /* Login Page */
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .login-container h1 {
            color: #3E2723;
            margin-bottom: 20px;
        }
        .login-container .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .login-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .login-container input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .login-container button {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: none;
            background: #8B4513;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .login-container button:hover {
            background: #A0522D;
        }
        #login-error {
            color: #D32F2F;
            margin-top: 15px;
            font-weight: 500;
        }

        /* App Styles */
        html { height: 100%; }
        .nav-bar {
            background: rgba(62, 39, 35, 0.95); padding: 15px 20px; display: flex;
            justify-content: space-between; align-items: center; position: sticky;
            top: 0; z-index: 1000; backdrop-filter: blur(10px);
        }
        .nav-brand { color: #D2B48C; font-size: 1.5rem; font-weight: bold; text-decoration: none; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-link, #logout-btn {
            color: #D2B48C; text-decoration: none; padding: 8px 16px; border-radius: 6px;
            transition: all 0.3s ease; font-weight: 500; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active, #logout-btn:hover { background: #8B4513; color: white; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .page {
            display: none; background: rgba(255, 255, 255, 0.95); border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; margin-bottom: 20px;
        }
        .page.active { display: block; }
        .page-header {
            background: linear-gradient(135deg, #3E2723 0%, #5D4037 100%); color: white;
            padding: 30px; text-align: center;
        }
        .page-header h1 { margin: 0 0 10px 0; font-size: 2.5rem; font-weight: bold; }
        .page-header p { margin: 0; opacity: 0.9; font-size: 1.1rem; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding: 25px; }
        .stat-card {
            background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center; transition: transform 0.3s ease; position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, #8B4513, #D2B48C);
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: #3E2723; margin-bottom: 8px; }
        .stat-label { color: #666; font-size: 1.1rem; margin-bottom: 10px; }
        .order-list { background: white; border-radius: 15px; padding: 25px; margin: 0 25px 25px 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .order-item { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 15px; border-left: 4px solid #8B4513; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .order-id { font-weight: bold; font-size: 1.1rem; color: #3E2723; }
        .order-status { padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-preparing { background: #cce5ff; color: #004085; }
        .status-ready { background: #d4edda; color: #155724; }
        .order-details { font-size: 0.95rem; color: #666; line-height: 1.5; }
        .action-btn {
            background: #8B4513; color: white; border: none; padding: 8px 16px;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin: 5px;
            transition: background 0.3s ease;
        }
        .action-btn:hover { background: #A0522D; }
        .action-btn.success { background: #28a745; }
        .action-btn.success:hover { background: #218838; }
        
        /* [--- TAMBAHAN UNTUK CETAK & BATAL ---] */
        .action-btn.print {
            background-color: #007bff;
        }
        .action-btn.print:hover {
            background-color: #0056b3;
        }
        .action-btn.danger {
            background-color: #dc3545;
        }
        .action-btn.danger:hover {
            background-color: #c82333;
        }
        /* [--- AKHIR TAMBAHAN ---] */

        .notification {
            position: fixed; top: 20px; right: 20px; background: #8B4513; color: white;
            padding: 15px 20px; border-radius: 8px; z-index: 2000; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-weight: bold; transform: translateX(calc(100% + 30px)); transition: transform 0.4s ease-in-out;
        }
        .notification.show { transform: translateX(0); }
        .report-box { background: #fff; padding: 25px; border-radius: 15px; margin: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .report-box h3 { margin-top: 0; }
        .report-controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .report-controls input { padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .report-controls button { padding: 12px 20px; }

        /* --- STYLE BARU UNTUK KELOLA MENU --- */
        .menu-item-manage {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .menu-item-info {
            font-weight: bold;
            color: #3E2723;
        }
        .menu-item-info span {
            font-weight: normal;
            color: #666;
            font-size: 0.9rem;
            display: block;
        }
        .toggle-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
            width: 110px; /* Lebar tetap agar rapi */
            text-align: center;
        }
        .toggle-btn.available {
            background: #28a745; /* Hijau */
            color: white;
        }
        .toggle-btn.unavailable {
            background: #dc3545; /* Merah */
            color: white;
        }
        .toggle-btn:hover {
            opacity: 0.8;
        }
        .menu-category-header {
            border-bottom: 2px solid #D2B48C;
            padding-bottom: 5px;
        }
        /* --- AKHIR STYLE BARU --- */

        /* [--- TAMBAHAN UNTUK VOID LOG ---] */
        .order-item.voided {
            border-left-color: #dc3545; /* Red border */
            background-color: #fff6f6; /* Lighter red background */
        }
        .void-reason {
            font-size: 0.9rem;
            font-weight: 500;
            color: #c82333; /* Dark red */
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }
        .void-reason small {
            color: #666;
            font-weight: normal;
        }
        /* [--- AKHIR TAMBAHAN ---] */

        /* [--- TAMBAHAN UNTUK MODAL BATAL ---] */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 450px;
        }
        .modal-content h2 {
            margin-top: 0;
            color: #3E2723;
        }
        .modal-content .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .modal-content textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1rem;
            resize: vertical;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }
        /* [--- AKHIR TAMBAHAN MODAL ---] */

        /* [--- BARU: STYLE UNTUK PERINGATAN ORDER LAMA ---] */
        .order-item.flashing-warning {
            /* Pesanan akan berkedip merah/putih */
            animation: flash-warning 1.5s infinite ease-in-out;
            border-left-color: #dc3545; /* Garis kiri menjadi merah */
        }

        @keyframes flash-warning {
            0%, 100% { 
                background-color: #fff6f6; /* Latar merah muda */
            }
            50% { 
                background-color: #f8f9fa; /* Latar normal */
            }
        }
        /* [--- AKHIR STYLE BARU ---] */


        @media (max-width: 768px) {
            .login-container { padding: 25px; }
            .nav-bar { flex-direction: column; gap: 10px; }
            .nav-links { justify-content: center; flex-wrap: wrap; gap: 5px; }
            .container { padding: 10px; }
            .dashboard-grid, .order-list { padding: 15px; margin: 0 10px 15px 10px; }
            .page-header h1 { font-size: 2rem; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .order-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .report-controls { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

    <!-- [--- BARU: ELEMEN AUDIO UNTUK NOTIFIKASI ---] -->
    <!-- Kita gunakan data URI (Base64) agar tidak perlu file eksternal -->
    <!-- Suara "Ding" untuk pesanan baru -->
    <audio id="new-order-sound" preload="auto" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAAGF0YSAfagD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/APHAAsACwALABAAEAD/AP4A/AD1APEJbwHhAJsAvgDGAHkAwQDsAacAsAEBAHUA5AD3AOIA6gDpAPAA5gD2APQA9ADlAPUA6ADnAOgA5gDsAOIA7ADqAOoA6gDqAOoA6gDrAOwA6wDsAOwA7ADtAOwA7ADtAOwA7ADtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0A7QDtAO0ALwGFAHwBcwHjAioBewD7Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4BvgG+Ab4Bvg=="></audio>
    <!-- Suara "Beep Beep" untuk pengingat -->
    <audio id="reminder-sound" preload="auto" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAAGF0YSAfagD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/LogP+A+YDpgPSBGoENgXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+gRqBGoEagXyBLoFbgYyBOoFigX2BOIF+String"></audio>
    <!-- [--- AKHIR AUDIO ---] -->

    <div id="login-page">
        <div class="login-container">
            <h1>‚òï Portal Staf</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit">Login</button>
                <p id="login-error" class="hidden"></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <nav class="nav-bar">
            <a href="#" class="nav-brand">‚òï Portal Staf Payboss</a>
            <div class="nav-links">
                <a href="#" class="nav-link active" data-page="cashier">üí∞ Kasir</a>
                <a href="#" class="nav-link" data-page="kitchen">üë®‚Äçüç≥ Dapur</a>
                <!-- MENU BARU DITAMBAHKAN DISINI -->
                <a href="#" class="nav-link" data-page="menu">üçΩÔ∏è Kelola Menu</a>
                <a href="#" class="nav-link" data-page="manager">üìä Manager</a>
                <a href="#" id="logout-btn">Logout</a>
            </div>
        </nav>

        <div class="container">
            <div id="cashier-page" class="page active">
                <div class="page-header"><h1>üí∞ Sistem Kasir</h1><p>Kelola pesanan dan pembayaran pelanggan</p></div>
                <div class="dashboard-grid">
                    <div class="stat-card"><span class="stat-icon">üõí</span><div class="stat-value" id="total-orders">0</div><div class="stat-label">Total Pesanan Aktif</div></div>
                    <div class="stat-card"><span class="stat-icon">üí∞</span><div class="stat-value" id="daily-revenue">Rp 0</div><div class="stat-label">Pendapatan Hari Ini</div></div>
                    <div class="stat-card"><span class="stat-icon">‚è±Ô∏è</span><div class="stat-value" id="pending-orders">0</div><div class="stat-label">Pesanan Menunggu</div></div>
                </div>
                <div class="order-list"><h3>üìã Daftar Pesanan</h3><div id="cashier-orders"></div></div>
            </div>
            <div id="kitchen-page" class="page">
                <div class="page-header"><h1>üë®‚Äçüç≥ Dashboard Dapur</h1><p>Kelola pesanan yang perlu dimasak</p></div>
                <div class="dashboard-grid">
                    <div class="stat-card"><span class="stat-icon">üî•</span><div class="stat-value" id="cooking-orders">0</div><div class="stat-label">Sedang Dimasak</div></div>
                    <div class="stat-card"><span class="stat-icon">‚úÖ</span><div class="stat-value" id="ready-orders">0</div><div class="stat-label">Siap Disajikan</div></div>
                    <div class="stat-card"><span class="stat-icon">üçΩÔ∏è</span><div class="stat-value" id="completed-orders-kitchen">0</div><div class="stat-label">Pesanan Selesai Hari Ini</div></div>
                </div>
                <div class="order-list"><h3>üç≥ Antrian Pesanan</h3><div id="kitchen-orders"></div></div>
            </div>

            <!-- HALAMAN BARU UNTUK KELOLA MENU -->
            <div id="menu-page" class="page">
                <div class="page-header"><h1>üçΩÔ∏è Kelola Ketersediaan Menu</h1><p>Atur menu yang tersedia atau habis di aplikasi pelanggan</p></div>
                <div class="order-list">
                    <h3>Daftar Menu</h3>
                    <div id="menu-management-list">
                        <!-- Daftar menu akan dimuat oleh JavaScript di sini -->
                    </div>
                </div>
            </div>
            <!-- AKHIR HALAMAN BARU -->

            <div id="manager-page" class="page">
                <div class="page-header"><h1>üìä Dashboard Manager</h1><p>Analisis performa dan laporan bisnis</p></div>
                
                <div class="report-box">
                    <h3>Laporan Penjualan</h3>
                    <div class="report-controls">
                        <input type="date" id="start-date">
                        <input type="date" id="end-date">
                        <button id="download-report-btn" class="action-btn success">Download Laporan (Excel)</button>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="stat-card"><span class="stat-icon">üí∞</span><div class="stat-value" id="manager-total-sales">Rp 0</div><div class="stat-label">Total Penjualan Hari Ini</div></div>
                    <div class="stat-card"><span class="stat-icon">üì¶</span><div class="stat-value" id="manager-total-orders">0</div><div class="stat-label">Total Transaksi Selesai</div></div>
                    <div class="stat-card"><span class="stat-icon">üìà</span><div class="stat-value" id="manager-avg-order">Rp 0</div><div class="stat-label">Rata-rata per Transaksi</div></div>
                </div>
                <div class="order-list"><h3>üìä Menu Terlaris Hari Ini</h3><div id="best-selling-list"><p>Belum ada data penjualan hari ini.</p></div></div>
            
                <!-- [--- TAMBAHAN UNTUK VOID LOG ---] -->
                <div class="order-list">
                    <h3>üö´ Daftar Pesanan Dibatalkan Hari Ini</h3>
                    <div id="voided-orders-list">
                        <p>Belum ada pesanan yang dibatalkan hari ini.</p>
                    </div>
                </div>
                <!-- [--- AKHIR TAMBAHAN ---] -->
            </div>
        </div>
    </div>

    <!-- [--- TAMBAHAN UNTUK MODAL PEMBATALAN ---] -->
    <div id="void-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>Batalkan Pesanan</h2>
            <p>Anda akan membatalkan pesanan. Harap masukkan alasan yang jelas untuk manajer.</p>
            <form id="void-form">
                <div class="form-group">
                    <label for="void-reason">Alasan Pembatalan</label>
                    <textarea id="void-reason" rows="3" required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancel-void-btn" class="action-btn">Tutup</button>
                    <button type="submit" id="confirm-void-btn" class="action-btn danger">Konfirmasi Batal</button>
                </div>
            </form>
        </div>
    </div>
    <!-- [--- AKHIR TAMBAHAN MODAL ---] -->


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, query, where, getDocs, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
         apiKey: "AIzaSyB0nHqdAw_dV9pHcQ_cSnWtNsn4CwwwUNc",
         authDomain: "payboss-cafe-system.firebaseapp.com",
         projectId: "payboss-cafe-system",
         storageBucket: "payboss-cafe-system.appspot.com",
         messagingSenderId: "570523503793",
         appId: "1:570523503793:web:0a7ba7ce751eb95a3f6690",
         measurementId: "G-H1NJ369HE9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // [--- MODIFIKASI: Pindahkan variabel ke scope global modul ---]
        let activeOrders = [];
        let completedToday = [];
        let reminderInterval = null; // <-- Variabel baru untuk interval pengingat
        // [--- AKHIR MODIFIKASI ---]

        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');

        // [--- TAMBAHAN MODAL ---]
        const voidModal = document.getElementById('void-modal');
        const voidForm = document.getElementById('void-form');
        const voidReasonInput = document.getElementById('void-reason');
        const cancelVoidBtn = document.getElementById('cancel-void-btn');
        const confirmVoidBtn = document.getElementById('confirm-void-btn');
        let orderToVoidId = null; // Store the ID of the order to be voided
        // [--- AKHIR TAMBAHAN ---]

        let unsubscribeOrders = null;
        let unsubscribeCompleted = null;
        let unsubscribeMenu = null; // <-- Variabel baru untuk listener menu
        let unsubscribeVoided = null; // [--- TAMBAHAN BARU ---]
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const managerEmails = ['fedrik.christian07@gmail.com'];
                const staffEmails = ['payboss.tanjung@gmail.com'];
                let userRole = null;

                if (managerEmails.includes(user.email)) userRole = 'manager';
                else if (staffEmails.includes(user.email)) userRole = 'staff';

                if (userRole) {
                    loginPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    setupUIForRole(userRole);
                    initializeAppLogic();
                } else {
                    signOut(auth).then(() => sessionStorage.setItem('loginError', 'Akun Anda tidak memiliki hak akses.'));
                }
            } else {
                loginPage.classList.remove('hidden');
                appContainer.classList.add('hidden');
                const storedError = sessionStorage.getItem('loginError');
                if (storedError) {
                    loginError.textContent = storedError;
                    loginError.classList.remove('hidden');
                    sessionStorage.removeItem('loginError');
                }
                // Hentikan semua listener saat logout
                if (unsubscribeOrders) { unsubscribeOrders(); unsubscribeOrders = null; }
                if (unsubscribeCompleted) { unsubscribeCompleted(); unsubscribeCompleted = null; }
                if (unsubscribeMenu) { unsubscribeMenu(); unsubscribeMenu = null; } // <-- Hentikan listener menu
                if (unsubscribeVoided) { unsubscribeVoided(); unsubscribeVoided = null; } // [--- TAMBAHAN BARU ---]
                
                // [--- BARU: Hentikan interval pengingat saat logout ---]
                if (reminderInterval) {
                    clearInterval(reminderInterval);
                    reminderInterval = null;
                }
                // [--- AKHIR BARU ---]
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            loginError.classList.add('hidden');

            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    let message = "Email atau password salah.";
                    loginError.textContent = message;
                    loginError.classList.remove('hidden');
                });
        });

        logoutBtn.addEventListener('click', (e) => { e.preventDefault(); signOut(auth); });

        function setupUIForRole(role) {
            const managerLink = document.querySelector('.nav-link[data-page="manager"]');
            if (role === 'manager') {
                managerLink.classList.remove('hidden');
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('start-date').value = today;
                document.getElementById('end-date').value = today;
            } else {
                managerLink.classList.add('hidden');
                if (document.getElementById('manager-page').classList.contains('active')) {
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.getElementById('cashier-page').classList.add('active');
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    document.querySelector('.nav-link[data-page="cashier"]').classList.add('active');
                }
            }
            // Tab "Kelola Menu" (data-page="menu") akan otomatis terlihat untuk semua role (staff & manager)
            // karena tidak kita sembunyikan secara spesifik.
        }

        // [--- BARU: Fungsi untuk "membuka" audio saat interaksi pertama ---]
        // Browser modern memblokir audio otomatis. Kita perlu "izin" dari klik pertama pengguna.
        function unlockAudio() {
            console.log("Interaksi pengguna terdeteksi, mencoba membuka kunci audio...");
            const sounds = [document.getElementById('new-order-sound'), document.getElementById('reminder-sound')];
            sounds.forEach(sound => {
                if (sound) {
                    // Trik: mainkan lalu langsung jeda. Ini mendaftarkannya sebagai "diizinkan".
                    sound.play().then(() => {
                        sound.pause();
                        sound.currentTime = 0; // Reset audio
                    }).catch(e => {
                        // Tidak masalah jika gagal, akan dicoba lagi nanti
                    });
                }
            });
        }
        // [--- AKHIR FUNGSI BARU ---]

        // [--- BARU: Fungsi untuk cek pesanan yang terlalu lama ---]
        function checkOldOrders() {
            // Hanya jalankan jika di halaman dapur
            if (!document.getElementById('kitchen-page').classList.contains('active')) {
                return;
            }

            const now = Date.now();
            // Atur batas waktu (misal: 5 menit = 300,000 milidetik)
            const REMINDER_THRESHOLD = 5 * 60 * 1000; 
            
            let oldOrderFound = false;

            activeOrders.forEach(order => {
                // Cek hanya yang statusnya 'preparing' dan punya timestamp 'preparingAt'
                if (order.status === 'preparing' && order.preparingAt && order.preparingAt.seconds) {
                    const preparingTime = order.preparingAt.seconds * 1000;
                    
                    if ((now - preparingTime) > REMINDER_THRESHOLD) {
                        oldOrderFound = true;
                        
                        // Temukan elemen kartu pesanan di DOM
                        // Kita cari berdasarkan tombol di dalamnya yang punya data-id unik
                        const orderButton = document.querySelector(`#kitchen-orders .action-btn[data-id="${order.id}"]`);
                        if (orderButton) {
                            const orderCard = orderButton.closest('.order-item');
                            // Tambahkan class 'flashing' jika belum ada
                            if (orderCard && !orderCard.classList.contains('flashing-warning')) {
                                orderCard.classList.add('flashing-warning');
                            }
                        }
                    } else {
                        // Jika pesanan tidak lagi melewati batas (misal baru dikonfirmasi)
                        // Pastikan class warning dihapus
                        const orderButton = document.querySelector(`#kitchen-orders .action-btn[data-id="${order.id}"]`);
                        if (orderButton) {
                            const orderCard = orderButton.closest('.order-item');
                            if (orderCard && orderCard.classList.contains('flashing-warning')) {
                                orderCard.classList.remove('flashing-warning');
                            }
                        }
                    }
                }
            });

            // Jika ditemukan pesanan lama, putar suara pengingat
            if (oldOrderFound) {
                const reminderSound = document.getElementById('reminder-sound');
                if (reminderSound) {
                    reminderSound.play().catch(e => console.warn("Gagal memutar suara pengingat, audio mungkin masih terkunci."));
                }
            }
        }
        // [--- AKHIR FUNGSI BARU ---]


        function initializeAppLogic() {
            // [--- MODIFIKASI: Hapus 'let' karena variabel sudah global ---]
            // activeOrders = []; (Dihapus)
            // completedToday = []; (Dihapus)

            if (!unsubscribeOrders) {
                // [--- MODIFIKASI: Tambah logika deteksi pesanan baru ---]
                unsubscribeOrders = onSnapshot(collection(db, 'orders'), (snapshot) => {
                    
                    let newOrderDetectedOnKitchen = false;
                    
                    // Cek perubahan dokumen satu per satu
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const orderData = change.doc.data();
                            // Cek apakah ini pesanan baru (status pending)
                            // DAN apakah kita sedang di halaman dapur
                            if (orderData.status === 'pending' && document.getElementById('kitchen-page').classList.contains('active')) {
                                newOrderDetectedOnKitchen = true;
                            }
                        }
                    });

                    // Jika ada pesanan baru terdeteksi di dapur, putar suara
                    if (newOrderDetectedOnKitchen) {
                        const newOrderSound = document.getElementById('new-order-sound');
                        if (newOrderSound) {
                            newOrderSound.play().catch(e => console.warn("Gagal memutar notifikasi. Audio mungkin diblokir browser. Diperlukan interaksi pengguna."));
                        }
                    }
                    // [--- AKHIR MODIFIKASI NOTIFIKASI ---]


                    // Logika asli untuk me-render daftar tetap berjalan
                    activeOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderStaffOrders(activeOrders);
                    updateAllDashboards(activeOrders, completedToday);
                });
            }

            if (!unsubscribeCompleted) {
                const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                unsubscribeCompleted = onSnapshot(query(collection(db, "completedOrders"), where("completedAt", ">=", todayStart)), (snapshot) => {
                    completedToday = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateAllDashboards(activeOrders, completedToday);
                });
            }

            // --- LISTENER BARU UNTUK MENU ---
            // PERBAIKAN: Mengganti 'menuItems' ke 'menu' agar sesuai dengan database Anda
            if (!unsubscribeMenu) {
                unsubscribeMenu = onSnapshot(collection(db, 'menu'), (snapshot) => {
                    const menuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMenuManagement(menuItems);
                });
            }
            // --- AKHIR LISTENER BARU ---

            // [--- TAMBAHAN BARU UNTUK VOID LOG ---]
            if (!unsubscribeVoided) {
                const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                const q = query(collection(db, "voidedOrders"), where("voidedAt", ">=", todayStart));
                
                unsubscribeVoided = onSnapshot(q, (snapshot) => {
                    const voidedToday = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sortir berdasarkan yang terbaru
                    voidedToday.sort((a, b) => (b.voidedAt?.seconds || 0) - (a.voidedAt?.seconds || 0));
                    renderVoidedOrders(voidedToday); // Panggil fungsi render baru
                });
            }
            // [--- AKHIR TAMBAHAN ---]

            setupNavigation();
            setupOrderActionListeners();
            setupMenuActionListeners(); // <-- Panggil fungsi listener baru
            setupReportDownloader();
            setupVoidModalListeners(); // [--- TAMBAHAN BARU ---]

            // [--- BARU: Mulai interval pengingat ---]
            // Hapus interval lama jika ada (misal saat login ulang tanpa refresh)
            if (reminderInterval) clearInterval(reminderInterval);
            // Cek pesanan lama setiap 30 detik
            reminderInterval = setInterval(checkOldOrders, 30000); 
            // [--- AKHIR BARU ---]

            // [--- BARU: Tambahkan listener untuk membuka kunci audio ---]
            // { once: true } berarti listener ini akan otomatis dihapus setelah diklik sekali
            document.body.addEventListener('click', unlockAudio, { once: true });
            // [--- AKHIR BARU ---]
        }

        function renderStaffOrders(orders) {
            const cashierContainer = document.getElementById('cashier-orders');
            const kitchenContainer = document.getElementById('kitchen-orders');
            if(!cashierContainer || !kitchenContainer) return;
            const kitchenQueue = orders.filter(o => o.status === 'pending' || o.status === 'preparing');
            
            cashierContainer.innerHTML = orders.length > 0 ? '' : '<p>Belum ada pesanan aktif.</p>';
            orders.forEach(order => cashierContainer.appendChild(createOrderElement(order, 'cashier')));
            kitchenContainer.innerHTML = kitchenQueue.length > 0 ? '' : '<p>Tidak ada antrian di dapur.</p>';
            kitchenQueue.forEach(order => kitchenContainer.appendChild(createOrderElement(order, 'kitchen')));
        }
        
        function createOrderElement(order, type) {
            const div = document.createElement('div');
            div.className = 'order-item';

            // [--- BARU: Cek apakah kartu ini harus berkedip saat render ---]
            // Ini untuk mengatasi jika pengguna pindah tab dan kembali lagi
            const now = Date.now();
            const REMINDER_THRESHOLD = 5 * 60 * 1000; 
            if (order.status === 'preparing' && order.preparingAt && order.preparingAt.seconds) {
                const preparingTime = order.preparingAt.seconds * 1000;
                if ((now - preparingTime) > REMINDER_THRESHOLD) {
                    div.classList.add('flashing-warning');
                }
            }
            // [--- AKHIR BARU ---]


            const statusMap = {
                pending: { text: 'Menunggu', class: 'status-pending' },
                preparing: { text: 'Dimasak', class: 'status-preparing' },
                ready: { text: 'Siap', class: 'status-ready' }
            };
            let buttons = '';
            if (type === 'cashier') {
                if (order.status === 'pending') {
                    buttons = `<button class="action-btn" data-id="${order.id}" data-action="confirm">Konfirmasi</button>`;
                    // [--- TAMBAHAN TOMBOL BATAL ---]
                    buttons += ` <button class="action-btn danger" data-id="${order.id}" data-action="void-request">Batalkan</button>`;
                } else if (order.status === 'ready') {
                    buttons = `<button class="action-btn success" data-id="${order.id}" data-action="complete">Selesaikan</button>`;
                } else if (order.status === 'preparing') {
                    // [--- TAMBAHAN TOMBOL BATAL ---]
                    // Juga izinkan batal saat sedang dimasak (jika pelanggan tiba2 batal)
                    buttons += ` <button class="action-btn danger" data-id="${order.id}" data-action="void-request">Batalkan</button>`;
                }
                
                // [--- TAMBAHAN UNTUK CETAK ---]
                // Selalu tambahkan tombol cetak untuk kasir, terlepas dari statusnya
                buttons += ` <button class="action-btn print" data-id="${order.id}" data-action="print">Cetak</button>`;
                // [--- AKHIR TAMBAHAN ---]

            } else if (type === 'kitchen') {
                if (order.status === 'pending') buttons = `<button class="action-btn" disabled>Tunggu Konfirmasi</button>`;
                // [--- MODIFIKASI: Tambahkan data-id ke tombol Dapur ---]
                // Ini penting agar fungsi checkOldOrders bisa menemukan kartu pesanan
                if (order.status === 'preparing') buttons = `<button class="action-btn success" data-id="${order.id}" data-action="finish">Selesai Masak</button>`;
                // [--- AKHIR MODIFIKASI ---]
            }
            // MODIFIKASI: Tambahkan logika untuk menampilkan varian jika ada
            const items = order.items.map(i => 
                `${i.name}${i.variant ? ` (${i.variant})` : ''} x${i.qty}`
            ).join(', ');
            
            // [--- MODIFIKASI: Tampilkan waktu 'preparing' jika ada ---]
            let timeString = '';
            if (order.preparingAt?.seconds) {
                timeString = ` | <strong>Mulai Masak:</strong> ${new Date(order.preparingAt.seconds * 1000).toLocaleTimeString('id-ID')}`;
            } else if (order.createdAt?.seconds) {
                timeString = ` | <strong>Waktu Pesan:</strong> ${new Date(order.createdAt.seconds * 1000).toLocaleTimeString('id-ID')}`;
            }
            // [--- AKHIR MODIFIKASI ---]


            let detailsHtml;
            // [--- REVISI PAJAK DIHILANGKAN ---]
            // Kita sekarang selalu hanya menampilkan Total, karena subtotal dan pajak sudah di-nol-kan dari aplikasi pelanggan.
            // [--- MODIFIKASI: Masukkan timeString yang baru ---]
            detailsHtml = `<strong>Total:</strong> Rp ${order.total.toLocaleString('id-ID')}${timeString}`;
            // [--- AKHIR REVISI ---]

            div.innerHTML = `
                <div class="order-header">
                    <span class="order-id">Meja ${order.table} - ${order.customer}</span>
                    <span class="order-status ${statusMap[order.status].class}">${statusMap[order.status].text}</span>
                </div>
                <div class="order-details">
                    <strong>Pesanan:</strong> ${items}<br>
                    ${detailsHtml}
                </div>
                <div style="margin-top: 10px;">${buttons}</div>
            `;
            return div;
        }
        
        // --- FUNGSI BARU UNTUK RENDER KELOLA MENU ---
        function renderMenuManagement(menuItems) {
            const container = document.getElementById('menu-management-list');
            if (!container) return;
            
            // Urutkan berdasarkan kategori, lalu nama
            menuItems.sort((a, b) => {
                const categoryA = a.category || 'lainnya';
                const categoryB = b.category || 'lainnya';
                if (categoryA < categoryB) return -1;
                if (categoryA > categoryB) return 1;
                if (a.name < b.name) return -1;
                if (a.name > b.name) return 1;
                return 0;
            });

            container.innerHTML = menuItems.length > 0 ? '' : '<p>Belum ada item menu di database. Hubungi admin untuk menambahkan.</p>';
            
            let currentCategory = "";
            menuItems.forEach(item => {
                const itemCategory = item.category || 'lainnya';
                // Tambahkan header kategori jika berbeda
                if (itemCategory !== currentCategory) {
                    currentCategory = itemCategory;
                    const categoryHeader = document.createElement('h4');
                    categoryHeader.className = 'menu-category-header';
                    categoryHeader.textContent = currentCategory.charAt(0).toUpperCase() + currentCategory.slice(1);
                    container.appendChild(categoryHeader);
                }

                const div = document.createElement('div');
                div.className = 'menu-item-manage';
                
                // Cek status ketersediaan. Default 'true' (tersedia) jika field-nya tidak ada
                const isAvailable = item.isAvailable !== false; 
                const availabilityClass = isAvailable ? 'available' : 'unavailable';
                const availabilityText = isAvailable ? 'Tersedia' : 'Habis';

                div.innerHTML = `
                    <div class="menu-item-info">
                        ${item.name}
                        <span>Rp ${item.price.toLocaleString('id-ID')}</span>
                    </div>
                    <button class="toggle-btn ${availabilityClass}" 
                            data-id="${item.id}" 
                            data-action="toggle-availability" 
                            data-current-status="${isAvailable}"
                            data-name="${item.name}">
                        ${availabilityText}
                    </button>
                `;
                container.appendChild(div);
            });
        }
        
        // [--- FUNGSI BARU UNTUK RENDER VOID LOG ---]
        function renderVoidedOrders(orders) {
            const container = document.getElementById('voided-orders-list');
            if (!container) return; // Jangan lakukan apa-apa jika elemen tidak ada

            if (orders.length === 0) {
                container.innerHTML = '<p>Belum ada pesanan yang dibatalkan hari ini.</p>';
                return;
            }

            container.innerHTML = ''; // Kosongkan daftar
            orders.forEach(order => {
                const div = document.createElement('div');
                div.className = 'order-item voided'; // Pakai style .order-item + .voided
                
                const items = order.items.map(i => 
                    `${i.name}${i.variant ? ` (${i.variant})` : ''} x${i.qty}`
                ).join(', ');

                const voidTime = order.voidedAt?.seconds ? new Date(order.voidedAt.seconds * 1000).toLocaleTimeString('id-ID') : '...';
                const orderTime = order.createdAt?.seconds ? new Date(order.createdAt.seconds * 1000).toLocaleTimeString('id-ID') : '...';

                div.innerHTML = `
                    <div class="order-header">
                        <span class="order-id">Meja ${order.table} - ${order.customer}</span>
                        <span class="order-status status-pending">DIBATALKAN</span>
                    </div>
                    <div class="order-details">
                        <strong>Pesanan Asli:</strong> ${items}<br>
                        <strong>Total Asli:</strong> Rp ${order.total.toLocaleString('id-ID')}<br>
                        <strong>Waktu Pesan:</strong> ${orderTime} | <strong>Waktu Batal:</strong> ${voidTime}
                    </div>
                    <div class="void-reason">
                        <strong>Alasan Batal:</strong> ${order.voidReason || 'Tidak ada alasan'}<br>
                        <small>Dibatalkan oleh: ${order.voidedBy || 'Tidak diketahui'}</small>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        // [--- AKHIR FUNGSI BARU ---]
        
        // [--- TAMBAHAN FUNGSI YANG HILANG ---]
        function updateAllDashboards(activeOrders, completedOrders) {
            const totalSales = completedOrders.reduce((sum, order) => sum + order.total, 0);
            const updateElementText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            };
            
            updateElementText('total-orders', activeOrders.length);
            updateElementText('pending-orders', activeOrders.filter(o => o.status === 'pending').length);
            updateElementText('cooking-orders', activeOrders.filter(o => o.status === 'preparing').length);
            updateElementText('ready-orders', activeOrders.filter(o => o.status === 'ready').length);
            updateElementText('daily-revenue', `Rp ${totalSales.toLocaleString('id-ID')}`);
            updateElementText('completed-orders-kitchen', completedOrders.length);
            updateElementText('manager-total-sales', `Rp ${totalSales.toLocaleString('id-ID')}`);
            updateElementText('manager-total-orders', completedOrders.length);
            const avgOrder = completedOrders.length > 0 ? Math.round(totalSales / completedOrders.length) : 0;
            updateElementText('manager-avg-order', `Rp ${avgOrder.toLocaleString('id-ID')}`);
            updateBestSelling(completedOrders);
        }
        
        function updateBestSelling(completedOrders) {
             const container = document.getElementById('best-selling-list');
             if(!container) return;
            if (completedOrders.length === 0) {
                container.innerHTML = '<p>Belum ada data penjualan hari ini.</p>';
                return;
            }
            const sales = {};
            completedOrders.forEach(order => {
                order.items.forEach(item => {
                    // MODIFIKASI: Gunakan nama + varian sebagai kunci unik
                    const itemName = `${item.name}${item.variant ? ` (${item.variant})` : ''}`;
                    if (!sales[itemName]) sales[itemName] = { qty: 0, revenue: 0 };
                    sales[itemName].qty += item.qty;
                    sales[itemName].revenue += (item.price * item.qty);
                });
            });
            const sorted = Object.entries(sales).sort(([,a],[,b]) => b.qty - a.qty).slice(0, 3);
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            container.innerHTML = sorted.map(([name, data], i) => `
                <div class="order-item">
                    <div class="order-header"><span class="order-id">${medals[i]} ${name}</span><span class="order-status status-ready">${data.qty} porsi</span></div>
                    <div class="order-details">Pendapatan (sblm pajak): Rp ${data.revenue.toLocaleString('id-ID')}</div>
                </div>
            `).join('');
        }
        // [--- AKHIR TAMBAHAN ---]
        
        function setupOrderActionListeners() {
            if (document.body.dataset.actionListenerAttached) return;
            document.body.dataset.actionListenerAttached = 'true';

            document.body.addEventListener('click', async function(e) {
                const actionBtn = e.target.closest('.action-btn[data-action]');
                if (!actionBtn) return;

                const orderId = actionBtn.dataset.id;
                const action = actionBtn.dataset.action;
                const orderRef = doc(db, 'orders', orderId);
                try {
                    // [--- MODIFIKASI: Tambahkan timestamp saat konfirmasi ---]
                    if (action === 'confirm') {
                        await updateDoc(orderRef, { 
                            status: 'preparing',
                            preparingAt: serverTimestamp() // <-- TAMBAHAN INI
                        });
                    }
                    // [--- AKHIR MODIFIKASI ---]
                    else if (action === 'finish') await updateDoc(orderRef, { status: 'ready' });
                    else if (action === 'complete') {
                        const orderDoc = await getDoc(orderRef);
                        if (orderDoc.exists()){
                            const orderData = orderDoc.data();
                            await addDoc(collection(db, 'completedOrders'), { ...orderData, completedAt: serverTimestamp() });
                            await deleteDoc(orderRef);
                            showNotification('Pesanan selesai.');
                        }
                    // [--- TAMBAHAN LOGIKA UNTUK MODAL BATAL ---]
                    } else if (action === 'void-request') {
                        // Tampilkan modal dan simpan ID pesanan
                        orderToVoidId = orderId;
                        voidReasonInput.value = ''; // Kosongkan alasan
                        confirmVoidBtn.disabled = true; // Matikan tombol submit
                        voidModal.classList.remove('hidden');
                        voidReasonInput.focus();
                    // [--- AKHIR TAMBAHAN MODAL ---]

                    // [--- TAMBAHAN UNTUK CETAK ---]
                    } else if (action === 'print') {
                        // Saat tombol cetak diklik, ambil data terbaru dari pesanan itu
                        const orderToPrintDoc = await getDoc(orderRef);
                        if (orderToPrintDoc.exists()) {
                            const orderData = { id: orderToPrintDoc.id, ...orderToPrintDoc.data() };
                            // Panggil fungsi cetak baru
                            printReceipt(orderData);
                        } else {
                            // Cek juga di completedOrders, siapa tahu sudah selesai tapi mau dicetak ulang
                            // PERBAIKAN: Logika ini mungkin tidak akan berjalan karena tombol hilang setelah order selesai.
                            // Tapi kita biarkan sebagai fallback jika Anda mengubah alur render.
                            const completedOrderRef = doc(db, 'completedOrders', orderId);
                            const completedOrderDoc = await getDoc(completedOrderRef);
                            if (completedOrderDoc.exists()) {
                                const orderData = { id: completedOrderDoc.id, ...completedOrderDoc.data() };
                                printReceipt(orderData);
                            } else {
                                showNotification("Data pesanan tidak ditemukan.", true);
                            }
                        }
                    }
                    // [--- AKHIR TAMBAHAN ---]
                } catch (error) { console.error(error); showNotification('Gagal memproses aksi!', true); }
            });
        }


        // [--- FUNGSI BARU UNTUK MODAL PEMBATALAN ---]
        function setupVoidModalListeners() {
            // Aktifkan tombol submit HANYA jika ada alasan
            voidReasonInput.addEventListener('input', () => {
                confirmVoidBtn.disabled = !voidReasonInput.value.trim();
            });

            // Tombol "Tutup"
            cancelVoidBtn.addEventListener('click', () => {
                voidModal.classList.add('hidden');
                orderToVoidId = null;
            });

            // Tombol "Konfirmasi Batal" (Submit form)
            voidForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!orderToVoidId || !voidReasonInput.value.trim()) return;

                const reason = voidReasonInput.value.trim();
                const cashierEmail = auth.currentUser ? auth.currentUser.email : 'unknown@staff';
                const orderRef = doc(db, 'orders', orderToVoidId);

                confirmVoidBtn.disabled = true;
                confirmVoidBtn.textContent = 'Memproses...';

                try {
                    const orderDoc = await getDoc(orderRef);
                    if (orderDoc.exists()) {
                        const orderData = orderDoc.data();
                        
                        // 1. Simpan ke koleksi 'voidedOrders' (log untuk manajer)
                        await addDoc(collection(db, 'voidedOrders'), {
                            ...orderData,
                            voidedAt: serverTimestamp(),
                            voidedBy: cashierEmail,
                            voidReason: reason,
                            originalOrderId: orderToVoidId
                        });

                        // 2. Hapus dari koleksi 'orders' (menghilangkan dari antrian)
                        await deleteDoc(orderRef);

                        showNotification('Pesanan berhasil dibatalkan.');
                        voidModal.classList.add('hidden');
                        orderToVoidId = null;
                    } else {
                        showNotification('Pesanan tidak lagi ditemukan.', true);
                    }
                } catch (error) {
                    console.error("Error voiding order: ", error);
                    showNotification('Gagal membatalkan pesanan.', true);
                } finally {
                    confirmVoidBtn.disabled = false;
                    confirmVoidBtn.textContent = 'Konfirmasi Batal';
                }
            });
        }
        // [--- AKHIR FUNGSI BARU ---]


        // [--- FUNGSI BARU UNTUK MEMBUAT STRUK DAN MENCETAK ---]

        // [--- PERUBAHAN UNTUK RAWBT V2 ---]
        // Kita HAPUS fungsi toBase64(str) karena tidak diperlukan lagi.

        // [--- FUNGSI DIPERBARUI ---]
        function printReceipt(order) {
            // Helper function untuk padding teks agar rata kanan/kiri
            // 32 karakter adalah lebar standar untuk kertas thermal 58mm
            const receiptWidth = 32; 
            const pad = (str, len, char = ' ') => String(str).padEnd(len, char);
            const padLeft = (str, len, char = ' ') => String(str).padStart(len, char);
            
            let receiptText = '';

            // --- Header Struk (BARU) ---
            // (14 char) -> (32-14)/2 = 9 spasi
            receiptText += "         PAY BOSS CAFE\n";
            // (30 char) -> (32-30)/2 = 1 spasi
            receiptText += " Jl. Tanjung Permai No 2 RT 07\n";
            // (23 char) -> (32-23)/2 = 4.5 -> 4 spasi
            receiptText += "    Pembataan.Murung Pudak.\n";
            // (8 char) -> (32-8)/2 = 12 spasi
            receiptText += "            Tabalong\n";
            // (24 char) -> (32-24)/2 = 4 spasi
            receiptText += "    Reservasi: 0811-5194-456\n";
            receiptText += "--------------------------------\n";
            
            // --- Info Pesanan (Lama) ---
            // Ini kita biarkan rata kiri
            receiptText += `Meja: ${order.table}\n`;
            receiptText += `Pelanggan: ${order.customer}\n`;
            
            // Tentukan waktu cetak (jika sudah selesai, pakai completedAt, jika belum, pakai createdAt)
            const orderTime = order.completedAt?.seconds ? order.completedAt.seconds : (order.createdAt?.seconds || Date.now() / 1000);
            const time = new Date(orderTime * 1000);
            receiptText += `Waktu: ${time.toLocaleDateString('id-ID')} ${time.toLocaleTimeString('id-ID')}\n`;
            receiptText += "--------------------------------\n";

            // --- Daftar Item (Lama) ---
            order.items.forEach(item => {
                // Baris 1: Nama Item (bisa 2 baris jika panjang)
                let itemName = `${item.qty}x ${item.name}${item.variant ? ` (${item.variant})` : ''}`;
                
                // Potong nama item jika terlalu panjang
                if (itemName.length > receiptWidth) {
                    receiptText += pad(itemName.substring(0, receiptWidth), receiptWidth) + "\n";
                    receiptText += pad("  " + itemName.substring(receiptWidth), receiptWidth) + "\n";
                } else {
                    receiptText += pad(itemName, receiptWidth) + "\n";
                }
                
                // Baris 2: Harga (rata kanan)
                const itemTotal = item.price * item.qty;
                receiptText += padLeft(`Rp ${itemTotal.toLocaleString('id-ID')}`, receiptWidth) + "\n";
            });
            receiptText += "--------------------------------\n";

            // --- Bagian Total (Lama, sudah benar) ---
            // (18 karakter untuk label, 14 untuk nilai)
            receiptText += pad("GRAND TOTAL", 18) + padLeft(`Rp ${order.total.toLocaleString('id-ID')}`, 14) + "\n";
            receiptText += "--------------------------------\n";

            // --- Footer Struk (BARU) ---
            // (20 char) -> (32-20)/2 = 6 spasi
            receiptText += "      Wifi : Pay Boss Cafe\n";
            // (21 char) -> (32-21)/2 = 5.5 -> 5 spasi
            receiptText += "     Pasword : P4yB0sSC4F3\n";
            receiptText += "--------------------------------\n";
            // (31 char) -> (32-31)/2 = 0.5 -> 0 spasi, sudah pas
            receiptText += "Terimakasih atas kunjungan anda.\n";
            // (24 char) -> (32-24)/2 = 4 spasi
            receiptText += "    Instagram: Payboss.cafe\n";
            receiptText += "\n\n\n"; // Feed paper

            // --- Logika untuk Mencetak via RawBT (Lama, tidak diubah) ---
            
            // Kita URI-encode teks struk mentah. 
            // Ini akan mengubah spasi menjadi %20, baris baru menjadi %0A, dll.
            const encodedReceiptText = encodeURIComponent(receiptText);

            // Ini adalah "intent" URL yang akan ditangkap oleh aplikasi RawBT
            // Kita kirim teks yang sudah di-encode sebagai "path" URL.
            const rawBtUrl = `rawbt:${encodedReceiptText}`;

            // Coba buka di tab baru (atau jendela). 
            // Di Android, ini akan dicegat oleh RawBT dan memicu cetak.
            const printWindow = window.open(rawBtUrl, '_blank');
            
            if (!printWindow) {
                // Jika popup diblokir, beri tahu pengguna
                showNotification("Gagal membuka RawBT. Izinkan popup untuk aplikasi ini.", true);
                
                // Sebagai alternatif, coba redirect halaman utama (meskipun ini kurang ideal)
                // window.location.href = rawBtUrl;
            }
        }
        // [--- AKHIR FUNGSI BARU & PERUBAHAN RAWBT V2 ---]

        // --- LISTENER BARU UNTUK TOMBOL TOGGLE MENU ---
        function setupMenuActionListeners() {
            // Cek agar listener tidak terpasang dua kali
            if (document.body.dataset.menuActionListenerAttached) return;
            document.body.dataset.menuActionListenerAttached = 'true';

            document.body.addEventListener('click', async function(e) {
                // Cari tombol toggle yang diklik
                const toggleBtn = e.target.closest('.toggle-btn[data-action="toggle-availability"]');
                if (!toggleBtn) return;

                const itemId = toggleBtn.dataset.id;
                const itemName = toggleBtn.dataset.name;
                // Ambil status saat ini (string 'true'/'false') dan ubah jadi boolean
                const currentStatus = toggleBtn.dataset.currentStatus === 'true';
                const newStatus = !currentStatus; // Balikkan statusnya

                // PERBAIKAN: Mengganti 'menuItems' ke 'menu' agar sesuai dengan database Anda
                const itemRef = doc(db, 'menu', itemId);
                
                // Matikan tombol sementara proses
                toggleBtn.disabled = true;
                toggleBtn.textContent = 'Menyimpan...';

                try {
                    // Update field 'isAvailable' di Firestore
                    await updateDoc(itemRef, { isAvailable: newStatus });
                    
                    // onSnapshot akan otomatis memperbarui tampilan tombol
                    showNotification(`Status ${itemName} diubah ke ${newStatus ? 'Tersedia' : 'Habis'}.`);
                } catch (error) {
                    console.error("Gagal update status menu:", error);
                    showNotification("Gagal mengubah status.", true);
                    // Jika gagal, kembalikan tombol ke status semula
                    toggleBtn.disabled = false;
                    toggleBtn.textContent = currentStatus ? 'Tersedia' : 'Habis';
                }
            });
        }
        // --- AKHIR LISTENER BARU ---
        
        function setupNavigation() {
             if (document.body.dataset.navListenerAttached) return;
             document.body.dataset.navListenerAttached = 'true';
             const navLinks = document.querySelectorAll('.nav-link');
             const pages = document.querySelectorAll('.page');
             navLinks.forEach(link => {
                 link.addEventListener('click', function(e) {
                     e.preventDefault();
                     const target = this.dataset.page;
                     navLinks.forEach(l => l.classList.remove('active'));
                     this.classList.add('active');
                     pages.forEach(p => p.classList.remove('active'));
                     document.getElementById(`${target}-page`).classList.add('active');
                 });
             });
        }

        function showNotification(message, isError = false) {
            const el = document.createElement('div');
            el.className = 'notification'; el.textContent = message;
            if (isError) el.style.backgroundColor = '#A52A2A';
            document.body.appendChild(el);
            setTimeout(() => el.classList.add('show'), 10);
            setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 500); }, 3000);
        }
        
        function setupReportDownloader() {
            const downloadBtn = document.getElementById('download-report-btn');
            if (!downloadBtn || downloadBtn.dataset.listenerAttached) return;
            downloadBtn.dataset.listenerAttached = 'true';

            downloadBtn.addEventListener('click', async () => {
                const startDateEl = document.getElementById('start-date');
                const endDateEl = document.getElementById('end-date');

                if (!startDateEl.value || !endDateEl.value) {
                    showNotification("Silakan pilih rentang tanggal terlebih dahulu.", true);
                    return;
                }
                
                downloadBtn.textContent = "Memproses...";
                downloadBtn.disabled = true;

                try {
                    const start = new Date(startDateEl.value);
                    start.setHours(0, 0, 0, 0);
                    const end = new Date(endDateEl.value);
                    end.setHours(23, 59, 59, 999);

                    const q = query(
                        collection(db, "completedOrders"),
                        where("completedAt", ">=", Timestamp.fromDate(start)),
                        where("completedAt", "<=", Timestamp.fromDate(end))
                    );

                    const querySnapshot = await getDocs(q);
                    const reportData = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                    if (reportData.length === 0) {
                        showNotification("Tidak ada data penjualan pada periode ini.", true);
                        return;
                    }
                    
                    // [--- REVISI PAJAK DIHILANGKAN ---]
                    const headers = ["ID Pesanan", "Tanggal Selesai", "Waktu Selesai", "Nama Pelanggan", "No. Meja", "Item Dipesan", "Total", "Metode Bayar"];
                    // [--- AKHIR REVISI ---]
                    const csvRows = [headers.join(',')];
                    
                    reportData.sort((a, b) => a.completedAt.seconds - b.completedAt.seconds);

                    for (const order of reportData) {
                        const date = new Date(order.completedAt.seconds * 1000);
                        // Perbaikan: Ambil ID dari 'order.id' yang kita map sebelumnya
                        const orderId = order.id.substring(0, 6); 
                        const formattedDate = date.toLocaleDateString('id-ID', { year: 'numeric', month: '2-digit', day: '2-digit' });
                        const formattedTime = date.toLocaleTimeString('id-ID');
                        const customer = `"${order.customer}"`;
                        const table = order.table;
                        // MODIFIKASI: Tambahkan varian ke dalam laporan CSV
                        const items = `"${order.items.map(i => 
                            `${i.name}${i.variant ? ` (${i.variant})` : ''} x${i.qty}`
                        ).join('; ')}"`;
                        // [--- REVISI PAJAK DIHILANGKAN ---]
                        const grandTotal = order.total;
                        const payment = `"${order.paymentMethod}"`;
                        csvRows.push([orderId, formattedDate, formattedTime, customer, table, items, grandTotal, payment].join(','));
                        // [--- AKHIR REVISI ---]
                    }

                    const csvContent = csvRows.join('\n');
                    const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    const fileName = `Laporan_Payboss_${startDateEl.value}_sampai_${endDateEl.value}.csv`;
                    link.setAttribute("download", fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification("Laporan berhasil di-download.");

                } catch (error) {
                    console.error("Error downloading report:", error);
                    showNotification("Gagal men-download laporan.", true);
                } finally {
                    downloadBtn.textContent = "Download Laporan (Excel)";
                    downloadBtn.disabled = false;
                }
            });
        }

    </script>
</body>
</html>
